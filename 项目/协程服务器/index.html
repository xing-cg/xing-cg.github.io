<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="内容         项目需求及目标 开发环境 Json介绍 muduo网络库编程 服务器集群 基于发布-订阅的Redis——服务器中间件 数据库设计  本项目要用到的技术栈：  Json序列化和反序列化； muduo网络库开发； nginx源码编译安装和环境部署； nginx的tcp负载均衡器配置； redis缓存服务器编程实践； 基于发布-订阅的服务器">
<meta property="og:type" content="article">
<meta property="og:title" content="协程服务器">
<meta property="og:url" content="https://xing-cg.github.io/%E9%A1%B9%E7%9B%AE/%E5%8D%8F%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/index.html">
<meta property="og:site_name" content="罐头先生的博客">
<meta property="og:description" content="内容         项目需求及目标 开发环境 Json介绍 muduo网络库编程 服务器集群 基于发布-订阅的Redis——服务器中间件 数据库设计  本项目要用到的技术栈：  Json序列化和反序列化； muduo网络库开发； nginx源码编译安装和环境部署； nginx的tcp负载均衡器配置； redis缓存服务器编程实践； 基于发布-订阅的服务器">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xing-cg.github.io/images/%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20220413164124873.png">
<meta property="article:published_time" content="2023-06-01T00:00:00.000Z">
<meta property="article:modified_time" content="2025-07-30T15:56:00.821Z">
<meta property="article:author" content="Mr.Can">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xing-cg.github.io/images/%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20220413164124873.png"><title>协程服务器 | 罐头先生的博客</title><link ref="canonical" href="https://xing-cg.github.io/%E9%A1%B9%E7%9B%AE/%E5%8D%8F%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">罐头先生的博客</div><div class="header-banner-info__subtitle">Mr.Can</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">协程服务器</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-06-01</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2025-07-30</span></span><span class="post-meta-item post-meta-item--visitors leancloud_visitors" id="/%E9%A1%B9%E7%9B%AE/%E5%8D%8F%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/" data-flag-title="协程服务器"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value leancloud-visitors-count"></span></span></div></header><div class="post-body">
        <h1 id="内容"   >
          <a href="#内容" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#内容"></a> 内容</h1>
      
<ol>
<li>项目需求及目标</li>
<li>开发环境</li>
<li><code>Json</code>介绍</li>
<li><code>muduo</code>网络库编程</li>
<li>服务器集群</li>
<li>基于<code>发布-订阅</code>的<code>Redis</code>——服务器中间件</li>
<li>数据库设计</li>
</ol>
<p>本项目要用到的技术栈：</p>
<ol>
<li><code>Json</code>序列化和反序列化；</li>
<li><code>muduo</code>网络库开发；</li>
<li><code>nginx</code>源码编译安装和环境部署；</li>
<li><code>nginx</code>的<code>tcp</code>负载均衡器配置；</li>
<li><code>redis</code>缓存服务器编程实践；</li>
<li>基于<code>发布-订阅</code>的服务器中间件<code>redis</code>消息队列编程实践；</li>
<li><code>MySQL</code>数据库编程；</li>
<li><code>CMake</code>构建编译环境；</li>
<li><code>Github</code>托管项目</li>
</ol>
<p>本项目的内容包含了：通常开发的服务器，网络、业务、数据模块（数据库、数据的操作），项目中要把三大模块区分开，项目初期时以登录模块为主线，分三大块推进。</p>

        <h1 id="项目需求及目标"   >
          <a href="#项目需求及目标" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#项目需求及目标"></a> 项目需求及目标</h1>
      
<ul>
<li>
<p>项目需求</p>
<ol>
<li>客户端新用户注册</li>
<li>客户端用户登录</li>
<li>添加好友和添加群组</li>
<li>好友聊天和群组聊天</li>
<li><code>nginx</code>配置<code>tcp</code>负载均衡</li>
<li>集群聊天系统支持客户端跨服务器通信</li>
</ol>
</li>
<li>
<p>项目目标</p>
<ol>
<li>掌握服务器的网络<code>I/O</code>模块，业务模块，数据模块分层的设计思想</li>
<li>掌握<code>C++</code> <code>muduo</code>网络库的编程以及实现原理</li>
<li>掌握<code>Json</code>的编程应用</li>
<li>掌握<code>nginx</code>配置部署<code>tcp</code>负载均衡器的原理及应用</li>
<li>掌握服务器中间件的应用场景和基于<code>发布-订阅</code>的<code>redis</code>编程实践以及应用原理</li>
<li>掌握<code>CMake</code>构建自动化编程环境</li>
</ol>
</li>
</ul>

        <h1 id="开发环境"   >
          <a href="#开发环境" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#开发环境"></a> 开发环境</h1>
      
<p>具体配置略，翻阅其他文章。</p>

        <h2 id="工程目录"   >
          <a href="#工程目录" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#工程目录"></a> 工程目录</h2>
      
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">include目录是头文件放的位置。</span><br><span class="line">server和client的代码在同一工程中，最后生成时可以把C/S分开生成到bin目录下。</span><br><span class="line">可按server和client分类，比如生成代码所需用到的头文件可以分别放在/include/server和/include/client，而server和client共需的头文件直接放到/include下。比如消息的id。</span><br><span class="line">src放源码。</span><br><span class="line">thirdparty是第三方库文件夹，比如放json.hpp。</span><br><span class="line">本项目没有生成lib库(.a/.so)，所以没有lib文件夹。</span><br></pre></td></tr></table></div></figure>

        <h2 id="cmakeliststxt编写"   >
          <a href="#cmakeliststxt编写" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#cmakeliststxt编写"></a> CMakeLists.txt编写</h2>
      
<ul>
<li>
<p>根目录</p>
<figure class="highlight cmake"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.0</span>.<span class="number">0</span>)</span><br><span class="line"><span class="keyword">project</span>(chat)</span><br><span class="line"><span class="comment"># 配置编译选项</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -g)</span><br><span class="line"><span class="comment"># 配置最终的可执行文件输出的路径</span></span><br><span class="line"><span class="keyword">set</span>(EXECUTABLE_OUTPUT_PATH <span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/bin)</span><br><span class="line"><span class="comment"># 配置头文件的搜索路径</span></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/<span class="keyword">include</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/<span class="keyword">include</span>/server)</span><br><span class="line"><span class="comment"># 加载子目录</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p><code>/src</code></p>
<figure class="highlight cmake"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_subdirectory</span>(server)</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p><code>/src/server</code></p>
<figure class="highlight cmake"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义了一个SRC_LIST变量，包含了该目录下所有的源文件</span></span><br><span class="line"><span class="keyword">aux_source_directory</span>(. SRC_LIST)</span><br><span class="line"><span class="comment"># 指定生成可执行文件</span></span><br><span class="line"><span class="keyword">add_executable</span>(ChatServer <span class="variable">$&#123;SRC_LIST&#125;</span>)</span><br><span class="line"><span class="comment"># 指定可执行文件链接时 需要依赖的库文件</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(CharServer muduo_net muduo_base pthread)</span><br></pre></td></tr></table></div></figure>
</li>
</ul>

        <h1 id="json介绍"   >
          <a href="#json介绍" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#json介绍"></a> Json介绍</h1>
      
<p>Json是一种轻量级的数据交换格式（也叫数据序列化方式）。Json采用完全<strong>独立于编程语言</strong>的文本格式<br />
来存储和表示数据。简洁和清晰的层次结构使得 Json成为理想的数据交换语言。 易于人阅读和编写，同时也易于机器解析和生成，并有效地提升网络传输效率。</p>
<p>Json的用处就是下图：</p>
<p><img src="../../images/%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20220413164124873.png" alt="image-20220413164124873" /></p>
<ul>
<li>Json第三方库</li>
</ul>
<p>本项目选用的是<code>JSON for Modern C++</code>，由德国人<code>nlohmann</code>编写的在<code>C++</code>下使用的<code>JSON</code>库。特点如下:</p>
<ol>
<li>整个代码由一个头文件<code>json.hpp</code>包含，没有依赖关系，使用方便；</li>
<li>使用C++11标准编写；</li>
<li>使得json像STL容器一样，而且STL和json容器之间可以相互转换；</li>
<li>所有类都经过严格的单元测试，覆盖100％的代码，包括所有特殊的行为。此外，还检查了Valgrind是否有内存泄漏。为了保持高质量，该项目遵循“核心基础设施”倡议的最佳实践。</li>
</ol>
<ul>
<li>测试json</li>
</ul>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">/* json序列化 示例1 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msg_type&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">    js[<span class="string">&quot;from&quot;</span>] = <span class="string">&quot;zhang san&quot;</span>;</span><br><span class="line">    js[<span class="string">&quot;to&quot;</span>] = <span class="string">&quot;li si&quot;</span>;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>] = <span class="string">&quot;hello, i&#x27;m zhang san&quot;</span>;</span><br><span class="line">    cout &lt;&lt; js &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">func1</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 输出结果</span></span><br><span class="line"><span class="comment"> * &#123;&quot;from&quot;:&quot;zhang san&quot;,&quot;msg&quot;:&quot;hello, i&#x27;m zhang san&quot;,&quot;msg_type&quot;:2,&quot;to&quot;:&quot;li si&quot;&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></div></figure>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* json序列化 实例2 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	json js;</span><br><span class="line">    js[<span class="string">&quot;id&quot;</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">    js[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;zhang san&quot;</span>;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>][<span class="string">&quot;zhang san&quot;</span>] = <span class="string">&quot;i&#x27;m zhang san&quot;</span>;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>][<span class="string">&quot;li si&quot;</span>] = <span class="string">&quot;i&#x27;m li si&quot;</span>;</span><br><span class="line">    <span class="comment">/* 上面两句等同于下面这句一次性添加数组对象 */</span></span><br><span class="line"><span class="comment">/*  js[&quot;msg&quot;] = &#123;&#123;&quot;zhang san&quot;, &quot;i&#x27;m zhang san&quot;&#125;, &#123;&quot;li si&quot;, &quot;i&#x27;m li si&quot;&#125;&#125;; */</span></span><br><span class="line">	cout &lt;&lt; js &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">func2</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 输出结果</span></span><br><span class="line"><span class="comment"> * &#123;&quot;id&quot;:[1,2,3,4,5],&quot;msg&quot;:&#123;&quot;li si&quot;:&quot;i&#x27;m li si&quot;,&quot;zhang san&quot;:&quot;i&#x27;m zhang san&quot;&#125;,&quot;name&quot;:&quot;zhang san&quot;&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></div></figure>
<p>这个json库强大到直接把<code>C++</code> <code>STL</code>中的容器内容可以直接序列化成Json字符串，代码如下：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* json序列化 实例3 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    json js;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; vec;</span><br><span class="line">    vec.<span class="built_in">push_back</span>(<span class="number">1</span>);</span><br><span class="line">    vec.<span class="built_in">push_back</span>(<span class="number">2</span>);</span><br><span class="line">    vec.<span class="built_in">push_back</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="comment">// 直接序列化一个vector容器</span></span><br><span class="line">    js[<span class="string">&quot;list&quot;</span>] = vec;</span><br><span class="line">    map&lt;<span class="type">int</span>, string&gt; m;</span><br><span class="line">    m.<span class="built_in">insert</span>(&#123;<span class="number">1</span>, <span class="string">&quot;黄山&quot;</span>&#125;);</span><br><span class="line">    m.<span class="built_in">insert</span>(&#123;<span class="number">2</span>, <span class="string">&quot;华山&quot;</span>&#125;);</span><br><span class="line">    m.<span class="built_in">insert</span>(&#123;<span class="number">3</span>, <span class="string">&quot;泰山&quot;</span>&#125;);</span><br><span class="line">    <span class="comment">// 直接序列化一个map容器</span></span><br><span class="line">    js[<span class="string">&quot;path&quot;</span>] = m;</span><br><span class="line">    cout&lt;&lt;js&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 输出结果</span></span><br><span class="line"><span class="comment"> * &#123;&quot;list&quot;:[1,2,5],&quot;path&quot;:[[1,&quot;黄山&quot;],[2,&quot;华山&quot;],[3,&quot;泰山&quot;]]&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></div></figure>
<ul>
<li>
<p>API</p>
<ul>
<li>
<p><code>dump</code>: <code>cout &lt;&lt;</code>能输出json对象是因为重载了<code>&lt;&lt;</code>运算符；而要实际生成<code>string</code>可用<code>dump()</code>，生成的字符串内容和<code>&lt;&lt; json</code>的一样。传输数据时，不要传<code>string</code>对象，而是要传<code>string</code>实际指向的字符串首指针，<code>c\_str</code>。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    json js;</span><br><span class="line">    js[<span class="string">&quot;msg_type&quot;</span>] = <span class="number">2</span>;</span><br><span class="line">    js[<span class="string">&quot;from&quot;</span>] = <span class="string">&quot;zhang san&quot;</span>;</span><br><span class="line">    js[<span class="string">&quot;to&quot;</span>] = <span class="string">&quot;li si&quot;</span>;</span><br><span class="line">    js[<span class="string">&quot;msg&quot;</span>] = <span class="string">&quot;hello, i&#x27;m zhang san&quot;</span>;</span><br><span class="line">    string sendBuf = js.<span class="built_in">dump</span>();</span><br><span class="line">    cout &lt;&lt; sendBuf.<span class="built_in">c_str</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
</ul>
</li>
</ul>

        <h1 id="网络io模块"   >
          <a href="#网络io模块" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#网络io模块"></a> 网络IO模块</h1>
      

        <h2 id="chatserver"   >
          <a href="#chatserver" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#chatserver"></a> ChatServer</h2>
      

        <h3 id="成员属性"   >
          <a href="#成员属性" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#成员属性"></a> 成员属性</h3>
      
<ol>
<li><code>TcpServer m_server</code> - <strong>基于事件驱动的、IO复用+epoll+线程池</strong>的服务器类，完全<strong>基于Reactor模型</strong></li>
<li><code>EventLoop *m_loop</code> - mainLoop的指针, 保存事件循环. 有了事件循环的指针，可以在合适的时候调用quit退出事件循环；</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* 组合的muduo库，实现服务器功能的类对象 */</span></span><br><span class="line">    TcpServer _server;</span><br><span class="line">    <span class="comment">/* 指向事件循环对象的指针 */</span></span><br><span class="line">    EventLoop *_loop;</span><br></pre></td></tr></table></div></figure>

        <h3 id="成员函数"   >
          <a href="#成员函数" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#成员函数"></a> 成员函数</h3>
      
<ol>
<li>
<p>构造 - 参数为<code>loop</code>指针, <code>listenAddr</code>, <code>name</code>, 用于初始化TcpServer</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 初始化聊天服务器对象 */</span></span><br><span class="line">    <span class="built_in">ChatServer</span>(EventLoop* loop,</span><br><span class="line">               <span class="type">const</span> InetAddress&amp; listenAddr,</span><br><span class="line">               <span class="type">const</span> string&amp; nameArg);</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p><code>start</code> - 启动服务的接口</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p><code>onConnection</code>/<code>onMessage</code> -  连接创建/断开, 读写事件发生的回调函数</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* 上报链接相关信息的回调函数（连接创建，连接断开）*/</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr&amp;)</span></span>;</span><br><span class="line">    <span class="comment">/* 上报读写事件相关信息的回调函数 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr&amp;, Buffer*, Timestamp)</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
</ol>

        <h3 id="代码实现"   >
          <a href="#代码实现" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#代码实现"></a> 代码实现</h3>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/EventLoop.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聊天服务器的主类;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 要注册两个方法:</span></span><br><span class="line"><span class="comment"> * 给TcpServer注册新用户的连接、连接断开的、已连接用户的可读写事件;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatServer</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 初始化聊天服务器对象 */</span></span><br><span class="line">    <span class="built_in">ChatServer</span>(EventLoop* loop,</span><br><span class="line">               <span class="type">const</span> InetAddress&amp; listenAddr,</span><br><span class="line">               <span class="type">const</span> string&amp; nameArg);</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 启动服务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* 上报链接相关信息的回调函数（连接创建，连接断开）*/</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr&amp;)</span></span>;</span><br><span class="line">    <span class="comment">/* 上报读写事件相关信息的回调函数 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr&amp;, Buffer*, Timestamp)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* 组合的muduo库，实现服务器功能的类对象 */</span></span><br><span class="line">    TcpServer _server;</span><br><span class="line">    <span class="comment">/* 指向事件循环对象的指针 */</span></span><br><span class="line">    EventLoop *_loop;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

        <h2 id="reactor模型"   >
          <a href="#reactor模型" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#reactor模型"></a> Reactor模型</h2>
      
<p>本项目基于muduo库，模型是<strong>基于事件驱动的、IO复用+epoll+线程池</strong>的网络，完全<strong>基于Reactor模型</strong>，线程暂时设置为4个，有一个主Reactor是IO线程，主要负责新用户的连接，3个sub-Reactor是工作线程，主要负责已连接用户的读写事件的处理。</p>

        <h1 id="业务模块"   >
          <a href="#业务模块" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#业务模块"></a> 业务模块</h1>
      

        <h2 id="业务模块与网络模块解耦-回调"   >
          <a href="#业务模块与网络模块解耦-回调" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#业务模块与网络模块解耦-回调"></a> 业务模块与网络模块解耦 - 回调</h2>
      
<p>考虑问题：网络模块收到的消息如何派发到业务模块？让网络模块的代码和业务模块的代码解耦。</p>
<p>假设有一个用户在做登录业务，登录业务包含messageID，name，password，要验证用户名密码是否正确。</p>
<p>解耦的方案有两种：</p>
<ol>
<li>使用基于面向接口的编程。（抽象基类）</li>
<li><strong>基于回调函数</strong>的操作。</li>
</ol>

        <h2 id="业务类型"   >
          <a href="#业务类型" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#业务类型"></a> 业务类型</h2>
      
<ol>
<li>登录 - <code>LOGIN_MSG/ACK</code></li>
<li>注册 - <code>REG_MSG/ACK</code></li>
<li>加好友 - <code>ADD_FRIEND_MSG</code></li>
<li>一对一聊天 - <code>ONE_CHAT_MSG</code></li>
<li>创建群组 - <code>CREATE_GROUP_MSG</code></li>
<li>加入群组 - <code>ADD_GROUP_MSG</code></li>
<li>群聊 - <code>GROUP_CHAT_MSG</code></li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PUBLIC_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUBLIC_H</span></span><br><span class="line"><span class="comment">/* server和client的公共文件 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">EnMsgType</span>  <span class="comment">//En表示Enum枚举</span></span><br><span class="line">&#123;</span><br><span class="line">    LOGIN_MSG = <span class="number">1</span>,      <span class="comment">//登录 消息id, 与chatservice中的login方法绑定</span></span><br><span class="line">    LOGIN_MSG_ACK,      <span class="comment">//登录响应</span></span><br><span class="line"></span><br><span class="line">    REG_MSG,            <span class="comment">//注册 消息id, 与chatservice中的reg方法绑定</span></span><br><span class="line">    REG_MSG_ACK,        <span class="comment">//注册响应</span></span><br><span class="line"></span><br><span class="line">    ADD_FRIEND_MSG,     <span class="comment">//添加好友</span></span><br><span class="line">    ONE_CHAT_MSG,       <span class="comment">//一对一聊天</span></span><br><span class="line"></span><br><span class="line">    CREATE_GROUP_MSG,   <span class="comment">//创建群组</span></span><br><span class="line">    ADD_GROUP_MSG,      <span class="comment">//加入群组</span></span><br><span class="line">    GROUP_CHAT_MSG      <span class="comment">//群聊</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">EnLoginErrType</span></span><br><span class="line">&#123;</span><br><span class="line">    LOGIN_SUCCEESS = <span class="number">0</span>,</span><br><span class="line">    LOGIN_REPEAT = <span class="number">1</span>,</span><br><span class="line">    LOGIN_NOTFOUND = <span class="number">2</span>,</span><br><span class="line">    LOGIN_WRONGPWD = <span class="number">3</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

        <h2 id="chatservice"   >
          <a href="#chatservice" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#chatservice"></a> ChatService</h2>
      

        <h3 id="前置处理"   >
          <a href="#前置处理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#前置处理"></a> 前置处理</h3>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 表示处理消息的事件回调方法类型 */</span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = std::function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr&amp;, json&amp;, Timestamp)&gt;;</span><br></pre></td></tr></table></div></figure>

        <h3 id="成员属性-2"   >
          <a href="#成员属性-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#成员属性-2"></a> 成员属性</h3>
      
<ol>
<li>
<p><code>unordered_map&lt;int, MsgHandler&gt; m_msgHandlerMap</code> - 映射消息类型id 和 事件回调函数</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* 存储消息id和其对应的业务处理方法 */</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>, MsgHandler&gt; m_msgHandlerMap;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p><code>unordered_map&lt;int, TcpConnectionPtr&gt; m_userConnectionMap</code> - 存储在线用户的通信连接</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* 存储在线用户的通信连接 */</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>, TcpConnectionPtr&gt; m_userConnectionMap;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p><code>mutex m_connMutex</code> - 定义互斥锁，保证<code>m_userConnectionMap</code>的线程安全</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* 定义互斥锁，保证m_userConnectionMap的线程安全 */</span></span><br><span class="line">    mutex _connMutex;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>数据操作类对象</p>
<ol>
<li>UserModel - <code>m_userModel</code></li>
<li>OfflineMsgModel - <code>m_offlineMsgModel</code></li>
<li>FriendModel - <code>friendModel</code></li>
<li>GroupModel - <code>groupModel</code></li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    UserModel       _userModel;         <span class="comment">/* 数据操作类对象 */</span></span><br><span class="line">    OfflineMsgModel _offlineMsgModel;   <span class="comment">/* 数据操作类对象 */</span></span><br><span class="line">    FriendModel     _friendModel;       <span class="comment">/* 数据操作类对象 */</span></span><br><span class="line">    GroupModel      _groupModel;        <span class="comment">/* 数据操作类对象 */</span></span><br></pre></td></tr></table></div></figure>
</li>
</ol>

        <h3 id="成员函数-2"   >
          <a href="#成员函数-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#成员函数-2"></a> 成员函数</h3>
      
<ol>
<li>
<p>构造函数 - 私有化, 单例处理</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService * <span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>();</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>业务接口</p>
<ol>
<li>login - 登陆业务</li>
<li>reg - 注册业务</li>
<li>addFriend - 添加好友业务</li>
<li>oneChat - 一对一聊天业务</li>
<li>createGroup - 创建群组业务</li>
<li>addGroup - 加入群组业务</li>
<li>groupChat - 群组聊天业务</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 处理登录业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    <span class="comment">/* 处理注册业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 添加好友业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addFriend</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    <span class="comment">/* 一对一聊天业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 创建群组业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">createGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    <span class="comment">/* 加入群组业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    <span class="comment">/* 群组聊天业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">groupChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>getHandler - 获取消息对应的处理器</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 获取消息对应的处理器 */</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>clientCloseException - 处理客户端异常退出</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 处理客户端异常退出 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp; conn)</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>reset - 业务重置方法，通常在服务器异常退出时调用</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 业务重置方法，通常在服务器异常退出时调用 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
</ol>

        <h3 id="代码实现-2"   >
          <a href="#代码实现-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#代码实现-2"></a> 代码实现</h3>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;offlinemsgmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;friendmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;groupmodel.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 表示处理消息的事件回调方法类型 */</span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = std::function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr&amp;, json&amp;, Timestamp)&gt;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聊天服务器业务类. </span></span><br><span class="line"><span class="comment"> * 用映射关系来存储消息id和具体处理函数. </span></span><br><span class="line"><span class="comment"> * 此类有一个实例就够了，所以采用单例模式. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 获取单例对象的接口函数 */</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService* <span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 处理登录业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    <span class="comment">/* 处理注册业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 添加好友业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addFriend</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    <span class="comment">/* 一对一聊天业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 创建群组业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">createGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    <span class="comment">/* 加入群组业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    <span class="comment">/* 群组聊天业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">groupChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 获取消息对应的处理器 */</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 处理客户端异常退出 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp; conn)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 业务重置方法，通常在服务器异常退出时调用 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>();</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    UserModel       _userModel;         <span class="comment">/* 数据操作类对象 */</span></span><br><span class="line">    OfflineMsgModel _offlineMsgModel;   <span class="comment">/* 数据操作类对象 */</span></span><br><span class="line">    FriendModel     _friendModel;       <span class="comment">/* 数据操作类对象 */</span></span><br><span class="line">    GroupModel      _groupModel;        <span class="comment">/* 数据操作类对象 */</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* 定义互斥锁，保证m_userConnectionMap的线程安全 */</span></span><br><span class="line">    mutex _connMutex;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* 存储消息id和其对应的业务处理方法 */</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>, MsgHandler&gt; _msgHandlerMap;</span><br><span class="line">    <span class="comment">/* 存储在线用户的通信连接 */</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>, TcpConnectionPtr&gt; _userConnectionMap;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

        <h1 id="数据模块"   >
          <a href="#数据模块" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#数据模块"></a> 数据模块</h1>
      

        <h2 id="业务模块与数据模块解耦-orm框架"   >
          <a href="#业务模块与数据模块解耦-orm框架" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#业务模块与数据模块解耦-orm框架"></a> 业务模块与数据模块解耦 - ORM框架</h2>
      
<blockquote>
<p>Object Relation Map - 对象关系映射。</p>
</blockquote>
<p>在这个框架中，业务层操作的都是对象，看不到具体的SQL操作。</p>
<p>在DAO层（数据层），才有具体的数据库操作。</p>
<p>解决了痛点：业务模块、数据模块之间的解耦。</p>

        <h2 id="搭建mysql数据库环境"   >
          <a href="#搭建mysql数据库环境" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#搭建mysql数据库环境"></a> 搭建MySQL数据库环境</h2>
      
<p>(以下命令基于ubuntu环境)</p>
<ol>
<li>
<p>安装mysql-server和mysql开发包, 包括mysql头文件和动态库文件</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> apt-get install mysql-server		<span class="comment">#安装最新版MySQL服务器</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install libmysqlclient-dev <span class="comment">#安装开发包</span></span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>初始的用户名和密码是自动生成的，按下面步骤修改mysql的root用户密码为123456</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">sudo</span> <span class="built_in">cat</span> /etc/mysql/debian.cnf</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">host = localhost</span><br><span class="line">user = debian-sys-maint 			<span class="comment">#初始的用户名</span></span><br><span class="line">password = Kk3TbShbFNvjvhpM			<span class="comment">#初始的密码</span></span><br><span class="line">socket = /var/run/mysqld/mysqld.sock</span><br></pre></td></tr></table></div></figure>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用上面初始的用户名和密码，登录mysql server，修改root用户的密码，命令如下：</span></span><br><span class="line">~$ mysql -u debian-sys-maint -pKk3TbShbFNvjvhpM</span><br><span class="line"><span class="comment">#-u后面是上面查看的用户名; -p后面紧跟上面查看的密码</span></span><br></pre></td></tr></table></div></figure>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update mysql.user set authentication_string=password(&#x27;123456&#x27;) where user=&#x27;root&#x27; and host=&#x27;localhost&#x27;;</span><br><span class="line">mysql&gt; update mysql.user set plugin=&quot;mysql_native_password&quot;;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>设置MySQL字符编码utf-8，以支持中文操作</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &quot;char%&quot;; # 先查看MySQL默认的字符编码</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name			   | Value			   			|</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | latin1                     |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | latin1                     |#不支持中文！！！</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows in set (0.06 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set character_set_server=utf8;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>修改表的字符编码：<code>alter table user default character set utf8;</code><br />
修改属性的字符编码：<code>alter table user modify column name varchar(50) character set utf8;</code></p>
</li>
</ol>

        <h2 id="mysql类-封装mysql操作"   >
          <a href="#mysql类-封装mysql操作" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysql类-封装mysql操作"></a> MySQL类 - 封装MySQL操作</h2>
      
<p>需要引入<code>mysql/mysql.h</code>头文件</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;mysql/mysql.h&gt;</span></span></span><br></pre></td></tr></table></div></figure>

        <h3 id="成员变量"   >
          <a href="#成员变量" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#成员变量"></a> 成员变量</h3>
      
<p><code>MYSQL *m_conn</code> - 记录MYSQL类型的指针, 以获取这个mysql连接</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    MYSQL *m_conn;</span><br></pre></td></tr></table></div></figure>

        <h3 id="成员函数-3"   >
          <a href="#成员函数-3" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#成员函数-3"></a> 成员函数</h3>
      
<ol>
<li>
<p>构造/析构 - 初始化/释放数据库连接</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 初始化数据库连接 */</span></span><br><span class="line">    <span class="built_in">MySQL</span>();</span><br><span class="line">    <span class="comment">/* 释放数据库连接资源 */</span></span><br><span class="line">    ~<span class="built_in">MySQL</span>();</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>getConnection - 获取连接, 即获取成员<code>m_conn</code></p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 获取连接 */</span></span><br><span class="line">    <span class="function">MYSQL * <span class="title">getConnection</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>connect - 连接数据库, 返回值为bool, 说明连接成功与否</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 连接数据库 */</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">connect</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>query - 查询操作, 参数是string类型的sql语句, 返回值为<code>MYSQL_RES</code>, 即MySQL结果集类型</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 查询操作 */</span></span><br><span class="line">    <span class="function">MYSQL_RES * <span class="title">query</span><span class="params">(string sql)</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>update - 更新操作, 参数是string类型的sql语句, 返回值为bool, 说明更新成功与否</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 更新操作 */</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">update</span><span class="params">(string sql)</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
</ol>

        <h3 id="代码实现-3"   >
          <a href="#代码实现-3" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#代码实现-3"></a> 代码实现</h3>
      
<p>前置全局声明</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span>	<span class="comment">//日志工具</span></span></span><br><span class="line"><span class="comment">/* 数据库配置信息 */</span></span><br><span class="line"><span class="type">static</span> string server = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="type">static</span> string user = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="type">static</span> string password = <span class="string">&quot;123&quot;</span>;</span><br><span class="line"><span class="type">static</span> string dbname = <span class="string">&quot;chat&quot;</span>;</span><br></pre></td></tr></table></div></figure>
<ol>
<li>
<p>构造 - 调用<code>mysql_init</code>, 实际上只是对mysql连接进行空间资源的开辟, 返回一个指针赋给<code>m_conn</code>成员, 没有真正连接, 因此传入nullptr</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 初始化数据库连接 */</span></span><br><span class="line">MySQL::<span class="built_in">MySQL</span>()</span><br><span class="line">&#123;</span><br><span class="line">    m_conn = <span class="built_in">mysql_init</span>(<span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>析构 - 调用<code>mysql_close(m_conn)</code>, 对MySQL连接资源进行释放</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 释放数据库连接资源 */</span></span><br><span class="line">MySQL::~<span class="built_in">MySQL</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_conn != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">mysql_close</span>(m_conn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>getConnection - 获取连接, 即返回<code>m_conn</code>成员</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 获取连接 */</span></span><br><span class="line"><span class="function">MYSQL * <span class="title">MySQL::getConnection</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_conn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>connect - 连接数据库, 内部调用<code>mysql_real_connect</code>, 传入<code>m_conn</code>, 以及server地址, user号, 密码, 要连接的数据库name, 服务器端口;</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 连接数据库 */</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MySQL::connect</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MYSQL *p = <span class="built_in">mysql_real_connect</span>(m_conn, server.<span class="built_in">c_str</span>(), user.<span class="built_in">c_str</span>(),</span><br><span class="line">                                  password.<span class="built_in">c_str</span>(), dbname.<span class="built_in">c_str</span>(), <span class="number">3306</span>, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(p != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* C/C++代码默认的编码字符是ASCII，如果不设置，则从MySQL上拉下来的中文无法正常显示 */</span></span><br><span class="line">        <span class="built_in">mysql_query</span>(m_conn, <span class="string">&quot;set name gbk&quot;</span>);</span><br><span class="line">        LOG_INFO &lt;&lt; <span class="string">&quot;connect mysql success!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LOG_INFO &lt;&lt; <span class="string">&quot;connect mysql failed!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>query - 查询操作</p>
<ol>
<li>
<p>内部调用<code>mysql_query</code>, 传入<code>m_conn</code>, <code>sql-string</code>的c风格字符串首址;</p>
<blockquote>
<p><code>mysql_query</code>的返回值:</p>
<ol>
<li>如果查询成功，返回0;</li>
<li>如果出现错误，返回非0值。</li>
</ol>
</blockquote>
</li>
<li>
<p>返回值需要调用<code>mysql_use_result(m_conn)</code>获取结果集, 再return;</p>
</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 查询操作 */</span></span><br><span class="line"><span class="function">MYSQL_RES * <span class="title">MySQL::query</span><span class="params">(string sql)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">mysql_query</span>(m_conn, sql.<span class="built_in">c_str</span>()))</span><br><span class="line">    &#123;</span><br><span class="line">        LOG_INFO &lt;&lt; __FILE__ &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; __LINE__ &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; sql &lt;&lt; <span class="string">&quot;查询失败!&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">mysql_use_result</span>(m_conn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>update - 更新操作</p>
<ol>
<li>内部调用<code>mysql_query</code>, 传入<code>m_conn</code>, <code>sql-string</code>的c风格字符串首址;</li>
<li>判断<code>mysql_query</code>的返回值, 若为非0则更新失败; 若为0则更新成功;</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 更新操作 */</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MySQL::update</span><span class="params">(string sql)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">mysql_query</span>(m_conn, sql.<span class="built_in">c_str</span>()))</span><br><span class="line">    &#123;</span><br><span class="line">        LOG_INFO &lt;&lt; __FILE__ &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; __LINE__ &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; sql &lt;&lt; <span class="string">&quot;更新失败!&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
</ol>

        <h2 id="model层-对业务层封装底层数据库的操作"   >
          <a href="#model层-对业务层封装底层数据库的操作" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#model层-对业务层封装底层数据库的操作"></a> Model层 - 对业务层封装底层数据库的操作</h2>
      
<p>以User类的操作为例</p>

        <h3 id="user类"   >
          <a href="#user类" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#user类"></a> User类</h3>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> USER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 属于映射类;</span></span><br><span class="line"><span class="comment"> * 匹配User表的ORM类;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">User</span>(<span class="type">int</span> id = <span class="number">-1</span>, string name=<span class="string">&quot;&quot;</span>, string password=<span class="string">&quot;&quot;</span>, string state=<span class="string">&quot;offline&quot;</span>)</span><br><span class="line">        : <span class="built_in">id_</span>(id), <span class="built_in">name_</span>(name), <span class="built_in">password_</span>(password), <span class="built_in">state_</span>(state)</span><br><span class="line">    &#123;   </span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setId</span><span class="params">(<span class="type">int</span> id)</span></span>&#123;id_ = id;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setName</span><span class="params">(string name)</span></span>&#123;name_ = name;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setPassword</span><span class="params">(string password)</span></span>&#123;password_ = password;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setState</span><span class="params">(string state)</span></span>&#123;state_ = state;&#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getId</span><span class="params">()</span> <span class="type">const</span></span>&#123;<span class="keyword">return</span> id_;&#125;</span><br><span class="line">    <span class="function">string <span class="title">getName</span><span class="params">()</span> <span class="type">const</span></span>&#123;<span class="keyword">return</span> name_;&#125;</span><br><span class="line">    <span class="function">string <span class="title">getPassword</span><span class="params">()</span> <span class="type">const</span></span>&#123;<span class="keyword">return</span> password_;&#125;</span><br><span class="line">    <span class="function">string <span class="title">getState</span><span class="params">()</span> <span class="type">const</span></span>&#123;<span class="keyword">return</span> state_;&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> id_;</span><br><span class="line">    string name_;</span><br><span class="line">    string password_;</span><br><span class="line">    string state_;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

        <h3 id="usermodel类"   >
          <a href="#usermodel类" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#usermodel类"></a> UserModel类</h3>
      
<ol>
<li>insert - 参数为User的引用, 返回值为bool</li>
<li>query - 参数为id, 返回值为User</li>
<li>updateState - 更新用户的状态信息, 参数为User的一个临时副本, 返回bool</li>
<li>resetAllState - 重置所有用户的状态信息</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> USERMODEL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USERMODEL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;user.hpp&quot;</span></span></span><br><span class="line"><span class="comment">/* User表的数据操作类 */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserModel</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* User表的增加方法 */</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">insert</span><span class="params">(User &amp;user)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 根据用户号码查询用户信息 */</span></span><br><span class="line">    <span class="function">User <span class="title">query</span><span class="params">(<span class="type">int</span> id)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 更新用户的状态信息 */</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">updateState</span><span class="params">(User user)</span></span>;</span><br><span class="line">    <span class="comment">/* 重置所有用户的状态信息 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">resetAllState</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

        <h4 id="代码实现-4"   >
          <a href="#代码实现-4" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#代码实现-4"></a> 代码实现</h4>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;db.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">/* User表的增加方法 */</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UserModel::insert</span><span class="params">(User &amp;user)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 1.组装SQL语句 */</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(sql, <span class="string">&quot;insert into user(name, password, state) values(&#x27;%s&#x27;, &#x27;%s&#x27;, &#x27;%s&#x27;)&quot;</span>,</span><br><span class="line">        user.<span class="built_in">getName</span>().<span class="built_in">c_str</span>(), user.<span class="built_in">getPassword</span>().<span class="built_in">c_str</span>(), user.<span class="built_in">getState</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    MySQL mysql;</span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mysql.<span class="built_in">update</span>(sql))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 获取插入成功的用户数据生成的主键id */</span></span><br><span class="line">            <span class="comment">/* 以下的mysql_insert_id是生成id的方法之一 */</span></span><br><span class="line">            user.<span class="built_in">setId</span>(<span class="built_in">mysql_insert_id</span>(mysql.<span class="built_in">getConnection</span>()));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 注册失败 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 根据用户号码查询用户信息 */</span></span><br><span class="line"><span class="function">User <span class="title">UserModel::query</span><span class="params">(<span class="type">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 1.组装SQL语句 */</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(sql, <span class="string">&quot;select * from user where id = %d&quot;</span>, id);</span><br><span class="line">    MySQL mysql;</span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* mysql.query内部申请了资源，处理完成User的构造后，需要free */</span></span><br><span class="line">        MYSQL_RES *res = mysql.<span class="built_in">query</span>(sql);  <span class="comment">// 此query为MySQL的query，和update同级。</span></span><br><span class="line">        <span class="keyword">if</span>(res != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            MYSQL_ROW row = <span class="built_in">mysql_fetch_row</span>(res);</span><br><span class="line">            <span class="keyword">if</span>(row != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                User user;</span><br><span class="line">                user.<span class="built_in">setId</span>(<span class="built_in">atoi</span>(row[<span class="number">0</span>]));</span><br><span class="line">                user.<span class="built_in">setName</span>(row[<span class="number">1</span>]);</span><br><span class="line">                user.<span class="built_in">setPassword</span>(row[<span class="number">2</span>]);</span><br><span class="line">                user.<span class="built_in">setState</span>(row[<span class="number">3</span>]);</span><br><span class="line">                <span class="built_in">mysql_free_result</span>(res);</span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 如果没有有效的查询结果，返回一个默认User，id为-1，表示出错 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">User</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 更新用户的状态信息 */</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UserModel::updateState</span><span class="params">(User user)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 1.组装SQL语句 */</span></span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(sql, <span class="string">&quot;update user set state = &#x27;%s&#x27; where id = %d&quot;</span>, user.<span class="built_in">getState</span>().<span class="built_in">c_str</span>(), user.<span class="built_in">getId</span>());</span><br><span class="line">    MySQL mysql;</span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mysql.<span class="built_in">update</span>(sql))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 重置所有用户的状态信息 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UserModel::resetAllState</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> sql[<span class="number">1024</span>] = <span class="string">&quot;update user set state = &#x27;offline&#x27; where state = &#x27;online&#x27;&quot;</span>;</span><br><span class="line">    MySQL mysql;</span><br><span class="line">    <span class="keyword">if</span>(mysql.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        mysql.<span class="built_in">update</span>(sql);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h1 id="测试"   >
          <a href="#测试" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#测试"></a> 测试</h1>
      
<p>点对点聊天</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ChatServer</span><br></pre></td></tr></table></div></figure>
<p>点对点聊天的json格式：<code>&#123;&quot;msgid&quot;:5,&quot;from&quot;:&quot;from_name&quot;,&quot;to&quot;:to_id,&quot;msg&quot;:&quot;......&quot;&#125;</code></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># xcg</span></span><br><span class="line">telnet 127.0.0.1 6000</span><br><span class="line">&#123;<span class="string">&quot;msgid&quot;</span>:1,<span class="string">&quot;id&quot;</span>:22,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;	<span class="comment">#登录</span></span><br><span class="line">&#123;<span class="string">&quot;msgid&quot;</span>:5,<span class="string">&quot;from&quot;</span>:<span class="string">&quot;xcg&quot;</span>,<span class="string">&quot;to&quot;</span>:13,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;hello zhang san, i&#x27;m xcg!&quot;</span>&#125;	<span class="comment">#发送消息</span></span><br><span class="line"><span class="comment"># 发送离线消息</span></span><br><span class="line">&#123;<span class="string">&quot;msgid&quot;</span>:5,<span class="string">&quot;from&quot;</span>:<span class="string">&quot;xcg&quot;</span>,<span class="string">&quot;to&quot;</span>:13,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;hello - 1&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;msgid&quot;</span>:5,<span class="string">&quot;from&quot;</span>:<span class="string">&quot;xcg&quot;</span>,<span class="string">&quot;to&quot;</span>:13,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;hello - 2&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;msgid&quot;</span>:5,<span class="string">&quot;from&quot;</span>:<span class="string">&quot;xcg&quot;</span>,<span class="string">&quot;to&quot;</span>:13,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;hello - 3&quot;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zhang san</span></span><br><span class="line">telnet 127.0.0.1 6000</span><br><span class="line">&#123;<span class="string">&quot;msgid&quot;</span>:1,<span class="string">&quot;id&quot;</span>:13,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;123456&quot;</span>&#125;	<span class="comment">#登录</span></span><br><span class="line">&#123;<span class="string">&quot;msgid&quot;</span>:5,<span class="string">&quot;from&quot;</span>:<span class="string">&quot;zhang san&quot;</span>,<span class="string">&quot;to&quot;</span>:22,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;hello xcg, i&#x27;m zhang san!&quot;</span>&#125;#发送消息</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

        <h1 id="好友业务"   >
          <a href="#好友业务" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#好友业务"></a> 好友业务</h1>
      
<ol>
<li>显示有哪些已添加的好友，id</li>
<li>添加好友</li>
</ol>
<p>但是业务并不严格，只要知道其id即可聊天。</p>
<p>总体业务流程：向服务器发起添加好友的请求，服务器就把关系添加到friend表中，初版本不用征询对方的同意。</p>
<p>friend表就两个字段：userid、friendid是联合主键。</p>

        <h2 id="测试-2"   >
          <a href="#测试-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#测试-2"></a> 测试</h2>
      
<p>添加好友、登陆成功后显示好友列表</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ChatServer</span><br></pre></td></tr></table></div></figure>
<p>添加好友的json格式：<code>&#123;&quot;msgid&quot;:6,&quot;id&quot;:22,&quot;friendid&quot;:13&#125;</code>。此语句意为：id为22的用户主动添加id为13的用户为好友，建立双向关系。</p>
<p>添加后，查看friend表中是否有信息，应有一个id:22 - friendid:13。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from friend;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># xcg</span></span><br><span class="line">telnet 127.0.0.1 6000</span><br><span class="line">&#123;<span class="string">&quot;msgid&quot;</span>:1,<span class="string">&quot;id&quot;</span>:22,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;	<span class="comment"># 登录</span></span><br><span class="line">&#123;<span class="string">&quot;msgid&quot;</span>:6,<span class="string">&quot;id&quot;</span>:22,<span class="string">&quot;friendid&quot;</span>:13&#125;	<span class="comment"># 添加id:13为好友</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ctrl + ] -&gt; quit 退出</span></span><br><span class="line"><span class="comment"># 重新登陆</span></span><br><span class="line">telnet 127.0.0.1 6000</span><br><span class="line">&#123;<span class="string">&quot;msgid&quot;</span>:1,<span class="string">&quot;id&quot;</span>:22,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;	<span class="comment"># 登录</span></span><br><span class="line"><span class="comment"># 看看是否返回好友列表</span></span><br></pre></td></tr></table></div></figure>

        <h1 id="群组业务"   >
          <a href="#群组业务" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#群组业务"></a> 群组业务</h1>
      
<ol>
<li>管理员创建群</li>
<li>用户加入群</li>
<li>群聊</li>
</ol>

        <h2 id="表"   >
          <a href="#表" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#表"></a> 表</h2>
      
<p>与群组业务相关的有两张表：一个是AllGroup表，一个是GroupUser表。</p>
<p>AllGroup表有三个字段：id、groupname、groupdesc(群组描述)</p>
<p>GroupUser表，因为群和成员之间是多对多的关系，所以需要此中间表来描述这个关系。有三个字段：groupid、userid、grouprole(成员在群中的权限)。groupid和userid是联合主键。</p>
<p>这两张表都是处理群组业务的，所以对应的model只创建了一个。</p>

        <h2 id="model"   >
          <a href="#model" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#model"></a> model</h2>
      
<p>groupmodel.hpp</p>

        <h1 id="负载均衡"   >
          <a href="#负载均衡" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#负载均衡"></a> 负载均衡</h1>
      
<p>负载均衡器, 亦叫做反向代理服务器, 在集群服务器架构中, 作为统一接收客户端请求的端口, 其根据配置所界定的负载算法, 把客户端的请求分发到业务服务器上, 要做的三件事情：</p>
<ol>
<li>
<p>把client的请求按照负载均衡算法分发到具体的业务服务器ChatServer上面；相应地, 服务器的响应也要经过负载均衡器, 准确地返回给这个client;</p>
<blockquote>
<p>服务器的响应消息操作, 也可以通过服务器和客户端建立一个ip隧道实现, 达到直接连接, 这样的效率更好;</p>
</blockquote>
</li>
<li>
<p>能够和ChatServer保持心跳机制，监测ChatServer故障；</p>
</li>
<li>
<p>能够发现新添加的ChatServer设备，方便扩展服务器数量, 最好是能够平滑地完成这个过程, 而不是需要重启负载均衡服务器导致服务停止。</p>
</li>
</ol>

        <h2 id="nginx负载均衡模块"   >
          <a href="#nginx负载均衡模块" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#nginx负载均衡模块"></a> nginx负载均衡模块</h2>
      
<p>本项目选择nginx的tcp负载均衡模块，要解决的问题</p>
<ol>
<li>如何进行nginx源码编译，包含tcp负载均衡模块</li>
<li>nginx.conf配置文件中如何配置负载均衡</li>
<li>nginx的平滑加载配置文件启动</li>
</ol>
<p>nginx在1.9版本之前，只支持http协议web服务器的负载均衡，从1.9版本开始以后，nginx开始支持tcp的长连接负载均衡，但是nginx默认不编译tcp负载均衡模块，编写它时，需要加入<code>--with-stream</code>参数来激活这个模块。</p>

        <h3 id="编译安装操作流程"   >
          <a href="#编译安装操作流程" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#编译安装操作流程"></a> 编译安装操作流程</h3>
      
<p>以<code>nginx-1.12.2.tar.gz</code>为例;</p>
<p>nginx编译安装需要先安装pcre、openssl、zlib等库。</p>
<blockquote>
<p>对开源产品发行源代码的编译安装, 一般都是:</p>
<ol>
<li>先执行<code>./configure</code>, 生产相应的makefile文件;</li>
<li><code>make</code>, 进行编译</li>
<li><code>make install</code>, 进行安装</li>
</ol>
</blockquote>
<p>解压<code>nginx-1.12.2.tar.gz</code>后，进入<code>nginx-1.12.2</code>目录，先运行<code>./configure --with-stream</code>生成<code>Makefile</code>后，运行<code>make</code>，最后<code>make install</code>。make install命令会向系统路径拷贝文件，所以需要在root用户下执行。</p>
<p>编译完成后，默认安装在了<code>/usr/local/nginx</code>目录。</p>
<p><code>nginx</code>目录下，可执行文件在<code>sbin</code>目录里，配置文件在<code>conf</code>目录里。</p>

        <h3 id="配置"   >
          <a href="#配置" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#配置"></a> 配置</h3>
      
<p>如何配置负载均衡?</p>
<p><code>/usr/local/nginx/conf/nginx.conf</code>中, 可以看到http字段, 这是基于http的负载均衡配置;</p>
<figure class="highlight nginx"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span> /var/www/hexo;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>而本项目是tcp服务器, 需要写到<code>stream</code>下, 表示基于tcp的负载均衡配置;</p>
<ol>
<li>server字段
<ol>
<li>listen - nginx负载均衡器将要监听的端口号</li>
<li><code>proxy_pass</code> - 所有在listen字段端口号上的请求都将分发到这个标记字段所填充到信息中</li>
</ol>
</li>
<li>upstream字段 - 可用于负载均衡的服务器信息
<ol>
<li>server - IP:port - weight权重 - <code>max_fail</code>最多失败次数 - <code>fail_timeout</code>最长等待响应时间</li>
</ol>
</li>
</ol>
<figure class="highlight nginx"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx tcp loadbalance config</span></span><br><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="section">upstream</span> MyServer &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:6000</span> weight=<span class="number">1</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:6002</span> weight=<span class="number">1</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="comment"># proxy connect timeout 1s;</span></span><br><span class="line">        <span class="attribute">listen</span>     <span class="number">8000</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> MyServer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="常用操作"   >
          <a href="#常用操作" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#常用操作"></a> 常用操作</h3>
      
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload		<span class="comment"># 重新加载配置文件，平滑启动</span></span><br><span class="line">nginx -s stop		<span class="comment"># 停止nginx服务</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="模型设计"   >
          <a href="#模型设计" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#模型设计"></a> 模型设计</h3>
      
<blockquote>
<p>reactors in process - one loop per process</p>
</blockquote>
<p>nginx服务器的网络模块设计是基于进程的, 采用多个Reactor充当I/O进程和工作进程, 通过accept锁完美解决多个Reactors的惊群现象;</p>

        <h2 id="更加高并发"   >
          <a href="#更加高并发" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#更加高并发"></a> 更加高并发?</h2>
      
<p>负载均衡也分为很多种, 可分为业务层负载均衡器, 通过业务分发; 也可分为传输层的负载均衡器, 通过udp/tcp分发; 网络层, 通过ip分发; 数据链路层通过数据帧分发;</p>
<p>如何更进一步提高并发量?</p>
<p>可以把负载均衡器也进行集群处理, 前端使用一个偏底层的LVS负载均衡器, 即, 一台LVS加多台nginx服务器的模型; LVS的并发量很容易扩展到十几万;</p>

        <h1 id="跨服务器通信"   >
          <a href="#跨服务器通信" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#跨服务器通信"></a> 跨服务器通信</h1>
      
<p>本项目中, 用户间的通信模型无非有两种：一对一聊天、群聊。</p>
<p>集群环境中，即用户可能分布在不同服务器主机上。如果按照之前的代码逻辑，每台服务器上的一个Server都只有一个<code>m_userConnectionMap</code>（因为这个是ChatService中的成员，而ChatService是单例模式）。所以用户给对方发消息后，如果接收方用户不在同一台服务器上，那么该消息就会被当作离线消息，这显然是不对的。</p>
<p>那么怎么解决跨服务器通信呢？</p>
<p>最直观的想法是让各个ChatServer服务器互相之间直接建立TCP连接进行通信，相当于在服务器网络之间进行广播。这样的设计使得各个服务器之间耦合度太高，不利于系统扩展，并且会占用系统大量的socket资源，各服务器之间的带宽压力很大，不能够节省资源给更多的客户端提供服务，因此不是一个好的设计。</p>
<p>集群部署的服务器之间进行通信，最好的方式就是引入中间件消息队列，解耦各个服务器，使整个系统松耦合，提高服务器的响应能力，节省服务器的带宽资源; 所以答案是引入服务器中间件如消息队列; 如此一来, 服务器仅需做的工作是：向中间件发布订阅消息，之后等待中间件通知去取消息。</p>
<p>在集群分布式环境中，经常使用的中间件消息队列有ActiveMQ、RabbitMQ、Kafka等，都是应用场景广泛并且性能很好的消息队列，供集群服务器之间，分布式服务之间进行消息通信。限于本项目业务类型并不是非常复杂，对并发请求量也没有太高的要求，因此本项目中间件消息队列选型的是-基于发布-订阅模式的redis。</p>

        <h2 id="redis环境安装和配置"   >
          <a href="#redis环境安装和配置" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#redis环境安装和配置"></a> Redis环境安装和配置</h2>
      
<ol>
<li>
<p>Ubuntu安装redis服务命令</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install redis-server</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>安装完成后会自动启动redis服务，通过ps命令确认; redis默认端口为6379</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep redis</span><br></pre></td></tr></table></div></figure>
</li>
</ol>

        <h2 id="redis-cli测试redis-server"   >
          <a href="#redis-cli测试redis-server" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#redis-cli测试redis-server"></a> redis-cli测试redis-server</h2>
      
<p>启动redis-cli客户端，连接redis server体验一下数据缓存功能</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set &quot;abc&quot; &quot;hello world&quot; #设置key-value</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get &quot;abc&quot;</span><br><span class="line">&quot;hello world&quot;</span><br></pre></td></tr></table></div></figure>

        <h2 id="redis订阅发布"   >
          <a href="#redis订阅发布" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#redis订阅发布"></a> Redis订阅/发布</h2>
      
<p>redis的发布-订阅机制：发布-订阅模式包含了两种角色，分别是消息的发布者和消息的订阅者。订阅者可以订阅一个或者多个频道channel，发布者可以向指定的频道channel发送消息，所有订阅此频道的订阅者都会收到此消息。</p>
<p>订阅频道的命令是 subscribe，可以同时订阅多个频道，用法是<code>subscribe channel1 [channel2] ...</code>;</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; subscribe 13</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) &quot;subscribe&quot;</span><br><span class="line">2) &quot;13&quot;</span><br><span class="line">3) (integer) 1</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; publish 13 &quot;hello, 13&quot; #另一端推送消息给13</span><br></pre></td></tr></table></div></figure>
<p>订阅了<code>13</code>频道 的用户收到的消息:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1) &quot;message&quot;</span><br><span class="line">2) &quot;13&quot;</span><br><span class="line">3) &quot;hello, 13&quot;</span><br></pre></td></tr></table></div></figure>

        <h3 id="对应于本项目"   >
          <a href="#对应于本项目" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#对应于本项目"></a> 对应于本项目</h3>
      
<p>由于服务器是集群化的, 所以登录到本系统的用户可能不在同一聊天服务器上, 需要观察Redis中间件来获取消息;</p>
<p>即, 用户是观察者, 消息队列是被观察者;</p>
<p>某一用户登陆到聊天系统后,</p>
<ol>
<li>服务器需要向Redis订阅某一频道的消息, 这个频道的id号即为该用户的id号;</li>
<li>当该用户给另一用户发送消息时, 发现其不在本服务器中, 需要向该频道发布消息;</li>
</ol>

        <h2 id="redis发布-订阅的客户端编程-封装为redis类"   >
          <a href="#redis发布-订阅的客户端编程-封装为redis类" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#redis发布-订阅的客户端编程-封装为redis类"></a> redis发布-订阅的客户端编程 - 封装为Redis类</h2>
      
<p>redis支持多种不同的客户端编程语言，例如Java对应Jedis，PHP对应phpredis，C++对应的是hiredis。</p>

        <h3 id="hiredis安装步骤"   >
          <a href="#hiredis安装步骤" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#hiredis安装步骤"></a> hiredis安装步骤</h3>
      
<ol>
<li>
<p><code>git clone https://github.com/redis/hiredis</code></p>
</li>
<li>
<p>make &amp;&amp; make install</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> hiredis</span><br><span class="line">make</span><br><span class="line">...</span><br><span class="line"><span class="built_in">sudo</span> make install <span class="comment">#拷贝生成的动态库到/usr/local/lib目录下</span></span><br><span class="line"><span class="comment"># 如果提示没有找到hiredis动态库，则执行下面</span></span><br><span class="line"><span class="comment"># sudo ldconfig /usr/local/lib</span></span><br></pre></td></tr></table></div></figure>
</li>
</ol>

        <h3 id="成员变量-2"   >
          <a href="#成员变量-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#成员变量-2"></a> 成员变量</h3>
      
<ol>
<li>
<p>hiredis同步上下文对象</p>
<ol>
<li>一个专门负责publish消息</li>
<li>一个专门负责subscribe消息</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* hiredis同步上下文对象, 负责publish消息 */</span></span><br><span class="line">    redisContext * m_publish_context;</span><br><span class="line">    <span class="comment">/* hiredis同步上下文对象, 负责subscribe消息 */</span></span><br><span class="line">    redisContext * m_subscribe_context;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>回调操作, 收到订阅的消息, 给service层上报</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* 回调操作, 收到订阅的消息, 给service层上报 */</span></span><br><span class="line">    MessageCallback m_notify_handler;</span><br></pre></td></tr></table></div></figure>
</li>
</ol>
<blockquote>
<ol>
<li>对于&quot;hiredis上下文对象&quot;的理解:</li>
</ol>
<ul>
<li>相当于一个redis-cli, 存储了连接相关的信息;</li>
</ul>
<ol start="2">
<li>为什么要写两个上下文对象?</li>
</ol>
<ul>
<li>如果上下文对象正在subscribe那么其将会阻塞, 所以subscribe和publish需要分开操作;</li>
</ul>
</blockquote>

        <h3 id="成员函数-4"   >
          <a href="#成员函数-4" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#成员函数-4"></a> 成员函数</h3>
      
<ol>
<li>
<p>构造/析构</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Redis</span>();</span><br><span class="line">    ~<span class="built_in">Redis</span>();</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>connect - 连接Redis服务器</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 连接Redis服务器 */</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">connect</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>发布/订阅消息</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 向指定的redis频道发布消息 */</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">publish</span><span class="params">(<span class="type">int</span> channel, string message)</span></span>;</span><br><span class="line">    <span class="comment">/* 向指定的redis频道订阅消息 */</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">subscribe</span><span class="params">(<span class="type">int</span> channel)</span></span>;</span><br><span class="line">    <span class="comment">/* 向指定的redis频道取消订阅消息 */</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">unsubscribe</span><span class="params">(<span class="type">int</span> channel)</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p><code>observer_channel_message</code> - 在独立线程中接收订阅频道中的消息</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 在独立线程中接收订阅频道中的消息 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">observer_channel_message</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p><code>init_notify_handler</code> - 初始化向业务层上报频道消息 的回调函数, 需要用到一个int(频道号), 一个消息内容字符串</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> MessageCallback = function&lt;<span class="built_in">void</span>(<span class="type">int</span>, string)&gt;;</span><br><span class="line">    <span class="comment">/* 初始化向业务层上报频道消息 的回调函数, 需要用到int(频道号), 消息内容字符串 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init_notify_handler</span><span class="params">(MessageCallback cb)</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
</ol>

        <h3 id="代码实现-5"   >
          <a href="#代码实现-5" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#代码实现-5"></a> 代码实现</h3>
      
<ol>
<li>
<p>构造 - 只是对两个上下文对象指针赋nullptr, 没有实际构造</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Redis::<span class="built_in">Redis</span>()</span><br><span class="line">    : <span class="built_in">m_publish_context</span>(<span class="literal">nullptr</span>), <span class="built_in">m_subscribe_context</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>析构 - 调用<code>redisFree</code>释放上下文对象资源</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Redis::~<span class="built_in">Redis</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_publish_context != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">redisFree</span>(m_publish_context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(m_subscribe_context != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">redisFree</span>(m_subscribe_context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>connect</p>
<ol>
<li>对context进行实际的申请资源/构造, 返回指针赋给成员, 底层调用<code>redisConnect</code></li>
<li>创建线程, 执行<code>observer_channel_message</code>, 即循环等待Redis频道的reply</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Redis::connect</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_publish_context = <span class="built_in">redisConnect</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">nullptr</span> == m_publish_context)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect redis failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_subscribe_context = <span class="built_in">redisConnect</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">nullptr</span> == m_subscribe_context)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect redis failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 由于subscribe操作是阻塞的, </span></span><br><span class="line"><span class="comment">     * 在实际的使用环境下, 不可能因为一个订阅操作去阻塞一个服务器, </span></span><br><span class="line"><span class="comment">     * 所以要用一个单独的线程来完成监听频道上的事件,</span></span><br><span class="line"><span class="comment">     * 有消息则给业务层进行上报; </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        [&amp;]() &#123; observer_channel_message();&#125; )</span></span>;</span><br><span class="line">    t.<span class="built_in">detach</span>();</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;connect redis-server success!&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>publish - 相当于向redis-server发送命令, reply接收命令执行结果</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Redis::publish</span><span class="params">(<span class="type">int</span> channel, string message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 相当于向redis-server发送命令, reply接收命令执行结果 */</span></span><br><span class="line">    redisReply * reply = (redisReply*)<span class="built_in">redisCommand</span>(</span><br><span class="line">        m_publish_context, <span class="string">&quot;PUBLISH %d %s&quot;</span>, channel, message.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">nullptr</span> == reply)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;publish command failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">freeReplyObject</span>(reply);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>subscribe - 相当于把redisCommand细化了, 只操作了发命令, 接收结果交给单独的线程做了, 详见<code>observer_channel_message</code></p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Redis::subscribe</span><span class="params">(<span class="type">int</span> channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(REDIS_ERR == <span class="built_in">redisAppendCommand</span>(</span><br><span class="line">        m_subscribe_context, <span class="string">&quot;SUBSCRIBE %d&quot;</span>, channel))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;subscribe command failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 循环发送缓冲区内容, 直到发送完毕 */</span></span><br><span class="line">    <span class="type">int</span> done = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(!done)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(REDIS_ERR == <span class="built_in">redisBufferWrite</span>(m_subscribe_context, &amp;done))</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;subscribe command failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里不做redisReply的操作,</span></span><br><span class="line"><span class="comment">     * 这是个阻塞的操作, 放在observer_channel_message中做;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>unsubscribe</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Redis::unsubscribe</span><span class="params">(<span class="type">int</span> channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(REDIS_ERR == <span class="built_in">redisAppendCommand</span>(</span><br><span class="line">        m_subscribe_context, <span class="string">&quot;UNSUBSCRIBE %d&quot;</span>, channel))</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;unsubscribe command failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 循环发送缓冲区内容, 直到发送完毕 */</span></span><br><span class="line">    <span class="type">int</span> done = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(!done)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(REDIS_ERR == <span class="built_in">redisBufferWrite</span>(m_subscribe_context, &amp;done))</span><br><span class="line">        &#123;</span><br><span class="line">            cerr &lt;&lt; <span class="string">&quot;unsubscribe command failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里不做redisReply的操作,</span></span><br><span class="line"><span class="comment">     * 这是个阻塞的操作, 放在observer_channel_message中做;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p><code>observer_channel_message</code></p>
<ul>
<li>Redis频道如果有消息, 则有三个字段,
<ol>
<li>对应的是redisGetReply返回的<code>reply-&gt;element[0],[1],[2]</code>;</li>
<li>本项目的<code>element[1]</code>对应的是频道号;</li>
<li>本项目的<code>element[2]</code>对应的是消息体;</li>
</ol>
</li>
</ul>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Redis::observer_channel_message</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    redisReply *reply = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">int</span> res = REDIS_ERR;</span><br><span class="line">    <span class="keyword">while</span>(REDIS_OK==(res = <span class="built_in">redisGetReply</span>(</span><br><span class="line">                                m_subscribe_context, (<span class="type">void</span>**)&amp;reply)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(reply != <span class="literal">nullptr</span> &amp;&amp;</span><br><span class="line">           reply-&gt;element[<span class="number">2</span>] != <span class="literal">nullptr</span> &amp;&amp;</span><br><span class="line">           reply-&gt;element[<span class="number">2</span>]-&gt;str != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 给业务层上报频道上发生的消息, 即频道号+消息体 */</span></span><br><span class="line">            <span class="built_in">m_notify_handler</span>(<span class="built_in">atoi</span>(reply-&gt;element[<span class="number">1</span>]-&gt;str),</span><br><span class="line">                             reply-&gt;element[<span class="number">2</span>]-&gt;str );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">freeReplyObject</span>(reply);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(res == REDIS_ERR)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;redisGetReply err&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;observer_channel_message quit&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p><code>init_notify_handler</code> - 设置<code>m_notify_handler</code>回调</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Redis::init_notify_handler</span><span class="params">(MessageCallback cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_notify_handler = cb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
</ol>
<blockquote>
<p>redisCommand和redisAppendCommand的区别:</p>
<ol>
<li>redisAppendCommand只是把命令先写到本地缓存中;</li>
<li>写到缓存之后还需要调用redisBufferWrite把缓存中的命令发送到Redis服务器;</li>
<li>最后, 如果要获得reply, 还需要调用redisGetReply获取结果, 这个操作对于subscribe是阻塞的;</li>
<li>由于publish操作一般不会阻塞, 所以直接调用redisCommand;</li>
<li>由于subscribe操作最后的redisGetReply将会阻塞, 所以我们把这几个步骤单独写出来, 粒度减小, 追求效率;</li>
</ol>
</blockquote>

        <h1 id="chatservice加入redis组件"   >
          <a href="#chatservice加入redis组件" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#chatservice加入redis组件"></a> ChatService加入Redis组件</h1>
      
<ol>
<li>
<p>首先, 需要在<code>chatservice.hpp</code>中, 引入头文件<code>&quot;redis.hpp&quot;</code>; 然后在<code>ChatService</code>的类成员变量中声明一个<code>Redis m_redis</code>redis操作对象;</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Redis m_redis;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>在ChatService类中, 添加一个处理redis业务的成员函数<code>handleRedisSubscribeMessage</code></p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">handleRedisSubscribeMessage</span><span class="params">(<span class="type">int</span> channel, string message)</span></span>;</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>在<code>chatservice.cpp</code>中, ChatService的构造函数中, 需要添加连接redis服务器的操作; 如果连接成功, 给redis设置回调函数为<code>handleRedisSubscribeMessage</code>, 参数为chatservice对象指针, channel, message;</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span>(m_redis.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        m_redis.<span class="built_in">init_notify_handler</span>(std::<span class="built_in">bind</span>(</span><br><span class="line">            &amp;ChatService::handleRedisSubscribeMessage, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
</ol>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://xing-cg.github.io">Mr.Can</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://xing-cg.github.io/%E9%A1%B9%E7%9B%AE/%E5%8D%8F%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/">https://xing-cg.github.io/%E9%A1%B9%E7%9B%AE/%E5%8D%8F%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/</a></span></div></div><div class="post-share"><div class="social-share" data-sites="qzone, qq, weibo, wechat, douban, linkedin, facebook, twitter, google">Share to: </div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0/%E8%8B%B1%E8%AF%AD%E7%AC%94%E8%AE%B0_%E6%A6%82%E7%8E%87%E5%AF%BC%E8%AE%BA/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">英语笔记_概率导论</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%8D%8F%E7%A8%8B_Cpp%E5%8D%8F%E7%A8%8B%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/"><span class="paginator-prev__text">协程_Cpp协程简单实现</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="valine-container"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E5%AE%B9"><span class="toc-number">1.</span> <span class="toc-text">
           内容</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%9C%80%E6%B1%82%E5%8F%8A%E7%9B%AE%E6%A0%87"><span class="toc-number">2.</span> <span class="toc-text">
           项目需求及目标</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-number">3.</span> <span class="toc-text">
           开发环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E7%9B%AE%E5%BD%95"><span class="toc-number">3.1.</span> <span class="toc-text">
           工程目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cmakeliststxt%E7%BC%96%E5%86%99"><span class="toc-number">3.2.</span> <span class="toc-text">
           CMakeLists.txt编写</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#json%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.</span> <span class="toc-text">
           Json介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9Cio%E6%A8%A1%E5%9D%97"><span class="toc-number">5.</span> <span class="toc-text">
           网络IO模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#chatserver"><span class="toc-number">5.1.</span> <span class="toc-text">
           ChatServer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7"><span class="toc-number">5.1.1.</span> <span class="toc-text">
           成员属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0"><span class="toc-number">5.1.2.</span> <span class="toc-text">
           成员函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.1.3.</span> <span class="toc-text">
           代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reactor%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.2.</span> <span class="toc-text">
           Reactor模型</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9D%97"><span class="toc-number">6.</span> <span class="toc-text">
           业务模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9D%97%E4%B8%8E%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9D%97%E8%A7%A3%E8%80%A6-%E5%9B%9E%E8%B0%83"><span class="toc-number">6.1.</span> <span class="toc-text">
           业务模块与网络模块解耦 - 回调</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB%E5%9E%8B"><span class="toc-number">6.2.</span> <span class="toc-text">
           业务类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#chatservice"><span class="toc-number">6.3.</span> <span class="toc-text">
           ChatService</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E5%A4%84%E7%90%86"><span class="toc-number">6.3.1.</span> <span class="toc-text">
           前置处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%B1%9E%E6%80%A7-2"><span class="toc-number">6.3.2.</span> <span class="toc-text">
           成员属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0-2"><span class="toc-number">6.3.3.</span> <span class="toc-text">
           成员函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">6.3.4.</span> <span class="toc-text">
           代码实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9D%97"><span class="toc-number">7.</span> <span class="toc-text">
           数据模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9D%97%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9D%97%E8%A7%A3%E8%80%A6-orm%E6%A1%86%E6%9E%B6"><span class="toc-number">7.1.</span> <span class="toc-text">
           业务模块与数据模块解耦 - ORM框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAmysql%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8E%AF%E5%A2%83"><span class="toc-number">7.2.</span> <span class="toc-text">
           搭建MySQL数据库环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E7%B1%BB-%E5%B0%81%E8%A3%85mysql%E6%93%8D%E4%BD%9C"><span class="toc-number">7.3.</span> <span class="toc-text">
           MySQL类 - 封装MySQL操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="toc-number">7.3.1.</span> <span class="toc-text">
           成员变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0-3"><span class="toc-number">7.3.2.</span> <span class="toc-text">
           成员函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-3"><span class="toc-number">7.3.3.</span> <span class="toc-text">
           代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#model%E5%B1%82-%E5%AF%B9%E4%B8%9A%E5%8A%A1%E5%B1%82%E5%B0%81%E8%A3%85%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">7.4.</span> <span class="toc-text">
           Model层 - 对业务层封装底层数据库的操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#user%E7%B1%BB"><span class="toc-number">7.4.1.</span> <span class="toc-text">
           User类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#usermodel%E7%B1%BB"><span class="toc-number">7.4.2.</span> <span class="toc-text">
           UserModel类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-4"><span class="toc-number">7.4.2.1.</span> <span class="toc-text">
           代码实现</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">8.</span> <span class="toc-text">
           测试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A5%BD%E5%8F%8B%E4%B8%9A%E5%8A%A1"><span class="toc-number">9.</span> <span class="toc-text">
           好友业务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="toc-number">9.1.</span> <span class="toc-text">
           测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BE%A4%E7%BB%84%E4%B8%9A%E5%8A%A1"><span class="toc-number">10.</span> <span class="toc-text">
           群组业务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8"><span class="toc-number">10.1.</span> <span class="toc-text">
           表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#model"><span class="toc-number">10.2.</span> <span class="toc-text">
           model</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">11.</span> <span class="toc-text">
           负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%A8%A1%E5%9D%97"><span class="toc-number">11.1.</span> <span class="toc-text">
           nginx负载均衡模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">11.1.1.</span> <span class="toc-text">
           编译安装操作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">11.1.2.</span> <span class="toc-text">
           配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="toc-number">11.1.3.</span> <span class="toc-text">
           常用操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="toc-number">11.1.4.</span> <span class="toc-text">
           模型设计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E5%8A%A0%E9%AB%98%E5%B9%B6%E5%8F%91"><span class="toc-number">11.2.</span> <span class="toc-text">
           更加高并发?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%80%9A%E4%BF%A1"><span class="toc-number">12.</span> <span class="toc-text">
           跨服务器通信</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">12.1.</span> <span class="toc-text">
           Redis环境安装和配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis-cli%E6%B5%8B%E8%AF%95redis-server"><span class="toc-number">12.2.</span> <span class="toc-text">
           redis-cli测试redis-server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E8%AE%A2%E9%98%85%E5%8F%91%E5%B8%83"><span class="toc-number">12.3.</span> <span class="toc-text">
           Redis订阅&#x2F;发布</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E4%BA%8E%E6%9C%AC%E9%A1%B9%E7%9B%AE"><span class="toc-number">12.3.1.</span> <span class="toc-text">
           对应于本项目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%96%E7%A8%8B-%E5%B0%81%E8%A3%85%E4%B8%BAredis%E7%B1%BB"><span class="toc-number">12.4.</span> <span class="toc-text">
           redis发布-订阅的客户端编程 - 封装为Redis类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hiredis%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4"><span class="toc-number">12.4.1.</span> <span class="toc-text">
           hiredis安装步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F-2"><span class="toc-number">12.4.2.</span> <span class="toc-text">
           成员变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0-4"><span class="toc-number">12.4.3.</span> <span class="toc-text">
           成员函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-5"><span class="toc-number">12.4.4.</span> <span class="toc-text">
           代码实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#chatservice%E5%8A%A0%E5%85%A5redis%E7%BB%84%E4%BB%B6"><span class="toc-number">13.</span> <span class="toc-text">
           ChatService加入Redis组件</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/touxiang.png" alt="avatar"></div><p class="sidebar-ov-author__text">无论哪里，生活继续。</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/xing-cg" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://gitee.com/mrcan" target="_blank" rel="noopener" data-popover="social.gitee" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">Gitee</span></a><a class="sidebar-ov-social-item" href="https://www.zhihu.com/people/mrcan666" target="_blank" rel="noopener" data-popover="知乎" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-zhihu"></i></span></a><a class="sidebar-ov-social-item" href="tencent://message?uin=1933966629" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="mailto:xing-cg@qq.com" target="_blank" rel="noopener" data-popover="social.QQmail" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="far fa-envelope"></i></span></a><a class="sidebar-ov-social-item" href="https://blog.csdn.net/mrcan666" target="_blank" rel="noopener" data-popover="csdn" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">CSDN</span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">297</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">55</div><div class="sidebar-ov-state-item__name">分类</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2025</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Mr.Can All Rights Reserved</span><span class="footer__devider">|</span><span><a href="http://beian.miit.gov.cn/" target="_blank">京ICP备2025135168号</a></span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v7.3.0</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/npm/leancloud-storage@latest/dist/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><script>function loadValine () {
  var GUEST_INFO = ['nick', 'mail', 'link'];
  var guest_info = 'nick,mail,link';

  guest_info = guest_info.split(',').filter(function(item) {
    return GUEST_INFO.indexOf(item) > -1;
  });
  new Valine({
    el: '#valine-container',
    appId: 'QTXELGPwB2iKLovJroJUqbVP-gzGzoHsz',
    appKey: 'DDfRbL0aLE3KEHXtbNXHrlEQ',
    notify: true,
    verify: true,
    placeholder: '欢迎写下你的评论，同时欢迎留下你的昵称和邮箱！',
    avatar: 'mp',
    meta: guest_info,
    pageSize: '10' || 10,
    visitor: true,
    recordIP: true,
    lang: 'zh-cn' || 'zh-cn',
    path: window.location.pathname
  });
}

if (false) {
  loadValine();
} else {
  window.addEventListener('DOMContentLoaded', loadValine, false);
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>