---
title: 量化交易数据处理开发
categories:
  - - 量化交易
tags:
date: 2025/9/8
updated: 2025/9/8
comments:
published: false
---
futopt.csv.xz的内容：
ets: exchange timestamp
lts: local timestamp
ticker: 形如HO2509-C-2000的
cvolume:
camount: 
oi: 
last: 
askprc: 卖报价，一般高一些
askvol: 
bidprc: 买报价，一般低一些
bidvol: 

如果文件名指明了是IM2509.csv.xz，里面的ticker则默认全为它。没有这一列。


1秒2次timestamp，所以500ms一次。

要的结果：pdiff、ndiff的绝对值 大于 一个阈值，并持续一段时间，报警。最好用Cpp程序编写

这是一段可以参考的程序：

```cpp
        Array<double, Dynamic, 1> pdiff = (ecbps - epaps) + estrikes - fap_; //!< long fut, short opt (buy put sell call)
        Array<double, Dynamic, 1> ndiff = (ecaps - epbps) + estrikes - fbp_; //!< short fut, long opt (buy call sell put)

        // filter false-positive chance as option volumes too small to hedge even 1 hand of futures
        pdiff = (pdiff.isNaN() || ecbvs<ohands_ || epavs<ohands_ || estrikes<fap_).select(0, pdiff);
        ndiff = (ndiff.isNaN() || ecavs<ohands_ || epbvs<ohands_ || estrikes>fbp_).select(0, ndiff);

        LOG_INFO(gOutLogger, "pdiff: {}, ndiff: {}", pdiff.maxCoeff(), ndiff.minCoeff());

        ////TODO commission & order fee (1RMB per order)
        if (Index maxidx; flshr_<=0 && pdiff.maxCoeff(&maxidx) > thresh_)
        {
            LOG_WARNING(gOutLogger, "+F({}) -O({}: -C({}|{}) +P({}|{})) found! CrossSpread Profit({})!", fap_, strikes_[maxidx],
                        ecbps[maxidx], ecbvs[maxidx], epaps[maxidx], epavs[maxidx], pdiff[maxidx]);
            auto& order = orders_[(ordid_++) % kOrderNum];
            memset(&order, 0, sizeof(Order));
            PrepareOrder(order, epaps[maxidx], 1+ocalls_.size()+maxidx);//!< insert order for in-money put, and wait for filled
            const Event event = {Event::EventType::kOrderInsert, reinterpret_cast<std::byte*>(&order)};
            eventq_->TryPush(event);
        }

        if (Index minidx; fsshr_>=0 && ndiff.minCoeff(&minidx) < -thresh_)
        {////TODO might sign of fsshr
            LOG_WARNING(gOutLogger, "-F({}) +O({}: +C({}|{}) -P({}|{})) found! CrossSpread Profit({})!", fbp_, strikes_[minidx],
                        ecaps[minidx], ecavs[minidx], epbps[minidx], epbvs[minidx], ndiff[minidx]);
            auto& order = orders_[(ordid_++) % kOrderNum];
            memset(&order, 0, sizeof(Order));
            PrepareOrder(order, epaps[minidx], 1+minidx);//!< insert order for in-money call, and wait for filled
            const Event event = {Event::EventType::kOrderInsert, reinterpret_cast<std::byte*>(&order)};
            eventq_->TryPush(event);
        }
```



ecbps: 看涨期权的买报价：所有看涨期权合约的买报价组成的数组。
1. e代表类似于SIMD的加速技术（Eigen 库的向量化操作）
2. c代表ticker里面的中缀，`MO2509-[C/P]-XXXX`中间的C。call，代表涨期权
3. b代表bidprice，bidprc
4. p代表price
5. s代表复数

epaps: 看跌期权的卖报价：所有看跌期权合约的卖报价组成的数组。
1. e
2. p代表ticker里面的中缀，`MO2509-[C/P]-XXXX`中间的P。put，代表跌期权
3. a代表askprice，askprc
4. p代表price
5. s代表复数

ecaps: 看涨期权的卖报价
1. e
2. c: call
3. a: ask
4. p: price
5. s: 代表复数

epbps: 看跌期权的买报价
1. e
2. p: put
3. b: bid
4. p: price
5. s: 代表复数

estrikes: 所有期权合约的行权价组成的数组。
strike代表ticker后缀

fap: future ask price，fap 应该是 期货的买入价格（ask price），即期货的 askprc（askprc）。
fbp: future bid price，fbp 应该是 期货的卖出价格（bid price），即期货的 bidprc（bidprc）。

ecbvs: **E​**​igen数组，​**​C​**​all期权，​**​B​**​id ​**​V​**​olume (量)，对应`ecbps`价格上的买入量。

ohands: 期权手数阈值，用于过滤小成交量（避免无法对冲）

thresh: 套利阈值，由策略参数设定（例如，10 表示 10 个最小变动单位）

有2种情况：
1. 同一个时间戳，两个同时出现，直接相减
2. 同一个时间戳，一个出现，用出现的这个 和 未出现的上一个时间数据相减

​​pdiff策略 (Long Fut, Short Opt)​​: `(ecbps - epaps) + estrikes - fap_`
​​动作​​：卖出一个Call期权（收到权利金ecbps），买入一个Put期权（支付权利金epaps），同时买入期货（支付`fap_`）。
​​逻辑​​：如果这个组合的成本`(epaps - ecbps) + fap_`远低于行权价`estrikes`，就存在无风险套利空间。所以公式计算结果`pdiff`越大越好。
​​ndiff策略 (Short Fut, Long Opt)​​: `(ecaps - epbps) + estrikes - fbp_`
​​动作​​：买入一个Call期权（支付权利金ecaps），卖出一个Put期权（收到权利金epbps），同时卖出期货（收到`fbp_`）。
​​逻辑​​：如果这个组合的收入`(epbps - ecaps) + fbp_`远高于行权价`estrikes`，就存在无风险套利空间。所以公式计算结果`ndiff`越小（负得越多）越好。


一共发了3个文件：（截取部分）
1. futopt.csv.xz，内容是不同Ticker的报价信息，因为这些Ticker的条数比较稀疏，所以就写在了一个文件里。
2. IM2509.csv.xz，内容是只有IM2509这个Ticker的报价信息。
3. 20250905.0.csv，内容是有哪些Ticker。

内容分别为：
```csv
ets,lts,ticker,cvolume,camount,oi,last,askprc,askvol,bidprc,bidvol
20250905092900300,1757035740427646,HO2509-C-2000.CFFEX,0,0,82,886,926.8,1,870,1
20250905092900300,1757035740427648,HO2509-C-2050.CFFEX,0,0,29,860.6,876.6,1,819.8,1
20250905092900300,1757035740427649,HO2509-C-2100.CFFEX,0,0,22,790.2,826.6,1,769.8,1
20250905092900300,1757035740427650,HO2509-C-2150.CFFEX,0,0,30,744.2,776.8,1,720,1
20250905092900300,1757035740427652,HO2509-C-2200.CFFEX,0,0,38,688,726.8,1,670,1
20250905092900300,1757035740427653,HO2509-C-2250.CFFEX,0,0,24,644.6,677,1,620.2,1
20250905092900300,1757035740427654,HO2509-C-2300.CFFEX,0,0,28,585.4,627,1,570.2,1
20250905092900300,1757035740427655,HO2509-C-2350.CFFEX,0,0,44,530.4,577,1,520.2,1
20250905092900300,1757035740427656,HO2509-C-2400.CFFEX,0,0,91,508.4,513.4,1,484.4,1
20250905092900300,1757035740427657,HO2509-C-2425.CFFEX,0,0,37,481.2,488.6,1,459.6,1
20250905092900300,1757035740427658,HO2509-C-2450.CFFEX,0,0,70,430.8,463.4,1,434.4,1
```

```csv
ets,lts,cvolume,camount,oi,last,askprc,askvol,bidprc,bidvol
20250905092900300,1757035740327543,272,381964160,188932,7021.400000000001,7021.6,1,7021.4,3
20250905093000300,1757035800352536,334,469035360,188936,7022.8,7022.8,9,7021.8,2
20250905093000800,1757035800852808,457,641814560,188862,7022.8,7023,1,7022.8,12
20250905093001300,1757035801355591,515,723294680,188820,7026.6,7026.6,1,7025,1
20250905093001800,1757035801853825,594,834308000,188758,7026.6,7028,17,7026.2,1
20250905093002300,1757035802353855,652,915827320,188726,7026.6,7029,9,7026.6,6
20250905093002800,1757035802853893,696,977675920,188690,7028.2,7030,10,7028.6,1
20250905093003300,1757035803351431,751,1055008720,188662,7030.4,7033,2,7030.4,3
20250905093003800,1757035803853191,800,1123931880,188629,7033,7033.8,10,7033,4
20250905093004300,1757035804354019,870,1222382680,188580,7033,7033,11,7030,8
```

```csv
Ticker,ProductClass,DeliveryYear,DeliveryMonth,MaxMarketOrderVolume,MinMarketOrderVolume,MaxLimitOrderVolume,MinLimitOrderVolume,VolumeMultiple,PriceTick,CreateDate,OpenDate,ExpireDate,StartDelivDate,EndDelivDate,InstLifePhase,IsTrading,PositionDateType,LongMarginRatio,ShortMarginRatio,MaxMarginSideAlgorithm,ExchangeInstID,ProductID,StrikePrice,OptionType
AP2510.CZCE,1,2025,10,200,1,1000,1,10,1,20241022,20241022,20251022,,,1,1,2,0.1,0.1,0,AP510,AP,0,^@
AP2511.CZCE,1,2025,11,200,1,1000,1,10,1,20241115,20241115,20251114,,,1,1,2,0.1,0.1,0,AP511,AP,0,^@
AP2511C6300.CZCE,2,2025,9,2,1,100,1,10,0.5,20250611,20250611,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C6300,APC,6300,1
AP2511C6400.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C6400,APC,6400,1
AP2511C6500.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C6500,APC,6500,1
AP2511C6600.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C6600,APC,6600,1
AP2511C6700.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C6700,APC,6700,1
AP2511C6800.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C6800,APC,6800,1
AP2511C6900.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C6900,APC,6900,1
AP2511C7000.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C7000,APC,7000,1
AP2511C7100.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C7100,APC,7100,1
AP2511C7200.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C7200,APC,7200,1
AP2511C7300.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C7300,APC,7300,1
AP2511C7400.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C7400,APC,7400,1
AP2511C7500.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C7500,APC,7500,1
AP2511C7600.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C7600,APC,7600,1
AP2511C7700.CZCE,2,2025,9,2,1,100,1,10,0.5,20250328,20250328,20250926,20250926,20250926,1,1,2,nan,nan,0,AP511C7700,APC,7700,1
```


在 futopt.csv 中，Ticker 和 Timestamp 都有可能是重复的，因此我们需要找到一个合适的方式来唯一地标识每一行数据。在这种情况下，可以通过组合 Ticker 和 Timestamp 作为唯一的键（key）来构建映射。

方案：

复合键（Ticker + Timestamp）：

通过将 Ticker 和 Timestamp 结合起来，作为映射的键（key），确保每一行数据都是唯一的。

这样，tickerMap 可以使用 std::unordered_map<std::pair<std::string, long long>, DataRow> 这样的结构，其中 std::pair<std::string, long long> 表示 Ticker 和 Timestamp 的组合。

std::unordered_map<std::pair<std::string, long long>, DataRow>：

std::pair<std::string, long long> 是键类型，表示 Ticker 和 Timestamp 组合，DataRow 是值类型。