<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta property="og:type" content="website">
<meta property="og:title" content="罐头先生的博客">
<meta property="og:url" content="https://xing-cg.github.io/page/49/index.html">
<meta property="og:site_name" content="罐头先生的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Mr.Can">
<meta name="twitter:card" content="summary"><title>罐头先生的博客</title><link ref="canonical" href="https://xing-cg.github.io/page/49/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">罐头先生的博客</div><div class="header-banner-info__subtitle">Mr.Can</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%8D%8F%E7%A8%8B_Cpp%E5%8D%8F%E7%A8%8B%E6%A1%86%E6%9E%B6%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/">协程_Cpp协程框架简单实现</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-05-18</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2025-09-09</span></span><span class="post-meta-item post-meta-item--visitors leancloud_visitors" id="/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%8D%8F%E7%A8%8B_Cpp%E5%8D%8F%E7%A8%8B%E6%A1%86%E6%9E%B6%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/" data-flag-title="协程_Cpp协程框架简单实现"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value leancloud-visitors-count"></span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="进程-线程-协程的对比"   >
          <a href="#进程-线程-协程的对比" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#进程-线程-协程的对比"></a> 进程、线程、协程的对比</h1>
      
<div class="table-container"><table>
<thead>
<tr>
<th></th>
<th>进程</th>
<th>线程</th>
<th>协程</th>
</tr>
</thead>
<tbody>
<tr>
<td>切换者</td>
<td>操作系统</td>
<td>操作系统</td>
<td>用户</td>
</tr>
<tr>
<td>切换时机</td>
<td>根据操作系统的调度策略，对用户透明</td>
<td>根据操作系统的调度策略，对用户透明</td>
<td>用户自己决定</td>
</tr>
<tr>
<td>切换内容</td>
<td>1、页全局目录；2、内核栈；3、硬件上下文</td>
<td>1、内核栈；2、硬件上下文</td>
<td>硬件上下文</td>
</tr>
<tr>
<td>切换内容的保存</td>
<td>保存于内核栈中</td>
<td>保存于内核栈中</td>
<td>保存于用户自己的变量（用户栈/堆）</td>
</tr>
<tr>
<td>切换过程</td>
<td>用户态-&gt;内核态-&gt;用户态</td>
<td>用户态-&gt;内核态-&gt;用户态</td>
<td>用户态</td>
</tr>
</tbody>
</table></div>
<p>硬件上下文可以在网上查阅资料。</p>

        <h2 id="协程的优缺点"   >
          <a href="#协程的优缺点" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#协程的优缺点"></a> 协程的优缺点</h2>
      
<ol>
<li>IO阻塞时，协程的切换效率比较高</li>
<li>不需要锁机制。实际上，创建了大量的协程之后，它们是按顺序执行的，不存在竞争关系。</li>
</ol>
<p>但是不能利用多核CPU。</p>

        <h1 id="如何实现协程"   >
          <a href="#如何实现协程" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#如何实现协程"></a> 如何实现协程</h1>
      
<p>利用操作系统提供的接口来实现协程。</p>
<ol>
<li>Linux的ucontext</li>
<li>Windows的Fiber</li>
</ol>

        <h2 id="ucontext_t结构"   >
          <a href="#ucontext_t结构" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#ucontext_t结构"></a> <code>ucontext_t</code>结构</h2>
      
<p>根据UNIX环境高级编程第三版280页。<code>ucontext_t</code>被用作标识进程的上下文信息。该结构至少包含下列字段：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ucontext_t</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ucontext_t</span> * uc_link; <span class="comment">//pointer to context resumed when this context returns</span></span><br><span class="line">    <span class="type">stack_t</span> uc_stack;     <span class="comment">//stack used by this context</span></span><br><span class="line">    <span class="type">mcontext_t</span> uc_mcontext;<span class="comment">//machine-specific representation of saved context</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>uc_stack</code>字段描述了当前上下文使用的栈，至少包括下列成员：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">uc_stack</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> * ss_sp;   <span class="comment">//stack base or pointer</span></span><br><span class="line">    <span class="type">size_t</span> ss_size; <span class="comment">//stack size</span></span><br><span class="line">    <span class="type">int</span> ss_flags;   <span class="comment">//flags</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="ucontext提供的四个接口"   >
          <a href="#ucontext提供的四个接口" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#ucontext提供的四个接口"></a> ucontext提供的四个接口</h2>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">getcontext</span><span class="params">(<span class="type">ucontext_t</span> *ucp)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">setcontext</span><span class="params">(<span class="type">const</span> <span class="type">ucontext_t</span> *ucp)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">makecontext</span><span class="params">(<span class="type">ucontext_t</span> *ucp, (<span class="type">void</span> *func)(), <span class="type">int</span> argc, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">swapcontext</span><span class="params">(<span class="type">ucontext_t</span> *oucp, <span class="type">const</span> <span class="type">ucontext_t</span> *ucp)</span></span>;<span class="comment">//保存oucp, 换到ucp</span></span><br></pre></td></tr></table></div></figure>
<ol>
<li>getcontext: 保存上下文，将当前运行到的寄存器的信息保存到<code>ucontext_t</code>结构体中。</li>
<li>setcontext: 恢复上下文，将<code>ucontext_t</code>结构体变量中的上下文信息重新恢复到CPU中并执行。</li>
<li>makecontext: 修改上下文，给<code>ucontext_t</code>上下文指定一个程序入口函数，让程序从该入口函数中开始执行。</li>
<li>swapcontext: 切换上下文，保存当前上下文，并将下一个要执行的上下文恢复到CPU中。</li>
</ol>

        <h2 id="ucontext简单的使用示例"   >
          <a href="#ucontext简单的使用示例" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#ucontext简单的使用示例"></a> ucontext简单的使用示例</h2>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;ucontext.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">ucontext_t</span> ctx;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">getcontext</span>(&amp;ctx);        <span class="comment">//获取当前上下文</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;i = %d\n&quot;</span>, i++);</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">setcontext</span>(&amp;ctx);        <span class="comment">//恢复上下文</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h1 id="协程框架设计"   >
          <a href="#协程框架设计" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#协程框架设计"></a> 协程框架设计</h1>
      

        <h2 id="协程类"   >
          <a href="#协程类" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#协程类"></a> 协程类</h2>
      
<p>三个状态：就绪态、运行态、挂起态。</p>
<p>成员：</p>
<ol>
<li>上下文<code>m_ctx</code></li>
<li>状态<code>m_status</code></li>
<li>栈空间指针<code>m_stack</code>，及栈空间大小<code>m_stack_size</code></li>
</ol>
<p>成员方法：</p>
<ol>
<li>run：纯虚函数，需要子类来实现协程的具体业务逻辑</li>
<li>resume：继续执行已经挂起的线程。</li>
<li>yield：当前协程“放弃”执行，让调度器调度另一协程继续执行。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Routine</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Status</span> &#123; RT_READY = <span class="number">0</span>, RT_RUNNING, RT_SUSPEND &#125;;</span><br><span class="line">    <span class="built_in">Routine</span>();</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Routine</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">run</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">resume</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">yield</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">status</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">func</span><span class="params">(<span class="type">void</span> * ptr)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">ucontext_t</span> m_ctx;</span><br><span class="line">    <span class="type">int</span> m_status;</span><br><span class="line">    <span class="type">char</span> * m_stack;</span><br><span class="line">    <span class="type">int</span> m_stack_size;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<p>默认无参构造函数不分配栈空间，只有yield时才分配。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Routine::<span class="built_in">Routine</span>() : <span class="built_in">m_status</span>(RT_READY), <span class="built_in">m_stack</span>(<span class="literal">nullptr</span>), <span class="built_in">m_stack_size</span>(<span class="number">0</span>)</span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="yield实现"   >
          <a href="#yield实现" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#yield实现"></a> yield实现</h3>
      
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意：yield一般是在run方法中最后一句话中主动调用的。而run方法是在用户指定的m_ctx中执行的，所以，yield中定义的变量地址也是处于m_ctx指定的栈空间中分配的。</span><br></pre></td></tr></table></div></figure>
<p>主要的工作是：</p>
<ol>
<li>把协程栈中的内容复制保存到<code>m_stack</code>中存储。<strong>利用了一个dummy变量，探测协程栈实际使用了的边界地址（最低地址，栈的增长方向是从高到低）。</strong></li>
</ol>
<p>其他的工作：</p>
<ol start="2">
<li>把自身放入到调度器中的任务队列中；</li>
<li>调用swapcontext。保存<code>m_ctx</code>上下文，切换到<code>s-&gt;m_main</code>上下文。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Routine::yield</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> s = Singleton&lt;Schedule&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    <span class="type">char</span> dummy = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">assert</span>(s-&gt;m_stack + s-&gt;m_stack_size - &amp;dummy &lt;= s-&gt;m_stack_size);</span><br><span class="line">    <span class="keyword">if</span>(m_stack_size &lt; s-&gt;m_stack + s-&gt;m_stack_size - &amp;dummy)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> [] m_stack;</span><br><span class="line">        m_stack_size = s-&gt;m_stack + s-&gt;m_stack_size - &amp;dummy;</span><br><span class="line">        m_stack = <span class="keyword">new</span> <span class="type">char</span>[m_stack_size];</span><br><span class="line">    &#125;</span><br><span class="line">    std::<span class="built_in">memcpy</span>(m_stack, &amp;dummy, m_stack_size);</span><br><span class="line">    m_status = RT_SUSPEND;</span><br><span class="line">    s-&gt;<span class="built_in">append</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">swapcontext</span>(&amp;m_ctx, &amp;s-&gt;m_main);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="resume实现"   >
          <a href="#resume实现" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#resume实现"></a> resume实现</h3>
      
<p>通常是Schedule单例对象来从其任务队列中出队一个Routine，并调用该routine的resume方法。</p>
<p>挂起状态：</p>
<ol>
<li>把<code>m_stack</code>中保存的内容复制到<code>s-&gt;m_stack + s-&gt;m_stack_size - m_stack_size</code>的位置，即从<code>s-&gt;m_stack</code>位置开始正好存储<code>m_stack_size</code>。</li>
<li>调用<code>swapcontext</code>，保存<code>s-&gt;m_main</code>上下文，切换到<code>m_ctx</code>上下文。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> RT_SUSPEND:</span><br><span class="line">    std::<span class="built_in">memcpy</span>(s-&gt;m_stack + s-&gt;m_stack_size - m_stack_size, m_stack, m_stack_size);<span class="comment">// dest src size</span></span><br><span class="line">    m_status = RT_RUNNING;</span><br><span class="line">    <span class="built_in">swapcontext</span>(&amp;s-&gt;m_main, &amp;m_ctx);</span><br></pre></td></tr></table></div></figure>
<p>准备状态：</p>
<ol>
<li>getcontext将当前运行到的寄存器的信息保存到<code>ucontext_t</code>结构体中。</li>
<li>设置<code>m_ctx</code>的栈空间，用<code>m_ctx.uc_stack.ss_sp</code>指定，此时我们使用调度器s的共享栈空间。</li>
<li><code>m_ctx.uc_link</code>，表示pointer to context resumed when this context returns。指向<code>s-&gt;m_main</code>。</li>
<li>调用makecontext，指定其运行func函数，参数为1个，即this指针，并且指定其在<code>m_ctx</code>上下文中执行。</li>
<li>调用swapcontext，保存<code>s-&gt;main</code>上下文，切换到<code>m_ctx</code>上下文。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> RT_READY:</span><br><span class="line">    <span class="built_in">getcontext</span>(&amp;m_ctx);</span><br><span class="line">    m_ctx.uc_stack.ss_sp = s-&gt;m_stack;</span><br><span class="line">    m_ctx.uc_stack.ss_size = s-&gt;m_stack_size;</span><br><span class="line">    m_ctx.uc_link = &amp;s-&gt;m_main;</span><br><span class="line">    m_status = RT_RUNNING;</span><br><span class="line">    <span class="built_in">makecontext</span>(&amp;m_ctx, (<span class="built_in">void</span> (*)(<span class="type">void</span>))Routine::func, <span class="number">1</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">swapcontext</span>(&amp;s-&gt;m_main, &amp;m_ctx);</span><br></pre></td></tr></table></div></figure>
<p>以上代码的目的：指定协程使用s的公共栈。并且指定协程执行完毕回到调度器。</p>

        <h3 id="实例"   >
          <a href="#实例" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#实例"></a> 实例</h3>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;routine/routine.h&gt;</span> </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> xcg::routine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ARouine</span> : <span class="keyword">public</span> Routine</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ARoutine</span>(<span class="type">int</span> * num) : <span class="built_in">Routine</span>(), <span class="built_in">m_num</span>(num) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">ARoutine</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(m_num != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">delete</span> m_num;</span><br><span class="line">            m_num = <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span> overide</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; *m_num; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;a run: num=&quot;</span> &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">            <span class="built_in">yield</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> * m_num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>main</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;routine/schedule.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> xcg::routine;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;test/a_routine.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;test/b_routine.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Logger::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./main.log&quot;</span>);</span><br><span class="line">    Logger::<span class="built_in">instance</span>()-&gt;<span class="built_in">console</span>(<span class="literal">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> s = Singleton&lt;Schedule&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    s-&gt;<span class="built_in">create</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> * num1 = <span class="keyword">new</span> <span class="type">int</span>;</span><br><span class="line">    *num1 = <span class="number">5</span>;</span><br><span class="line">    Routine * a = <span class="keyword">new</span> <span class="built_in">ARoutine</span>(num1);</span><br><span class="line">    s-&gt;<span class="built_in">append</span>(a);</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> * num2 = <span class="keyword">new</span> <span class="type">int</span>;</span><br><span class="line">    *num2 = <span class="number">10</span>;</span><br><span class="line">    Routine * b = <span class="keyword">new</span> <span class="built_in">BRoutine</span>(num2);</span><br><span class="line">    s-&gt;<span class="built_in">append</span>(b);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(!s-&gt;<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;main run&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        s-&gt;<span class="built_in">resume</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
      
<p>总而言之，协程在不断地进行yield、resume。在准备/挂起、运行态中不断切换。更进一步说，本质上就是<code>swapcontext(&amp;s-&gt;m_main, &amp;m_ctx);</code>和<code>swapcontext(&amp;m_ctx, &amp;s-&gt;m_main);</code>的不断调用。</p>

        <h2 id="调度器schedule"   >
          <a href="#调度器schedule" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#调度器schedule"></a> 调度器Schedule</h2>
      
<p>成员：</p>
<ol>
<li>记录上下文的变量<code>m_main</code></li>
<li>栈指针<code>m_stack</code>，及栈大小<code>m_stack_size</code></li>
<li>任务队列<code>m_queue</code>，用list存放协程指针</li>
</ol>
<p>成员方法：</p>
<ol>
<li>create：初始化协程调度器</li>
<li>append：添加一个新协程到队列</li>
<li>resume：唤醒队列里某个协程执行</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Schedule</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Routine</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Schedule</span>();</span><br><span class="line">    ~<span class="built_in">Schedule</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">create</span><span class="params">(<span class="type">int</span> stack_size = <span class="number">1024</span> * <span class="number">1024</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">append</span><span class="params">(Routine * c)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">resume</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">ucontext_t</span> m_main;</span><br><span class="line">    <span class="type">char</span> * m_stack;</span><br><span class="line">    <span class="type">int</span> m_stack_size;</span><br><span class="line">    std::list&lt;Routine *&gt; m_queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="创建实现"   >
          <a href="#创建实现" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#创建实现"></a> 创建实现</h3>
      
<p>使用<code>new char[]</code>创建一个栈，并初始化为0。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Schedule::create</span><span class="params">(<span class="type">int</span> stack_size)</span><span class="comment">//默认1024*1024</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_stack_size = stack_size;</span><br><span class="line">    m_stack = <span class="keyword">new</span> <span class="type">char</span>[stack_size];</span><br><span class="line">    std::<span class="built_in">memset</span>(m_stack, <span class="number">0</span>, stack_size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="析构实现"   >
          <a href="#析构实现" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#析构实现"></a> 析构实现</h3>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Schedule::~<span class="built_in">Schedule</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it : m_queue)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> it;</span><br><span class="line">    &#125;</span><br><span class="line">    m_queue.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="keyword">if</span> (m_stack != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> [] m_stack;</span><br><span class="line">        m_stack_size = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="入队实现"   >
          <a href="#入队实现" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#入队实现"></a> 入队实现</h3>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Schedule::append</span><span class="params">(Routine * c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_queue.<span class="built_in">push_back</span>(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="resume实现-2"   >
          <a href="#resume实现-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#resume实现-2"></a> resume实现</h3>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Schedule::resume</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_queue.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> c = queue.<span class="built_in">front</span>();</span><br><span class="line">    m_queue.<span class="built_in">pop_front</span>();</span><br><span class="line">    c-&gt;<span class="built_in">resume</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h1 id="基于协程的c异步网络框架"   >
          <a href="#基于协程的c异步网络框架" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#基于协程的c异步网络框架"></a> 基于协程的C++异步网络框架</h1>
      

        <h2 id="server"   >
          <a href="#server" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#server"></a> Server</h2>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/system.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/logger.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/ini_file.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/singleton.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> xcg::utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> xcg&#123;</span><br><span class="line"><span class="keyword">namespace</span> frame&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Server</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Server</span>();</span><br><span class="line">    ~<span class="built_in">Server</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_connects</span><span class="params">(<span class="type">int</span> connects)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    string m_ip;</span><br><span class="line">    <span class="type">int</span> m_port;</span><br><span class="line">    <span class="type">int</span> m_connects;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="构造函数"   >
          <a href="#构造函数" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#构造函数"></a> 构造函数</h3>
      
<ol>
<li>按照配置文件初始化Server类成员的ip和端口信息；</li>
<li>初始化日志模块</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Server::<span class="built_in">Server</span>() : <span class="built_in">m_connects</span>(<span class="number">1024</span>)</span><br><span class="line">&#123;</span><br><span class="line">    System * sys = Singleton&lt;System&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    sys-&gt;<span class="built_in">init</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// init inifile</span></span><br><span class="line">    Inifile * ini = Singleton&lt;IniFile&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    ini-&gt;<span class="built_in">load</span>(sys-&gt;<span class="built_in">get_root_path</span>() + <span class="string">&quot;/config/server.ini&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    m_ip = (string)(*ini)[<span class="string">&quot;server&quot;</span>][<span class="string">&quot;ip&quot;</span>];</span><br><span class="line">    m_port = (*ini)[<span class="string">&quot;Server&quot;</span>][<span class="string">&quot;port&quot;</span>];</span><br><span class="line">    m_connects = (*ini)[<span class="string">&quot;server&quot;</span>][<span class="string">&quot;max_conn&quot;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> level = (*ini)[<span class="string">&quot;server&quot;</span>][<span class="string">&quot;log_level&quot;</span>];</span><br><span class="line">    <span class="type">bool</span> console = (*ini)[<span class="string">&quot;server&quot;</span>][<span class="string">&quot;log_console&quot;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// init logger</span></span><br><span class="line">    Logger::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(sys-&gt;<span class="built_in">get_root_path</span>() + <span class="string">&quot;/log/server.log&quot;</span>);</span><br><span class="line">    Logger::<span class="built_in">instance</span>()-&gt;<span class="built_in">level</span>(level);</span><br><span class="line">    Logger::<span class="built_in">instance</span>()-&gt;<span class="built_in">console</span>(console);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="启动函数"   >
          <a href="#启动函数" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#启动函数"></a> 启动函数</h3>
      
<ol>
<li>启动、初始化socket连接池</li>
<li>启动调度器</li>
<li>用<code>m_ip, m_port</code>构造ServerSocket</li>
<li>用封装好的ServerSocket构造ServerRoutine，然后把ServerRoutine加入到调度器的任务队列中。</li>
<li>resume任务队列中的协程。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Server::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;ObjectPool&lt;Socket&gt;&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">init</span>(m_connects);</span><br><span class="line">    <span class="keyword">auto</span> s = Singleton&lt;Schedule&gt;::<span class="built_in">instance</span>();<span class="comment">//调度器</span></span><br><span class="line">    s-&gt;<span class="built_in">create</span>();                             <span class="comment">//创建第一个协程，服务协程</span></span><br><span class="line">    s-&gt;<span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">ServerRoutine</span>(<span class="keyword">new</span> <span class="built_in">ServerSocket</span>(m_ip, m_port)));</span><br><span class="line">    <span class="keyword">while</span>(!s-&gt;<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        s-&gt;<span class="built_in">resume</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="服务协程"   >
          <a href="#服务协程" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#服务协程"></a> 服务协程</h2>
      
<ol>
<li>监听和建立客户端的连接</li>
<li>当客户端没有新连接时立刻让出CPU，切换到下一个协程。</li>
<li>当客户端有新连接时，给对应的连接新建一个client routine。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pargma once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cerrno&gt;</span></span></span><br><span class="line"><span class="meta">#inlcude<span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> xcg::socket;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;routine/routine.h&gt;</span></span></span><br><span class="line"><span class="meta">#inlcude<span class="string">&lt;routine/schedule.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> xcg::routine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> xcg</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">namespace</span> async</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerRoutine</span> : <span class="keyword">public</span> Routine</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ServerRoutine</span>(Socket * socket);</span><br><span class="line">    ~<span class="built_in">ServerRoutine</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Socket * m_socket;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;async/server_routine.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;async/client_routine.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> xcg::async;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;utility/singleton.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;utility/object_pool.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> xcg::utility;</span><br><span class="line"></span><br><span class="line">ServerRoutine::<span class="built_in">ServerRoutine</span>(Socket * socket) : <span class="built_in">Routine</span>(), <span class="built_in">m_socket</span>(socket)</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line">ServerRoutine::~<span class="built_in">ServerRoutine</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_socket != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> m_socket;</span><br><span class="line">        m_socket = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ServerRoutine::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Server routine run&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> sockfd = m_socket-&gt;<span class="built_in">accept</span>();</span><br><span class="line">        <span class="keyword">if</span>(sockfd &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;server accept would block: sockfd=%d errno=%d error=%s&quot;</span>, sockfd, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="built_in">yield</span>();                     <span class="comment">//没有新连接，让出CPU</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//有有效连接</span></span><br><span class="line">        &#123;</span><br><span class="line">            Socket * socket = <span class="literal">nullptr</span>;</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>)<span class="comment">//如果连接池无资源则一直卡住申请</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//ObjectPool为连接池，从连接池中取一个资源给socket。</span></span><br><span class="line">                socket = Singleton&lt;ObjectPool&lt;Socket&gt;&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">allocate</span>();</span><br><span class="line">                <span class="keyword">if</span>(socket != <span class="literal">nullptr</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">log_error</span>(<span class="string">&quot;socket pool is empty&quot;</span>);</span><br><span class="line">                <span class="built_in">yield</span>();                <span class="comment">//连接池已满，让出CPU</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 有效连接并且申请得到资源 后的操作</span></span><br><span class="line">            socket-&gt;m_sockfd = sockfd;</span><br><span class="line">            socket-&gt;<span class="built_in">set_non_blocking</span>(); <span class="comment">//套接字设置为非阻塞的</span></span><br><span class="line">            <span class="comment">//新建一个Client Routine，添加到调度器队列。</span></span><br><span class="line">            Singleton&lt;Schedule&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">append</span>(<span class="keyword">new</span> <span class="built_in">ClientRoutine</span>(socket));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="客户端协程"   >
          <a href="#客户端协程" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#客户端协程"></a> 客户端协程</h2>
      
<ol>
<li>当客户端没有数据到达，让出CPU，切换到下一个协程。</li>
<li>当客户端有数据到达，立刻处理；</li>
<li>当客户端关闭连接，协程自动销毁。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> xcg::socket;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;routine/routine.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> xcg::routine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> xcg&#123;</span><br><span class="line"><span class="keyword">namespace</span> async&#123;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientRoutine</span> : <span class="keyword">public</span> Routine</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ClientRoutine</span>(Socket * socket);</span><br><span class="line">    ~<span class="built_in">ClientRoutine</span>();</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Socket * m_socket;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;async/client_routine.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> xcg::async;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;utility/singleton.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;utility/object_pool.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> xcg::utility;</span><br><span class="line"></span><br><span class="line">ClientRoutine::<span class="built_in">ClientRoutine</span>(Socket * socket) : <span class="built_in">Routine</span>(), <span class="built_in">m_socket</span>(socket)</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line">ClientRoutine::~<span class="built_in">ClientRoutine</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_socket != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Singleton&lt;ObjectPool&lt;Socket&gt;&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">release</span>(m_socket);</span><br><span class="line">        m_socket = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClientRoutine::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;client routine run&quot;</span>);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::<span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line">        <span class="comment">//socket已经在创建时设置为非阻塞模式，返回值有三种情况:0 -&gt;closed &lt;0 -&gt;此时没数据到达 &gt;0 -&gt;有数据到达</span></span><br><span class="line">        <span class="type">int</span> len = m_socket-&gt;<span class="built_in">recv</span>(buf, <span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">if</span>(len == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_info</span>(<span class="string">&quot;socket closed by peer&quot;</span>);</span><br><span class="line">            m_socket-&gt;<span class="built_in">close</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(len &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;socket recv would block: len=%d, errno=%d, error=%s&quot;</span>, len, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="built_in">yield</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_info</span>(<span class="string">&quot;socket recv: len=%d data=%s&quot;</span>, len, buf);</span><br><span class="line">            m_socket-&gt;<span class="built_in">send</span>(buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">            <span class="built_in">yield</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="入口函数"   >
          <a href="#入口函数" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#入口函数"></a> 入口函数</h2>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;frame/server.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> xcg::frame;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Server * server = Singleton&lt;Server&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    server-&gt;<span class="built_in">listen</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line">    server-&gt;<span class="built_in">start</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h1 id="基于协程网络框架的聊天服务器"   >
          <a href="#基于协程网络框架的聊天服务器" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#基于协程网络框架的聊天服务器"></a> 基于协程网络框架的聊天服务器</h1>
      

        <h2 id="封装一个tcpserver类"   >
          <a href="#封装一个tcpserver类" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#封装一个tcpserver类"></a> 封装一个TcpServer类</h2>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TcpServer</span> : noncopyable</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> ThreadInitCallback = std::function&lt;<span class="built_in">void</span>(EventLoop*)&gt;;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TcpServer</span>(EventLoop *loop, <span class="type">const</span> InetAddress &amp;listenAddr,</span><br><span class="line">              <span class="type">const</span> std::string &amp;nameArg, Option option = kNoReusePort);</span><br><span class="line">    ~<span class="built_in">TcpServer</span>();</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setThreadInitCallback</span><span class="params">(<span class="type">const</span> ThreadInitCallback &amp;cb)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_threadInitCallback = cb;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setConnectionCallback</span><span class="params">(<span class="type">const</span> ConnectionCallback &amp;cb)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_connectionCallback = cb;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setMessageCallback</span><span class="params">(<span class="type">const</span> MessageCallback &amp;cb)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_messageCallback = cb;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setWriteCompleteCallback</span><span class="params">(<span class="type">const</span> WriteCompleteCallback &amp;cb)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_writeCompleteCallback = cb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 设置底层subLoop个数 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setThreadNum</span><span class="params">(<span class="type">int</span> numThreads)</span></span>;</span><br><span class="line">    <span class="comment">/* 开启服务器监听 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">newConnection</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> InetAddress &amp; peerAddr)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">removeConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp; conn)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">removeConnectionInLoop</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp; conn)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ConnectionCallback      m_connectionCallback;   <span class="comment">//新连接时的回调</span></span><br><span class="line">    MessageCallback         m_;      <span class="comment">//有读写消息时的回调</span></span><br><span class="line">    WriteCompleteCallback   m_writeCompleteCallback;<span class="comment">//消息发送完成后的回调</span></span><br><span class="line">    ThreadInitCallback      m_threadInitCallback;   <span class="comment">//loop线程初始化的回调</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">using</span> ConnectionMap = std::unordered_map&lt;std::string, TcpConnectionPtr&gt;;</span><br><span class="line">    ConnectionMap m_connections;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::atomic_int m_started;</span><br><span class="line">    <span class="type">int</span> m_nextConnId;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 有新客户端连接时, acceptor会执行这个回调操作; </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TcpServer::newConnection</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> InetAddress &amp;peerAddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    EventLoop *ioLoop = m_threadPool-&gt;<span class="built_in">getNextLoop</span>();</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span> buf, <span class="string">&quot;-%s#%d&quot;</span>, m_IPport.<span class="built_in">c_str</span>(), m_nextConnId);</span><br><span class="line">    ++m_nextConnId;</span><br><span class="line">    std::string connName = m_name + buf;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s [%s] - new connection [%s] from %s\n&quot;</span>,</span><br><span class="line">             __FUNCTION__, m_name.<span class="built_in">c_str</span>(), connName.<span class="built_in">c_str</span>(), peerAddr.<span class="built_in">toIPport</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通过sockfd获取其绑定的ip地址和端口信息</span></span><br><span class="line">    sockaddr_in local;</span><br><span class="line">    <span class="built_in">bzero</span>(&amp;local, <span class="keyword">sizeof</span> local);</span><br><span class="line">    <span class="type">socklen_t</span> addrlen = <span class="keyword">sizeof</span> local;</span><br><span class="line">    <span class="keyword">if</span>(::<span class="built_in">getsockname</span>(sockfd, (sockaddr*)&amp;local, &amp;addrlen) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;socket::getsockname\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">InetAddress <span class="title">localAddr</span><span class="params">(local)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据连接成功的sockfd, 创建TcpConnection连接对象</span></span><br><span class="line">    <span class="function">TcpConnectionPtr <span class="title">conn</span><span class="params">(std::make_shared&lt;TcpConnection&gt;</span></span></span><br><span class="line"><span class="params"><span class="function">        (ioLoop, connName, sockfd, localAddr, peerAddr))</span></span>;</span><br><span class="line">    m_connections[connName] = conn;</span><br><span class="line">    <span class="comment">//下面的回调是用户给TcpServer设置的</span></span><br><span class="line">    conn-&gt;<span class="built_in">setConnectionCallback</span>(m_connectionCallback);</span><br><span class="line">    conn-&gt;<span class="built_in">setMessageCallback</span>(m_messageCallback);</span><br><span class="line">    conn-&gt;<span class="built_in">setWriteCompleteCallback</span>(m_writeCompleteCallback);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置如何关闭连接 - 用户调用conn-&gt;shutdown() 时回调</span></span><br><span class="line">    conn-&gt;<span class="built_in">setCloseCallback</span>(std::<span class="built_in">bind</span>(&amp;TcpServer::removeConnection, <span class="keyword">this</span>, _1));</span><br><span class="line">    <span class="comment">//直接调用TcpConnection::connectEstablished, 把state置为connected, channel tie操作, enableReading;</span></span><br><span class="line">    ioLoop-&gt;<span class="built_in">runInLoop</span>(std::<span class="built_in">bind</span>(&amp;TcpConnection::connectEstablished, conn));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="tcpconnection"   >
          <a href="#tcpconnection" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#tcpconnection"></a> TcpConnection</h2>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;noncopyable.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;inetaddress.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;buffer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;callbacks.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventLoop</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Socket</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Channel</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TcpConnection</span> : noncopyable,</span><br><span class="line">               <span class="keyword">public</span> std::enable_shared_from_this&lt;TcpConnection&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">StateE</span>&#123;</span><br><span class="line">        kDisconnected, kConnecting, kConnected, kDisconnecting</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">TcpConnection</span>(EventLoop *loop, <span class="type">const</span> std::string&amp; name, <span class="type">int</span> sockfd,</span><br><span class="line">                  <span class="type">const</span> InetAddress&amp; localAddr, <span class="type">const</span> InetAddress&amp; peerAddr);</span><br><span class="line">    ~<span class="built_in">TcpConnection</span>();</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">connectEstablished</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">connectDestoryed</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 关闭连接 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setConnectionCallback</span><span class="params">(<span class="type">const</span> ConnectionCallback &amp; cb)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_connectionCallback = cb;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setMessageCallback</span><span class="params">(<span class="type">const</span> MessageCallback &amp; cb)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_messageCallback = cb;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setWriteCompleteCallback</span><span class="params">(<span class="type">const</span> WriteCompleteCallback &amp; cb)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_writeCompleteCallback = cb;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setCloseCallback</span><span class="params">(<span class="type">const</span> CloseCallback &amp;cb)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_closeCallback = cb;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setHighWaterMarkCallback</span><span class="params">(<span class="type">const</span> HighWaterMarkCallback &amp; cb, <span class="type">size_t</span> highWaterMark)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_highWaterMarkCallback = cb;</span><br><span class="line">        m_highWaterMark = highWaterMark;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">connected</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> m_state == kConnected;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setState</span><span class="params">(StateE state)</span> </span>&#123;m_state = state;&#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">EventLoop * <span class="title">getLoop</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> m_loop;&#125;</span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> m_name;&#125;</span><br><span class="line">    <span class="function"><span class="type">const</span> InetAddress&amp; <span class="title">localAddress</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> m_localAddr;&#125;</span><br><span class="line">    <span class="function"><span class="type">const</span> InetAddress&amp; <span class="title">peerAddress</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> m_peerAddr;&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">handleRead</span><span class="params">(Timestamp receiveTime)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">handleWrite</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">handleClose</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">handleError</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送数据;</span></span><br><span class="line"><span class="comment">     * 用户会给TcpServer注册onMessageCallback, </span></span><br><span class="line"><span class="comment">     * 已建立连接的用户有读写事件时, 尤其是读事件, onMessage会响应; </span></span><br><span class="line"><span class="comment">     * 处理完客户端发来的事件后(onMessageCallback), 服务端会send给客户端回发消息; </span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 收发数据的方式: </span></span><br><span class="line"><span class="comment">     * 本项目的数据收发统一使用json或protobuf格式化的字符串进行, </span></span><br><span class="line"><span class="comment">     * 所以此send函数的参数为了方便起见, 直接规定为string类型; </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">send</span><span class="params">(<span class="type">const</span> std::string &amp; buf)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送数据;</span></span><br><span class="line"><span class="comment">     * 应用写的快, 而内核发送数据慢, </span></span><br><span class="line"><span class="comment">     * 需要把待发送数据写入缓冲区, 而且设置了水位回调.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sendInLoop</span><span class="params">(<span class="type">const</span> <span class="type">void</span> * data, <span class="type">size_t</span> len)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">shutdownInLoop</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/*************************属性*************************/</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ConnectionCallback	    m_connectionCallback;       <span class="comment">//关于连接的回调</span></span><br><span class="line">    MessageCallback	        m_messageCallback;          <span class="comment">//已连接用户有读写事件发生时的回调</span></span><br><span class="line">    WriteCompleteCallback   m_writeCompleteCallback;    <span class="comment">//消息发送完成后的回调</span></span><br><span class="line">    HighWaterMarkCallback   m_highWaterMarkCallback;    <span class="comment">//高水位回调，为了控制收发流量稳定</span></span><br><span class="line">    CloseCallback           m_closeCallback;            <span class="comment">//关闭连接的回调</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    EventLoop *m_loop;                  <span class="comment">//subLoop</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::unique_ptr&lt;Socket&gt;  m_socket;  <span class="comment">//unique_ptr管理</span></span><br><span class="line">    std::unique_ptr&lt;Channel&gt; m_channel; <span class="comment">//unique_ptr管理</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">const</span> InetAddress m_localAddr;      <span class="comment">//本地地址信息</span></span><br><span class="line">    <span class="type">const</span> InetAddress m_peerAddr;       <span class="comment">//对端地址信息</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Buffer m_inputBuffer;               <span class="comment">//写缓冲区</span></span><br><span class="line">    Buffer m_outputBuffer;              <span class="comment">//读缓冲区</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">const</span> std::string m_name;</span><br><span class="line">    </span><br><span class="line">    std::atomic_int m_state;            <span class="comment">//atomic，用枚举类变量赋值</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">bool</span> m_reading;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> m_highWaterMark;             <span class="comment">//高水位阈值</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TcpConnection::handleRead</span><span class="params">(Timestamp receiveTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> savedErrno = <span class="number">0</span>;</span><br><span class="line">    <span class="type">ssize_t</span> n = m_inputBuffer.<span class="built_in">readFd</span>(m_channel-&gt;<span class="built_in">fd</span>(), &amp;savedErrno);</span><br><span class="line">    <span class="keyword">if</span>(n &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//已建立连接的用户，有可读事件发生了，调用用户传入的回调操作onMessage</span></span><br><span class="line">        <span class="built_in">m_messageCallback</span>(<span class="built_in">shared_from_this</span>(), &amp;m_inputBuffer, receiveTime);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(n == <span class="number">0</span>) <span class="comment">//客户端断开</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">handleClose</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        errno = savedErrno;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;%s\n&quot;</span>, __FUNCTION__);</span><br><span class="line">        <span class="built_in">handleError</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TcpConnection::handleWrite</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_channel-&gt;<span class="built_in">isWriting</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> savedErrno = <span class="number">0</span>;</span><br><span class="line">        <span class="type">ssize_t</span> n = m_outputBuffer.<span class="built_in">writeFd</span>(m_channel-&gt;<span class="built_in">fd</span>(), &amp;savedErrno);</span><br><span class="line">        <span class="keyword">if</span>(n &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_outputBuffer.<span class="built_in">retrieve</span>(n);</span><br><span class="line">            <span class="keyword">if</span>(m_outputBuffer.<span class="built_in">readableBytes</span>() == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_channel-&gt;<span class="built_in">disableWriting</span>();</span><br><span class="line">                <span class="keyword">if</span>(m_writeCompleteCallback)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">/* 唤醒loop对应的thread线程, 执行回调 */</span></span><br><span class="line">                    m_loop-&gt;<span class="built_in">queueInLoop</span>(std::<span class="built_in">bind</span>(m_writeCompleteCallback,</span><br><span class="line">                                                  <span class="built_in">shared_from_this</span>()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(m_state == kDisconnecting)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">shutdownInLoop</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;%s\n&quot;</span>, __FUNCTION__);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;%s: connection fd = %d is down, no more writing.\n&quot;</span>,</span><br><span class="line">                   __FUNCTION__, m_channel-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TcpConnection::handleClose</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s: fd = %d, state: %d\n&quot;</span>, __FUNCTION__, m_channel-&gt;<span class="built_in">fd</span>(), m_state.<span class="built_in">load</span>());</span><br><span class="line">    <span class="built_in">setState</span>(kDisconnected);</span><br><span class="line">    m_channel-&gt;<span class="built_in">disableAll</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">TcpConnectionPtr <span class="title">connPtr</span><span class="params">(shared_from_this())</span></span>;</span><br><span class="line">    <span class="built_in">m_connectionCallback</span>(connPtr);</span><br><span class="line">    <span class="built_in">m_closeCallback</span>(connPtr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TcpConnection::handleError</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> optval;</span><br><span class="line">    <span class="type">socklen_t</span> optlen = <span class="keyword">sizeof</span> optval;</span><br><span class="line">    <span class="type">int</span> err = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(::<span class="built_in">getsockopt</span>(m_channel-&gt;<span class="built_in">fd</span>(), SOL_SOCKET, SO_ERROR, &amp;optval, &amp;optlen) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err = errno;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        err = optval;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;%s name: %s - SO_ERROR: %d\n&quot;</span>, __FUNCTION__, m_name.<span class="built_in">c_str</span>(), err);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. 判断当前连接的状态是否为connected; </span></span><br><span class="line"><span class="comment"> * 2. 判断此loop是否在本thread中, 如果是则调用sendInLoop; 否则runInLoop, 绑定的函数也是sendInLoop;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TcpConnection::send</span><span class="params">(<span class="type">const</span> std::string &amp;buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_state == kConnected)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(m_loop-&gt;<span class="built_in">isInLoopThread</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">sendInLoop</span>(buf.<span class="built_in">c_str</span>(), buf.<span class="built_in">size</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_loop-&gt;<span class="built_in">runInLoop</span>(std::<span class="built_in">bind</span>(&amp;TcpConnection::sendInLoop,</span><br><span class="line">                              <span class="keyword">this</span>, buf.<span class="built_in">c_str</span>(), buf.<span class="built_in">size</span>()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送数据;</span></span><br><span class="line"><span class="comment"> * 应用写的快, 而内核发送数据慢, </span></span><br><span class="line"><span class="comment"> * 需要把待发送数据写入缓冲区, 而且设置了水位回调.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TcpConnection::sendInLoop</span><span class="params">(<span class="type">const</span> <span class="type">void</span> * data, <span class="type">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">ssize_t</span> nwrote = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> remaining = len;</span><br><span class="line">    <span class="type">bool</span> faultError = <span class="literal">false</span>;	<span class="comment">//记录是否产生错误</span></span><br><span class="line">    <span class="keyword">if</span>(m_state == kDisconnected)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;Disconnected, give up writing!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * m_channel-&gt;isWriting()为false表示channel第一次开始写数据, </span></span><br><span class="line"><span class="comment">     * readableBytes()为0说明缓冲区没有待发送数据; </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span>(!m_channel-&gt;<span class="built_in">isWriting</span>() &amp;&amp; m_outputBuffer.<span class="built_in">readableBytes</span>() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        nwrote = ::<span class="built_in">write</span>(m_channel-&gt;<span class="built_in">fd</span>(), data, len);</span><br><span class="line">        <span class="keyword">if</span>(nwrote &gt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            remaining = len - nwrote;</span><br><span class="line">            <span class="keyword">if</span>(remaining == <span class="number">0</span> &amp;&amp; m_writeCompleteCallback)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//如果此时数据全部发送完毕, 不用再给channel设置epollout事件</span></span><br><span class="line">                m_loop-&gt;<span class="built_in">queueInLoop</span>(std::<span class="built_in">bind</span>(m_writeCompleteCallback, <span class="built_in">shared_from_this</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">//nwrote &lt; 0</span></span><br><span class="line">        &#123;</span><br><span class="line">            nwrote = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span>(errno != EWOULDBLOCK)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;%s\n&quot;</span>, __FUNCTION__);</span><br><span class="line">                <span class="keyword">if</span>(errno == EPIPE || errno == ECONNRESET)<span class="comment">// SIGPIPE or RESET</span></span><br><span class="line">                &#123;</span><br><span class="line">                    faultError = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!faultError &amp;&amp; remaining &gt; <span class="number">0</span>)<span class="comment">//没有出错, 没有发送完毕, 剩余数据需要存到缓冲区, 然后给channel注册epollout事件, LT模式, poller发现tcp的发送缓冲区有空间, 会通知相应的sock-&gt;channel, 调用writeCallback方法, 即调用handleWrite, 直到把发送缓冲区中数据全部发送</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> oldlen = m_outputBuffer.<span class="built_in">readableBytes</span>();</span><br><span class="line">        <span class="keyword">if</span>(oldlen + remaining &gt;= m_highWaterMark &amp;&amp; oldlen &lt; m_highWaterMark &amp;&amp; m_highWaterMarkCallback)</span><br><span class="line">        &#123;</span><br><span class="line">            m_loop-&gt;<span class="built_in">queueInLoop</span>(std::<span class="built_in">bind</span>(m_highWaterMarkCallback, <span class="built_in">shared_from_this</span>(), oldlen+remaining));</span><br><span class="line">        &#125;</span><br><span class="line">        m_outputBuffer.<span class="built_in">append</span>((<span class="type">char</span>*)data+nwrote, remaining);<span class="comment">//data+nworte即剩余的位置</span></span><br><span class="line">        <span class="keyword">if</span>(!m_channel-&gt;<span class="built_in">isWriting</span>())<span class="comment">//m_channel-&gt;isWriting()为false表示channel第一次开始写数据, 之前没有注册epollout, 现在需要注册</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_channel-&gt;<span class="built_in">enableWriting</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="重点在于clientroutine的数据处理代码编写"   >
          <a href="#重点在于clientroutine的数据处理代码编写" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#重点在于clientroutine的数据处理代码编写"></a> 重点在于ClientRoutine的数据处理代码编写</h2>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClientRoutine::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;client routine run&quot;</span>);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::<span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line">        <span class="comment">//socket已经在创建时设置为非阻塞模式，返回值有三种情况:0 -&gt;closed &lt;0 -&gt;此时没数据到达 &gt;0 -&gt;有数据到达</span></span><br><span class="line">        <span class="type">int</span> len = m_socket-&gt;<span class="built_in">recv</span>(buf, <span class="number">1024</span>);<span class="comment">//接受客户端发的消息</span></span><br><span class="line">        <span class="keyword">if</span>(len == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_info</span>(<span class="string">&quot;socket closed by peer&quot;</span>);</span><br><span class="line">            m_socket-&gt;<span class="built_in">close</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(len &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;socket recv would block: len=%d, errno=%d, error=%s&quot;</span>, len, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="built_in">yield</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_info</span>(<span class="string">&quot;socket recv: len=%d data=%s&quot;</span>, len, buf);</span><br><span class="line">            <span class="comment">//handleRead</span></span><br><span class="line">            <span class="comment">//已建立连接的用户，有可读事件发生了，调用用户传入的回调操作onMessage</span></span><br><span class="line">            <span class="comment">//messageCallback(m_socket, buf, time);</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//handle</span></span><br><span class="line">            m_socket-&gt;<span class="built_in">send</span>(buf, <span class="built_in">strlen</span>(buf));<span class="comment">//给客户端发送消息</span></span><br><span class="line">            <span class="built_in">yield</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="onmessage"   >
          <a href="#onmessage" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#onmessage"></a> onMessage</h3>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 上报读写事件相关信息的回调函数*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatServer::onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr&amp; conn,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Buffer* buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * muduo库或从网络上读取的数据首先在数据缓冲区;</span></span><br><span class="line"><span class="comment">     * 收到一个消息后，retrieveAllAsString可以把缓冲区的数据;</span></span><br><span class="line"><span class="comment">     * 取出到一个字符串中。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    string buf = buffer-&gt;<span class="built_in">retrieveAllAsString</span>();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据的反序列化;</span></span><br><span class="line"><span class="comment">     * json中包含message_type，message_id;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    json js = json::<span class="built_in">parse</span>(buf);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过js[&quot;msgid&quot;]绑定一个回调操作，即一个id一个操作;</span></span><br><span class="line"><span class="comment">     * 解析到msgid后获取业务处理器handler，处理器是事先绑定的方法。网络模块看不到，业务模块绑定的;</span></span><br><span class="line"><span class="comment">     * 回调handler时，conn、js对象、time都可以传入;</span></span><br><span class="line"><span class="comment">     * 我们要达到的目的：完全解耦网络模块的代码和业务模块的代码;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">auto</span> msgHandler = ChatService::<span class="built_in">instance</span>()-&gt;<span class="built_in">getHandler</span>(</span><br><span class="line">        js[<span class="string">&quot;msgid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;());    <span class="comment">// js[&quot;msgid&quot;] 依旧是json类型，需要转为int</span></span><br><span class="line">    <span class="comment">/* 回调消息绑定好的事件处理器，来执行相应的业务处理 */</span></span><br><span class="line">    <span class="built_in">msgHandler</span>(conn, js, time);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="chatservice类的设计与实现"   >
          <a href="#chatservice类的设计与实现" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#chatservice类的设计与实现"></a> ChatService类的设计与实现</h2>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHATSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;muduo/net/TcpConnection.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;redis.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;usermodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;offlinemsgmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;friendmodel.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;groupmodel.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo::net;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;json.hpp&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> json = nlohmann::json;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 表示处理消息的事件回调方法类型 */</span></span><br><span class="line"><span class="keyword">using</span> MsgHandler = std::function&lt;<span class="built_in">void</span>(<span class="type">const</span> TcpConnectionPtr&amp;, json&amp;, Timestamp)&gt;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 聊天服务器业务类. </span></span><br><span class="line"><span class="comment"> * 用映射关系来存储消息id和具体处理函数. </span></span><br><span class="line"><span class="comment"> * 此类有一个实例就够了，所以采用单例模式. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 获取单例对象的接口函数 */</span></span><br><span class="line">    <span class="function"><span class="type">static</span> ChatService* <span class="title">instance</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 处理登录业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    <span class="comment">/* 处理注册业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 添加好友业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addFriend</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    <span class="comment">/* 一对一聊天业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 创建群组业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">createGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    <span class="comment">/* 加入群组业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line">    <span class="comment">/* 群组聊天业务 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">groupChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 获取消息对应的处理器 */</span></span><br><span class="line">    <span class="function">MsgHandler <span class="title">getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 处理客户端异常退出 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp; conn)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 业务重置方法，通常在服务器异常退出时调用 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __CLUSTER__</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 从Redis消息队列中获取订阅的消息 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">handleRedisSubscribeMessage</span><span class="params">(<span class="type">int</span> channel, string message)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ChatService</span>();</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    UserModel       _userModel;         <span class="comment">/* 数据操作类对象 */</span></span><br><span class="line">    OfflineMsgModel _offlineMsgModel;   <span class="comment">/* 数据操作类对象 */</span></span><br><span class="line">    FriendModel     _friendModel;       <span class="comment">/* 数据操作类对象 */</span></span><br><span class="line">    GroupModel      _groupModel;        <span class="comment">/* 数据操作类对象 */</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* 定义互斥锁，保证m_userConnectionMap的线程安全 */</span></span><br><span class="line">    mutex _connMutex;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* 存储消息id和其对应的业务处理方法 */</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>, MsgHandler&gt; _msgHandlerMap;</span><br><span class="line">    <span class="comment">/* 存储在线用户的通信连接 */</span></span><br><span class="line">    unordered_map&lt;<span class="type">int</span>, TcpConnectionPtr&gt; _userConnectionMap;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __CLUSTER__</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/* redis操作对象 */</span></span><br><span class="line">    Redis m_redis;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;chatservice.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;public.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;muduo/base/Logging.h&gt;</span>  <span class="comment">// LOG_ERROR &lt;&lt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> muduo;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function">ChatService* <span class="title">ChatService::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> ChatService service;</span><br><span class="line">    <span class="keyword">return</span> &amp;service;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册消息以及对应的Handler回调操作</span></span><br><span class="line"><span class="comment"> * 对unordered_map成员变量进行初始化</span></span><br><span class="line"><span class="comment"> * 这是业务模块的核心，也是对项目进行解耦的核心</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ChatService::<span class="built_in">ChatService</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* 键：消息id - 值：函数对象 */</span></span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;LOGIN_MSG, std::<span class="built_in">bind</span>(&amp;ChatService::login, <span class="keyword">this</span>, _1, _2, _3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;REG_MSG, std::<span class="built_in">bind</span>(&amp;ChatService::reg, <span class="keyword">this</span>, _1, _2, _3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ONE_CHAT_MSG, std::<span class="built_in">bind</span>(&amp;ChatService::oneChat, <span class="keyword">this</span>, _1, _2, _3)&#125;);</span><br><span class="line">    _msgHandlerMap.<span class="built_in">insert</span>(&#123;ADD_FRIEND_MSG, std::<span class="built_in">bind</span>(&amp;ChatService::addFriend, <span class="keyword">this</span>, _1, _2, _3)&#125;);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __CLUSTER__</span></span><br><span class="line">    <span class="keyword">if</span>(m_redis.<span class="built_in">connect</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        m_redis.<span class="built_in">init_notify_handler</span>(std::<span class="built_in">bind</span>(</span><br><span class="line">            &amp;ChatService::handleRedisSubscribeMessage, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 业务重置方法，通常在服务器异常退出时调用 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 把所有online用户的状态置为offline */</span></span><br><span class="line">    _userModel.<span class="built_in">resetAllState</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 获取消息对应的处理器 */</span></span><br><span class="line"><span class="function">MsgHandler <span class="title">ChatService::getHandler</span><span class="params">(<span class="type">int</span> msgid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 记录错误日志，msgid没有对应的事件处理回调时 */</span></span><br><span class="line">    <span class="keyword">auto</span> it = _msgHandlerMap.<span class="built_in">find</span>(msgid);</span><br><span class="line">    <span class="keyword">if</span>(it == _msgHandlerMap.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 没有找到处理器时，返回一个默认的处理器，空操作。</span></span><br><span class="line"><span class="comment">         * 如此设计的好处，即使没有找到程序也不会因此挂掉，进行空操作，继续运行。</span></span><br><span class="line"><span class="comment">         * 因为需要获取函数参数msgid，所以[=]按值获取。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> [=](<span class="type">const</span> TcpConnectionPtr&amp;, json&amp;, Timestamp)</span><br><span class="line">        &#123;</span><br><span class="line">            LOG_ERROR &lt;&lt; <span class="string">&quot;msgid: &quot;</span> &lt;&lt; msgid &lt;&lt; <span class="string">&quot; can&#x27;t find handler&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _msgHandlerMap[msgid];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 处理登录业务 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::login</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,</span></span></span><br><span class="line"><span class="params"><span class="function">                        json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 从json参数获取账号、密码信息 */</span></span><br><span class="line">    <span class="type">int</span> id = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];</span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(id);</span><br><span class="line"></span><br><span class="line">    json response;</span><br><span class="line">    response[<span class="string">&quot;msgid&quot;</span>] = LOGIN_MSG_ACK;</span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() == id &amp;&amp; user.<span class="built_in">getPassword</span>() == password)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 该用户已经登录在线，不允许重复登陆 */</span></span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = LOGIN_REPEAT;</span><br><span class="line">            response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;该用户已经登录&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;offline&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 登陆成功 */</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">/* 记录用户连接信息 */</span></span><br><span class="line">                lock_guard&lt;mutex&gt; <span class="built_in">lock</span>(_connMutex);</span><br><span class="line">                _userConnectionMap.<span class="built_in">insert</span>(&#123;id, conn&#125;);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __CLUSTER__</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 集群环境下, 向redis订阅此id </span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            m_redis.<span class="built_in">subscribe</span>(id);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="comment">/* 更新用户状态信息 */</span></span><br><span class="line">            user.<span class="built_in">setState</span>(<span class="string">&quot;online&quot;</span>);</span><br><span class="line">            _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line"></span><br><span class="line">            response[<span class="string">&quot;errno&quot;</span>] = LOGIN_SUCCEESS;</span><br><span class="line">            response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">            response[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">            <span class="comment">/* 查询该用户是否在离线时未收到的消息 */</span></span><br><span class="line">            vector&lt;string&gt; offlineMsgVec = _offlineMsgModel.<span class="built_in">query</span>(id);</span><br><span class="line">            <span class="keyword">if</span>(!offlineMsgVec.<span class="built_in">empty</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                response[<span class="string">&quot;offlinemsg&quot;</span>] = offlineMsgVec;</span><br><span class="line">                <span class="comment">/* 把该用户的所有离线消息从从数据中删除掉 */</span></span><br><span class="line">                _offlineMsgModel.<span class="built_in">remove</span>(id);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* 查询该用户的好友信息，并返回 */</span></span><br><span class="line">            vector&lt;User&gt; userVec = _friendModel.<span class="built_in">query</span>(id);</span><br><span class="line">            <span class="keyword">if</span>(!userVec.<span class="built_in">empty</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                vector&lt;string&gt; friendJsonInfoVec;</span><br><span class="line">                <span class="keyword">for</span>(User &amp;user : userVec)</span><br><span class="line">                &#123;</span><br><span class="line">                    json js;</span><br><span class="line">                    js[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">                    js[<span class="string">&quot;name&quot;</span>] = user.<span class="built_in">getName</span>();</span><br><span class="line">                    js[<span class="string">&quot;state&quot;</span>] = user.<span class="built_in">getState</span>();</span><br><span class="line">                    friendJsonInfoVec.<span class="built_in">push_back</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">                &#125;</span><br><span class="line">                response[<span class="string">&quot;friends&quot;</span>] = friendJsonInfoVec;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(user.<span class="built_in">getId</span>() != id)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 登录失败，用户不存在 */</span></span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = LOGIN_NOTFOUND;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;用户不存在&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(user.<span class="built_in">getPassword</span>() != password)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 登录失败，密码不匹配 */</span></span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = LOGIN_WRONGPWD;</span><br><span class="line">        response[<span class="string">&quot;errmsg&quot;</span>] = <span class="string">&quot;密码验证失败&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 处理注册业务 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::reg</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,</span></span></span><br><span class="line"><span class="params"><span class="function">                      json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* LOG_INFO &lt;&lt; &quot;do reg service.&quot;; */</span></span><br><span class="line">    string name = js[<span class="string">&quot;name&quot;</span>];</span><br><span class="line">    string password = js[<span class="string">&quot;password&quot;</span>];</span><br><span class="line"></span><br><span class="line">    User user;</span><br><span class="line">    user.<span class="built_in">setName</span>(name);</span><br><span class="line">    user.<span class="built_in">setPassword</span>(password);</span><br><span class="line">    <span class="type">bool</span> state = _userModel.<span class="built_in">insert</span>(user);</span><br><span class="line">    json response;</span><br><span class="line">    response[<span class="string">&quot;msgid&quot;</span>] = REG_MSG_ACK;</span><br><span class="line">    <span class="keyword">if</span>(state)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 注册成功 */</span></span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">0</span>;</span><br><span class="line">        response[<span class="string">&quot;id&quot;</span>] = user.<span class="built_in">getId</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 注册失败 */</span></span><br><span class="line">        response[<span class="string">&quot;errno&quot;</span>] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    conn-&gt;<span class="built_in">send</span>(response.<span class="built_in">dump</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 处理客户端异常退出 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::clientCloseException</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp; conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 查找 */</span></span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line">    User user;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> it = _userConnectionMap.<span class="built_in">begin</span>(); it != _userConnectionMap.<span class="built_in">end</span>(); ++it)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(it-&gt;second == conn)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 从map表删除用户的连接信息 */</span></span><br><span class="line">            user.<span class="built_in">setId</span>(it-&gt;first);</span><br><span class="line">            _userConnectionMap.<span class="built_in">erase</span>(it);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __CLUSTER__</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 集群环境下, 向redis取消订阅此id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    m_redis.<span class="built_in">unsubscribe</span>(user.<span class="built_in">getId</span>());</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* 更新用户的状态信息 */</span></span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getId</span>() != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        user.<span class="built_in">setState</span>(<span class="string">&quot;offline&quot;</span>);</span><br><span class="line">        _userModel.<span class="built_in">updateState</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 一对一聊天业务 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::oneChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> to = js[<span class="string">&quot;to&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line">        <span class="keyword">auto</span> it = _userConnectionMap.<span class="built_in">find</span>(to);</span><br><span class="line">        <span class="keyword">if</span>(it != _userConnectionMap.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 接收方在线，转发消息 */</span></span><br><span class="line">            <span class="comment">/* 服务器主动推送消息给接收方 */</span></span><br><span class="line">            it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());    <span class="comment">// it-&gt;second 表示 </span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __CLUSTER__</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 集群环境下, 需要查询对方(to)是否在线;</span></span><br><span class="line"><span class="comment">     * 不可通过服务器connMap查询, 是通过数据库信息;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    User user = _userModel.<span class="built_in">query</span>(to);</span><br><span class="line">    <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_redis.<span class="built_in">publish</span>(to, js.<span class="built_in">dump</span>());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* 接收方离线，存储离线消息 */</span></span><br><span class="line">    _offlineMsgModel.<span class="built_in">insert</span>(to, js.<span class="built_in">dump</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 添加好友业务 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::addFriend</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    <span class="type">int</span> friendid = js[<span class="string">&quot;friendid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 存储好友信息 -&gt; include&quot;friendmodel.hpp&quot; */</span></span><br><span class="line">    _friendModel.<span class="built_in">insert</span>(userid, friendid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 创建群组业务 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::createGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    string groupName = js[<span class="string">&quot;groupname&quot;</span>];</span><br><span class="line">    string groupDesc = js[<span class="string">&quot;groupdesc&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 存储新创建的群组信息 */</span></span><br><span class="line">    <span class="function">Group <span class="title">group</span><span class="params">(<span class="number">-1</span>, groupName, groupDesc)</span></span>;</span><br><span class="line">    <span class="keyword">if</span>(_groupModel.<span class="built_in">createGroup</span>(group))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 把创建人加入群组 */</span></span><br><span class="line">        _groupModel.<span class="built_in">addGroup</span>(userid, group.<span class="built_in">getId</span>(), <span class="string">&quot;Creator&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 加入群组业务 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::addGroup</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    <span class="type">int</span> groupid = js[<span class="string">&quot;groupid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    _groupModel.<span class="built_in">addGroup</span>(userid, groupid, <span class="string">&quot;Normal&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 群组聊天业务 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::groupChat</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, json &amp;js, Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> userid = js[<span class="string">&quot;id&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    <span class="type">int</span> groupid = js[<span class="string">&quot;groupid&quot;</span>].<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; useridVec = _groupModel.<span class="built_in">queryGroupUsers</span>(userid, groupid);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> offline = <span class="literal">true</span>;</span><br><span class="line">    <span class="type">bool</span> reallyOffline = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> id : useridVec)</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line">            <span class="keyword">auto</span> it = _userConnectionMap.<span class="built_in">find</span>(id);</span><br><span class="line">            <span class="keyword">if</span>(it != _userConnectionMap.<span class="built_in">end</span>())<span class="comment">//在本台服务器上线</span></span><br><span class="line">            &#123;</span><br><span class="line">                offline = <span class="literal">false</span>;</span><br><span class="line">                reallyOffline = <span class="literal">false</span>;</span><br><span class="line">                it-&gt;second-&gt;<span class="built_in">send</span>(js.<span class="built_in">dump</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __CLUSTER__</span></span><br><span class="line">        <span class="keyword">if</span>(offline)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 集群环境下, 需要判断其是否在其他服务器上在线;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            User user = _userModel.<span class="built_in">query</span>(id);</span><br><span class="line">            <span class="keyword">if</span>(user.<span class="built_in">getState</span>() == <span class="string">&quot;online&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                reallyOffline = <span class="literal">false</span>;</span><br><span class="line">                m_redis.<span class="built_in">publish</span>(id, js.<span class="built_in">dump</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span>(reallyOffline)</span><br><span class="line">        &#123;</span><br><span class="line">            _offlineMsgModel.<span class="built_in">insert</span>(id, js.<span class="built_in">dump</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        reallyOffline = <span class="literal">true</span>;</span><br><span class="line">        offline = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __CLUSTER__</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 场景: 本台服务器收到了redis某一频道发来的通知消息;</span></span><br><span class="line"><span class="comment"> *  在前面的代码逻辑中, redis的publish都是判断用户在线之后才发的;</span></span><br><span class="line"><span class="comment"> *   但是用户可能在这个判断和真正收到消息这段时间内下线,</span></span><br><span class="line"><span class="comment"> *  所以, 本服务器处理收到redis某一频道上消息的回调时,</span></span><br><span class="line"><span class="comment"> *   需要再次判断此id是否在线, 如果在线则发送, </span></span><br><span class="line"><span class="comment"> *   如果不在线, 需要存到离线消息数据库中; </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChatService::handleRedisSubscribeMessage</span><span class="params">(<span class="type">int</span> userid, string msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(_connMutex)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> it = _userConnectionMap.<span class="built_in">find</span>(userid);</span><br><span class="line">    <span class="comment">/* 该用户在线, 则直接发送 */</span></span><br><span class="line">    <span class="keyword">if</span>(it != _userConnectionMap.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        it-&gt;second-&gt;<span class="built_in">send</span>(msg);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 存储该用户的离线消息 */</span></span><br><span class="line">    _offlineMsgModel.<span class="built_in">insert</span>(userid, msg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

        <h1 id="问题"   >
          <a href="#问题" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#问题"></a> 问题</h1>
      
<ol>
<li>如果聊天内容带有<code>'</code>单引号，则会影响SQL语句的正确输入，需要处理转义。</li>
</ol>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/Linux/Linux_Ubuntu%E9%85%8D%E7%BD%AE/">Linux_Ubuntu配置</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-05-09</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2025-09-09</span></span><span class="post-meta-item post-meta-item--visitors leancloud_visitors" id="/Linux/Linux_Ubuntu%E9%85%8D%E7%BD%AE/" data-flag-title="Linux_Ubuntu配置"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value leancloud-visitors-count"></span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="内容"   >
          <a href="#内容" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#内容"></a> 内容</h1>
      
<ol>
<li>
<p>关闭Ubuntu动画</p>
</li>
<li>
<p>配置终端代理</p>
</li>
<li>
<p>下载安装make、g+±12/gcc-12、git、net-tools、curl</p>
<ol>
<li>
<p>g++和gcc有什么关系？d41d8c的回答 - 知乎 <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.zhihu.com/question/20940822/answer/1768772877" >https://www.zhihu.com/question/20940822/answer/1768772877</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li>
<p>将g<ins>默认为g</ins>-12(参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/ask/sof/100275" >https://cloud.tencent.com/developer/ask/sof/100275</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>)</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install g++-12</span><br><span class="line">sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100</span><br><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100</span><br><span class="line"></span><br><span class="line">sudo update-alternatives --set g++ /usr/bin/g++-12</span><br><span class="line">sudo update-alternatives --set gcc /usr/bin/gcc-12</span><br></pre></td></tr></table></div></figure>
</li>
<li>
<p>命令格式：<code>update-alternatives [&lt;选项&gt; ...] &lt;命令&gt;</code>(参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/JasonDing1354/article/details/50470109" >https://blog.csdn.net/JasonDing1354/article/details/50470109</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>)</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Commands:</span><br><span class="line">  --install &lt;link&gt; &lt;name&gt; &lt;path&gt; &lt;priority&gt;</span><br><span class="line">    [--slave &lt;link&gt; &lt;name&gt; &lt;path&gt;] ...</span><br><span class="line">                           在系统中加入一组替换项.</span><br><span class="line">  --remove &lt;name&gt; &lt;path&gt;   从 &lt;名称&gt; 替换组中去除 &lt;路径&gt; 项.</span><br><span class="line">  --remove-all &lt;name&gt;      从替换系统中删除 &lt;名称&gt; 替换组.</span><br><span class="line">  --auto &lt;name&gt;            将 &lt;名称&gt; 的主链接切换到自动模式.</span><br><span class="line">  --display &lt;name&gt;         显示关于 &lt;名称&gt; 替换组的信息.</span><br><span class="line">  --query &lt;name&gt;           machine parseable version of --display &lt;name&gt;.</span><br><span class="line">  --list &lt;name&gt;            列出 &lt;名称&gt; 替换组中所有的可用替换项.</span><br><span class="line">  --get-selections         list master alternative names and their status.</span><br><span class="line">  --set-selections         read alternative status from standard input.</span><br><span class="line">  --config &lt;name&gt;          列出 &lt;名称&gt; 替换组中的可选项，并就使用其中</span><br><span class="line">                                 哪一个，征询用户的意见.</span><br><span class="line">  --set &lt;name&gt; &lt;path&gt;      将 &lt;路径&gt; 设置为 &lt;名称&gt; 的替换项.</span><br><span class="line">  --all                    对所有可选项一一调用 --config 命令.</span><br><span class="line">&lt;link&gt; 是指向 /etc/alternatives/&lt;名称&gt; 的符号链接&gt;.</span><br><span class="line">  (e.g. /usr/bin/pager)</span><br><span class="line">&lt;name&gt; 是该链接替换组的主控名.</span><br><span class="line">  (e.g. pager)</span><br><span class="line">&lt;path&gt; 是替换项目标文件的位置.</span><br><span class="line">  (e.g. /usr/bin/less)</span><br><span class="line">&lt;priority&gt; 是一个整数，在自动模式下，这个数字越高的选项，其优先级也就越高.</span><br><span class="line">Options:</span><br><span class="line">  --altdir &lt;directory&gt;     指定不同的可选项目录.</span><br><span class="line">  --admindir &lt;directory&gt;   指定不同的管理目录.</span><br><span class="line">  --log &lt;file&gt;             设置log文件.</span><br><span class="line">  --force                  allow replacing files with alternative links.</span><br><span class="line">  --skip-auto              skip prompt for alternatives correctly configured</span><br><span class="line">                           in automatic mode (relevant for --config only)</span><br><span class="line">  --verbose                详尽的操作进行信息，更多的输出.</span><br><span class="line">  --quiet                  安静模式，输出尽可能少的信息.</span><br><span class="line">  --help                   显示本帮助信息.</span><br><span class="line">  --version                显示版本信息.</span><br></pre></td></tr></table></div></figure>
</li>
</ol>
</li>
<li>
<p>下载安装vim</p>
<ol>
<li>
<pre class="highlight"><code class="">git clone https://github.com/vim/vim.git
# if you don't have local changes, update to the latest version with:
cd vim
git pull
# If you made some changes, e.g. to a makefile, you can keep them and merge with the latest version with:
cd vim
git stash
git pull
git stash pop
# If you have local changes you may need to merge. If you are sure you can discard local changes (e.g. if you were just trying a patch), you can use:
git fetch --all
git reset --hard origin/master
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. ```</span><br><span class="line">   # Building Vim</span><br><span class="line">   cd src</span><br><span class="line">   make distclean  # if you build Vim before</span><br><span class="line">   make</span><br><span class="line">   sudo make install</span><br></pre></td></tr></table></div></figure>

</code></pre>
</li>
<li>
<pre class="highlight"><code class="">checking for tgetent()... configure: error: NOT FOUND!
      You need to install a terminal library; for example ncurses.
      On Linux that would be the libncurses-dev package.
      Or specify the name of the library with --with-tlib.
# sudo apt-get install libncurses5-dev
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">5. 配置镜像源 - huaweicloud, http协议</span><br><span class="line"></span><br><span class="line">6. 更新系统软件</span><br><span class="line"></span><br><span class="line">7. 安装ssh-server `sudo apt-get install openssh-server`</span><br><span class="line"></span><br><span class="line"># 关闭Ubuntu动画</span><br><span class="line"></span><br><span class="line">Ubuntu Desktop应用程序菜单带有从屏幕底角到屏幕中心的动画。虽然这看起来很酷，但感觉它很卡，尤其是在集成显卡和虚拟机的环境中。有一种方法可以关闭此动画，从而可以更快地从“应用程序”菜单中启动应用程序。</span><br><span class="line"></span><br><span class="line">1. 打开“终端”</span><br><span class="line">2. 执行以下命令，关闭动画，立即生效（不用root）</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
</code></pre>
</li>
</ol>
</li>
</ol>
<p>gsettings set org.gnome.desktop.interface enable-animations false</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">想要重新开启动画，只需要执行</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<p>gsettings set org.gnome.desktop.interface enable-animations true</p>
<pre class="highlight"><code class=""></code></pre>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/page/48/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/48/">48</a><span class="page-number current">49</span><a class="page-number" href="/page/50/">50</a><span class="space">&hellip;</span><a class="page-number" href="/page/152/">152</a><a class="extend next" rel="next" href="/page/50/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/touxiang.png" alt="avatar"></div><p class="sidebar-ov-author__text">无论哪里，生活继续。</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/xing-cg" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://gitee.com/mrcan" target="_blank" rel="noopener" data-popover="social.gitee" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">Gitee</span></a><a class="sidebar-ov-social-item" href="https://www.zhihu.com/people/mrcan666" target="_blank" rel="noopener" data-popover="知乎" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-zhihu"></i></span></a><a class="sidebar-ov-social-item" href="tencent://message?uin=1933966629" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="mailto:xing-cg@qq.com" target="_blank" rel="noopener" data-popover="social.QQmail" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="far fa-envelope"></i></span></a><a class="sidebar-ov-social-item" href="https://blog.csdn.net/mrcan666" target="_blank" rel="noopener" data-popover="csdn" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">CSDN</span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">303</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">56</div><div class="sidebar-ov-state-item__name">分类</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2025</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Mr.Can All Rights Reserved</span><span class="footer__devider">|</span><span><a href="http://beian.miit.gov.cn/" target="_blank">京ICP备2025135168号</a></span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v7.3.0</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/npm/leancloud-storage@latest/dist/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><script>function loadValine () {
  var GUEST_INFO = ['nick', 'mail', 'link'];
  var guest_info = 'nick,mail,link';

  guest_info = guest_info.split(',').filter(function(item) {
    return GUEST_INFO.indexOf(item) > -1;
  });
  new Valine({
    el: '#valine-container',
    appId: 'QTXELGPwB2iKLovJroJUqbVP-gzGzoHsz',
    appKey: 'DDfRbL0aLE3KEHXtbNXHrlEQ',
    notify: true,
    verify: true,
    placeholder: '欢迎写下你的评论，同时欢迎留下你的昵称和邮箱！',
    avatar: 'mp',
    meta: guest_info,
    pageSize: '10' || 10,
    visitor: true,
    recordIP: true,
    lang: 'zh-cn' || 'zh-cn',
    path: window.location.pathname
  });
}

if (false) {
  loadValine();
} else {
  window.addEventListener('DOMContentLoaded', loadValine, false);
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>