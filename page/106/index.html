<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta property="og:type" content="website">
<meta property="og:title" content="罐头先生的博客">
<meta property="og:url" content="https://xing-cg.github.io/page/106/index.html">
<meta property="og:site_name" content="罐头先生的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Mr.Can">
<meta name="twitter:card" content="summary"><title>罐头先生的博客</title><link ref="canonical" href="https://xing-cg.github.io/page/106/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">罐头先生的博客</div><div class="header-banner-info__subtitle">Mr.Can</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/%E9%A1%B9%E7%9B%AE-muduo/%E5%AD%A6%E4%B9%A0muduo%E5%BA%93%E7%9A%84%E6%80%9D%E6%83%B3/">学习muduo库的思想</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2022-03-16</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2025-08-13</span></span><span class="post-meta-item post-meta-item--visitors leancloud_visitors" id="/%E9%A1%B9%E7%9B%AE-muduo/%E5%AD%A6%E4%B9%A0muduo%E5%BA%93%E7%9A%84%E6%80%9D%E6%83%B3/" data-flag-title="学习muduo库的思想"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value leancloud-visitors-count"></span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="内容"   >
          <a href="#内容" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#内容"></a> 内容</h1>
      
<ol>
<li>阻塞、非阻塞、同步、异步</li>
<li>五种IO模型</li>
<li>好的网路服务器设计思路</li>
<li>Reactor模型</li>
<li><code>select</code>/<code>poll</code>/<code>epoll</code>、<code>LT/ET</code>模式对比</li>
<li>muduo网络库编程环境配置</li>
<li>muduo网络库的多线程模型</li>
<li>基于muduo的服务器程序实例</li>
<li>muduo网络库提供的类</li>
<li>muduo网络库中TcpServer类中的回调类型</li>
<li>代码示例ChatServer及运行测试结果</li>
</ol>

        <h1 id="阻塞-非阻塞-同步-异步"   >
          <a href="#阻塞-非阻塞-同步-异步" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#阻塞-非阻塞-同步-异步"></a> 阻塞、非阻塞、同步、异步</h1>
      
<p>网络IO阶段分为两个：数据准备和数据读写</p>
<ul>
<li>数据准备–根据系统IO操作的就绪状态
<ul>
<li>阻塞：调用IO方法的线程进入阻塞状态</li>
<li>非阻塞：不会改变线程的状态，通过返回值判断</li>
</ul>
</li>
<li>数据读写（IO层面的同步和异步）–根据应用程序和内核的交互方式
<ul>
<li>同步：用户的recv完成了所有的动作，而且因此阻塞或者空转等待。数据是用户从TCP的接收缓冲区搬移的。</li>
<li>异步：应用程序把任务交给操作系统，自己去做别的事情，操作系统处理完后，通知用户层“buf的数据已经准备好了”。可以通过sigio通知或者实现约定的回调方式通知</li>
</ul>
</li>
</ul>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">recv</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">void</span>* buf, <span class="type">size_t</span> len, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">int</span> size = recv(sockfd, buf, <span class="number">1024</span>, <span class="number">0</span>);	<span class="comment">//recv阻塞至sockfd上有数据准备好</span></span><br><span class="line"><span class="comment">//如果recv的属性设置为set non-block，则即使sockfd没有数据也会返回，cpu空转</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	返回值：</span></span><br><span class="line"><span class="comment">		size == -1; # 原因可能为1.系统内部错误; 2.当前处于非阻塞模式，无数据</span></span><br><span class="line"><span class="comment">			若 errno == EAGAIN 则说明 当前的错误是因为处于非阻塞模式。</span></span><br><span class="line"><span class="comment">		size == 0;	# 是由于远端的正常close而返回</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></div></figure>
<p>陈硕：<strong>（非）阻塞和异/同步IO的关系：在处理IO的时候，阻塞和非阻塞都是同步IO，只有使用了特殊的API才是异步IO。</strong><br />
<img src="../../images/%E5%AD%A6%E4%B9%A0muduo%E5%BA%93%E7%9A%84%E6%80%9D%E6%83%B3/image-20220316211609059.png" alt="image-20220316211609059" /></p>
<p>即使epoll也是同步的IO，返回发生事件的event，读的时候需要调用recv，所以是同步IO。</p>
<ul>
<li>业务层面的一个逻辑处理是同步还是异步？
<ul>
<li>同步：A操作等待B操作完毕，得到返回值，继续处理</li>
<li>异步：A操作告诉B操作它感兴趣的事件及通知方式，A操作继续执行自己的业务逻辑了，等B监听到相应。</li>
</ul>
</li>
</ul>

        <h2 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
      
<blockquote>
<p>一个典型的网络IO接口调用，分为两个阶段，分别是“数据就绪”和“数据读写”，数据就绪阶<br />
段分为阻塞和非阻塞，表现得结果就是，阻塞当前线程或是直接返回。</p>
<p>同步表示A向B请求调用一个网络IO接口时（或者调用某个业务逻辑API接口时），数据的读写都<br />
是由请求方A自己来完成的（不管是阻塞还是非阻塞）；异步表示A向B请求调用一个网络IO接口<br />
时（或者调用某个业务逻辑API接口时），向B传入请求的事件以及事件发生时通知的方式，A就<br />
可以处理其它逻辑了，当B监听到事件处理完成后，会用事先约定好的通知方式，通知A处理结<br />
果。</p>
</blockquote>

        <h1 id="五种io模型"   >
          <a href="#五种io模型" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#五种io模型"></a> 五种IO模型</h1>
      
<ul>
<li>阻塞 blocking</li>
<li>非阻塞 non-blocking</li>
<li>IO复用 IO multiplexing</li>
<li>信号驱动 signal-driven</li>
<li>异步 asynchronous</li>
</ul>

        <h1 id="好的网络服务器设计"   >
          <a href="#好的网络服务器设计" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#好的网络服务器设计"></a> 好的网络服务器设计</h1>
      
<p>在这个多核时代，服务端网络编程如何选择线程模型？libevent作者的观点：<strong>one loop(事件循环, 一般用IO复用作为事件分发器) per thread</strong> is usually a good model. 多线程服务端编程的问题就转换为如何设计一个高效且易用的event loop，然后每个线程run一个event loop就行了【即muduo库的思想】（当然线程间的同步、互斥少不了，还有其他的耗时事件需要起另外的线程来做）。</p>
<ul>
<li>event loop是non-blocking网络编程的核心，在现实生活中，non-blocking几乎总是和IO-multiplexing一起使用，原因有二：
<ul>
<li><strong>不要单独使用非阻塞IO</strong>：没有人真的会用轮询(busy-polling)来检查某个non-blocking IO操作是否完成，太浪费CPU资源</li>
<li><strong>不要单独使用IO复用</strong>（比如阻塞的IO复用）：IO multiplexing一般不能和blocking IO用在一起，因为blocking IO中read()/write()/accept()/connect()都有可能阻塞当前线程，这样线程就没办法处理其他socket上的IO操作了</li>
<li>所以当我们提到non-blocking的时候，实际上指的是non-blocking + IO multiplexing，单用其中任何一个都没有办法很好地实现功能。</li>
<li>结论：epoll + 非阻塞IO + 线程池(线程的数目一般对应电脑的CPU核数)</li>
</ul>
</li>
</ul>
<blockquote>
<p>nginx使用的是epoll + fork，是不是不如epoll + pthread？</p>
</blockquote>
<p>nginx采用了epoll+fork模型作为网络模块的架构设计，实现了简单好用的负载算法，使各个fork网络进程不会忙的越忙、闲的越闲，并且<strong>通过一把乐观锁解决了该模型导致的服务器惊群</strong>现象，功能十分强大。</p>

        <h1 id="reactor模型"   >
          <a href="#reactor模型" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#reactor模型"></a> Reactor模型</h1>
      
<p>muduo库和libevent库都是“基于事件驱动的Reactor模型”。</p>
<p>Wikipedia给出的Reactor Design Pattern的解释：</p>
<blockquote>
<p>The Reactor design pattern is an <strong>event handling pattern</strong> for handling service <strong>requests delivered concurrently</strong> <s>to a service handler</s> by one or more inputs. The service handler then <strong>demultiplexes the incoming requests</strong> and <strong>dispatchers them synchronously</strong> to the associated request handlers.</p>
</blockquote>
<p>Google Translate:</p>
<blockquote>
<p>Reactor 设计模式是一种事件处理模式，用于处理通过一个或多个输入同时交付给服务处理程序的服务请求。 然后，服务处理程序对传入的请求进行多路分解，并将它们同步分配给相关联的请求处理程序。</p>
</blockquote>
<ul>
<li>Reactor四个重要组件
<ul>
<li>Event事件</li>
<li>Reactor反应堆</li>
<li>Demultiplex事件分发器</li>
<li>EventHandler事件处理器</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">%%时序图例子</span><br><span class="line">sequenceDiagram</span><br><span class="line">	participant Event</span><br><span class="line">	participant Reactor</span><br><span class="line">	participant Demultiplex</span><br><span class="line">	participant EventHandler</span><br><span class="line">	Event -&gt;&gt; Reactor: 注册Event和Handler</span><br><span class="line">	loop 事件集合</span><br><span class="line">		Reactor -&gt; Reactor:Event集合</span><br><span class="line">	end</span><br><span class="line">	Reactor -&gt;&gt; Demultiplex: 向Epoll add/mod/del Event</span><br><span class="line">	Reactor -&gt;&gt; Demultiplex: 启动反应堆</span><br><span class="line">    loop 事件分发器</span><br><span class="line">    	Demultiplex -&gt; Demultiplex:开启事件循环epoll_wait</span><br><span class="line">    end</span><br><span class="line">    Demultiplex -&gt;&gt; Reactor: 返回发生事件的Event</span><br><span class="line">    Reactor -&gt;&gt; EventHandler: 调用Event对应的事件处理器EventHandler</span><br></pre></td></tr></table></div></figure>

        <h1 id="epoll"   >
          <a href="#epoll" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#epoll"></a> epoll</h1>
      

        <h2 id="select和poll的缺点"   >
          <a href="#select和poll的缺点" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#select和poll的缺点"></a> select和poll的缺点</h2>
      
<ul>
<li>select的缺点：
<ul>
<li>单个进程能够监视的文件描述符的数量存在最大限制，通常是1024（可更改：<code>#define __FD_SETSIZE 1024</code>），但由于select采用轮询的方式扫描文件描述符，则文件描述符数量越多，性能就越差。</li>
<li>内核/用户空间内存拷贝问题，select需要复制大量的句柄数据结构，产生巨大的开销</li>
<li>select返回的是含有整个句柄的数组，应用程序需要遍历整个数组才能发现哪些句柄发生了事件</li>
<li>select的触发方式是水平触发，应用程序如果没有完成对一个已经就绪的文件描述符进行IO操作，那么之后每次select调用还是会将这些文件描述符通知进程（意思就是一件事情处理得太拖沓，拖延好几次才完成，影响效率）。其实epoll的LT模式也是这样。但是ET模式效率不一定比LT好。</li>
</ul>
</li>
<li>poll
<ul>
<li>相比select模型，poll使用链表保存文件描述符，因此没有了监视文件数量的限制，但其他三个缺点依然存在。</li>
</ul>
</li>
</ul>
<blockquote>
<p>以select模型为例，假设我们的服务器需要支持100万的并发连接，则在__FD_SETSIZE 为1024的情况下，则我们至少需要开辟1k个进程才能实现100万的并发连接。除了进程间上下文切换的时间消耗外，从内核/用户空间大量的句柄结构内存拷贝、数组轮询等，是系统难以承受的。因此，基于select模型的服务器程序，要达到100万级别的并发访问，是一个很难完成的任务。</p>
</blockquote>

        <h2 id="epoll原理及优势"   >
          <a href="#epoll原理及优势" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#epoll原理及优势"></a> epoll原理及优势</h2>
      
<p>epoll的实现机制与select/poll机制完全不同。</p>
<p>epoll通过在Linux内核中申请一个简易的文件系统，提升了效率。</p>
<blockquote>
<p>文件系统一般用什么数据结构实现——B+树，磁盘IO消耗低、效率很高。</p>
</blockquote>
<p>把原先的select/poll调用分成以下3个部分：</p>
<ol>
<li>
<p>调用<code>epoll_create()</code>建立一个<code>epoll对象</code>（在<code>epoll文件系统</code>中为这个<code>句柄对象</code>分配资源）</p>
<ul>
<li>
<p><code>epoll_create</code>在内核上创建的<code>eventpoll</code>结构如下：</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">eventpoll</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">/* 红黑树的根节点，这棵树中存储着所有添加到epoll中的需要监控的事件*/</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rb_root</span> rbr;</span><br><span class="line">    <span class="comment">/* 双链表中则存放着将要通过epoll_wait返回给用户的满足条件的事件*/</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">list_head</span> rdlist;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</li>
</ul>
</li>
<li>
<p>调用<code>epoll_ctl</code>向<code>epoll</code>对象中添加这100万个连接的套接字</p>
</li>
<li>
<p>调用<code>epoll_wait</code>收集发生的事件的<code>fd</code>资源</p>
</li>
</ol>
<blockquote>
<p>如此一来，要实现上面说的场景，只需在进程启动时建立一个<code>epoll对象</code>，然后在需要时像这个<code>epoll对象</code>中添加或者删除事件。同时<code>epoll_wait</code>时，并没有向操作系统复制这100万个连接的句柄数据，内核也不需要去遍历全部的事件。</p>
</blockquote>
<ul>
<li>LT模式，muduo采用的是LT模式
<ul>
<li>特点：内核数据没被读完，就会一直上报数据</li>
<li>不会丢失数据或者消息
<ul>
<li>应用没有读取完数据，内核会不断上报</li>
</ul>
</li>
<li>低延迟处理
<ul>
<li>每次读数据只需要一次系统调用，照顾了多个连接的公平性，不会因为某个连接上的数据量过大而影响其他连接处理消息</li>
</ul>
</li>
<li>跨平台处理
<ul>
<li>像select一样可以跨平台使用</li>
</ul>
</li>
</ul>
</li>
<li>ET模式
<ul>
<li>特点：内核数据只上报一次，效率相对较高</li>
</ul>
</li>
</ul>

        <h1 id="muduo网络库编程准备"   >
          <a href="#muduo网络库编程准备" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#muduo网络库编程准备"></a> muduo网络库编程准备</h1>
      

        <h2 id="开发环境"   >
          <a href="#开发环境" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#开发环境"></a> 开发环境</h2>
      
<ol>
<li>ubuntu linux</li>
<li>安装json开发库</li>
<li>安装boost + muduo网络库开发环境<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/QIANGWEIYUAN/article/details/89023980" >muduo库源码编译安装</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li>安装redis环境</li>
<li>安装mysql数据库环境</li>
<li>安装nginx</li>
<li>安装cmake环境</li>
</ol>
<ul>
<li>配置远程开发环境
<ul>
<li><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq756684177/article/details/94236990" >windows+vscode配置远程linux开发环境</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>
<ol>
<li>linux系统运行sshd服务</li>
<li>在vscode上安装Remote Development插件，其依赖插件会自动安装</li>
</ol>
</li>
<li><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/QIANGWEIYUAN/article/details/89469717" >VS环境创建远程linux跨平台项目</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li>vscode在linux环境下直接开发</li>
</ul>
</li>
</ul>

        <h2 id="安装流程"   >
          <a href="#安装流程" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#安装流程"></a> 安装流程</h2>
      
<ol>
<li>muduo库是基于boost开发的，所以需要先在Linux平台上安装boost库。需要注意，boost库的编译需要安装gcc、make等基础工具才行。环境：Ubuntu 20.04.6，太新的Ubuntu由于无法兼容旧代码，不能安装。
<ol>
<li><code>tar -xzvf boost_1_69_0.tar.gz</code>解压</li>
<li>执行<code>./bootstrap.sh</code>：也可以在后面加<code>--prefix=/usr/local</code>指定安装目录（默认路径）</li>
<li><code>./b2</code>安装（如果Linux系统没有安装g++编译器，需要先安装）</li>
<li>最后，再把上面的boost库头文件和lib库文件安装在默认的Linux系统头文件和库文件的搜索路径下，运行下面命令（因为要给/usr目录下拷贝文件，需要先进入root用户）：<code>sudo ./b2 install</code></li>
<li>sudo ldconfig​更新链接库缓存</li>
<li>验证安装boost是否成功，通过下面的代码验证一下：<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/bind.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Hello</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">say</span><span class="params">(string name)</span> </span></span><br><span class="line"><span class="function">	</span>&#123; cout &lt;&lt; name &lt;&lt; <span class="string">&quot; say: hello world!&quot;</span> &lt;&lt; endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Hello h;</span><br><span class="line">	<span class="keyword">auto</span> func = boost::<span class="built_in">bind</span>(&amp;Hello::say, &amp;h, <span class="string">&quot;zhang san&quot;</span>);</span><br><span class="line">	<span class="built_in">func</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;<span class="comment">//运行结果zhang san say: hello world!</span></span><br></pre></td></tr></table></div></figure>
</li>
</ol>
</li>
<li><code>unzip muduo-master.zip</code></li>
<li><code>cd muduo-master</code></li>
<li>muduo库源码编译会编译很多<code>unit_test</code>测试用例代码，编译耗时长，我们用不到，vim编辑上面源码目录里面的<code>CMakeLists.txt</code>文件，如下修改：   <img src="../../images/%E5%AD%A6%E4%B9%A0muduo%E5%BA%93%E7%9A%84%E6%80%9D%E6%83%B3/image-20250712185725471.png" alt="" /></li>
<li><code>./build.sh</code>源码编译构建程序，运行该程序（注意：muduo是用cmake来构建的，需要先安装cmake，ubuntu下<code>sudo apt-get install cmake</code>就可以，redhat或者centos可以从yum仓库安装）</li>
<li>编译完成后，输入<code>./build.sh install</code>命令进行muduo库安装。但这个<code>./build.sh install</code>实际上把muduo的头文件和lib库文件放到了<code>muduo-master</code>同级目录下的<code>build</code>目录下的<code>release-install-cpp11</code>文件夹下面了<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@tony-virtual-machine:/home/tony/package# <span class="built_in">ls</span></span><br><span class="line">build  muduo-master  muduo-master.zip</span><br><span class="line">root@tony-virtual-machine:/home/tony/package# <span class="built_in">cd</span> build/</span><br><span class="line">root@tony-virtual-machine:/home/tony/package/build# <span class="built_in">ls</span></span><br><span class="line">release-cpp11  release-install-cpp11</span><br><span class="line">root@tony-virtual-machine:/home/tony/package/build# <span class="built_in">cd</span> release-install-cpp11/</span><br><span class="line">root@tony-virtual-machine:/home/tony/package/build/release-install-cpp11# <span class="built_in">ls</span></span><br><span class="line">include  lib</span><br></pre></td></tr></table></div></figure>
所以上面的install命令并没有把它们拷贝到系统路径下，导致我们每次编译程序都需要指定muduo库的头文件和库文件路径，很麻烦，所以我们选择直接把inlcude（头文件）和lib（库文件）目录下的文件拷贝到系统目录下（需要sudo）：<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@tony-virtual-machine:/home/tony/package/build/release-install-cpp11# <span class="built_in">ls</span></span><br><span class="line">include  lib</span><br><span class="line">root@tony-virtual-machine:/home/tony/package/build/release-install-cpp11# <span class="built_in">cd</span> include/</span><br><span class="line">root@tony-virtual-machine:/home/tony/package/build/release-install-cpp11/include# <span class="built_in">ls</span></span><br><span class="line">muduo</span><br><span class="line">root@tony-virtual-machine:/home/tony/package/build/release-install-cpp11/include# <span class="built_in">mv</span> muduo/ /usr/include/</span><br><span class="line">root@tony-virtual-machine:/home/tony/package/build/release-install-cpp11/include# <span class="built_in">cd</span> ..</span><br><span class="line">root@tony-virtual-machine:/home/tony/package/build/release-install-cpp11# <span class="built_in">ls</span></span><br><span class="line">include  lib</span><br><span class="line">root@tony-virtual-machine:/home/tony/package/build/release-install-cpp11# <span class="built_in">cd</span> lib/</span><br><span class="line">root@tony-virtual-machine:/home/tony/package/build/release-install-cpp11/lib# <span class="built_in">ls</span></span><br><span class="line">libmuduo_base.a  libmuduo_http.a  libmuduo_inspect.a  libmuduo_net.a</span><br><span class="line">root@tony-virtual-machine:/home/tony/package/build/release-install-cpp11/lib# <span class="built_in">mv</span> * /usr/local/lib/</span><br><span class="line">root@tony-virtual-machine:/home/tony/package/build/release-install-cpp11/lib# </span><br></pre></td></tr></table></div></figure>
拷贝完成以后使用muduo库编写<code>C++</code>网络程序，不用在指定头文件和lib库文件路径信息了，因为<code>g++</code>会自动从<code>/usr/include</code>和<code>/usr/local/lib</code>路径下寻找所需要的文件。</li>
</ol>

        <h2 id="测试代码"   >
          <a href="#测试代码" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#测试代码"></a> 测试代码</h2>
      
<p>测试muduo是否能够正常使用，编写一个简单的echo回显服务器，如下：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/TcpServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/base/Logging.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/bind.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;muduo/net/EventLoop.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用muduo开发回显服务器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EchoServer</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">EchoServer</span>(muduo::net::EventLoop* loop,</span><br><span class="line">             <span class="type">const</span> muduo::net::InetAddress&amp; listenAddr);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>; </span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">onConnection</span><span class="params">(<span class="type">const</span> muduo::net::TcpConnectionPtr&amp; conn)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(<span class="type">const</span> muduo::net::TcpConnectionPtr&amp; conn,</span></span></span><br><span class="line"><span class="params"><span class="function">                 muduo::net::Buffer* buf,</span></span></span><br><span class="line"><span class="params"><span class="function">                 muduo::Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">  muduo::net::TcpServer server_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">EchoServer::<span class="built_in">EchoServer</span>(muduo::net::EventLoop* loop,</span><br><span class="line">                       <span class="type">const</span> muduo::net::InetAddress&amp; listenAddr)</span><br><span class="line">  : <span class="built_in">server_</span>(loop, listenAddr, <span class="string">&quot;EchoServer&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">  server_.<span class="built_in">setConnectionCallback</span>(</span><br><span class="line">      boost::<span class="built_in">bind</span>(&amp;EchoServer::onConnection, <span class="keyword">this</span>, _1));</span><br><span class="line">  server_.<span class="built_in">setMessageCallback</span>(</span><br><span class="line">      boost::<span class="built_in">bind</span>(&amp;EchoServer::onMessage, <span class="keyword">this</span>, _1, _2, _3));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EchoServer::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  server_.<span class="built_in">start</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EchoServer::onConnection</span><span class="params">(<span class="type">const</span> muduo::net::TcpConnectionPtr&amp; conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  LOG_INFO &lt;&lt; <span class="string">&quot;EchoServer - &quot;</span> &lt;&lt; conn-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toIpPort</span>() &lt;&lt; <span class="string">&quot; -&gt; &quot;</span></span><br><span class="line">           &lt;&lt; conn-&gt;<span class="built_in">localAddress</span>().<span class="built_in">toIpPort</span>() &lt;&lt; <span class="string">&quot; is &quot;</span></span><br><span class="line">           &lt;&lt; (conn-&gt;<span class="built_in">connected</span>() ? <span class="string">&quot;UP&quot;</span> : <span class="string">&quot;DOWN&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EchoServer::onMessage</span><span class="params">(<span class="type">const</span> muduo::net::TcpConnectionPtr&amp; conn,</span></span></span><br><span class="line"><span class="params"><span class="function">                           muduo::net::Buffer* buf,</span></span></span><br><span class="line"><span class="params"><span class="function">                           muduo::Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 接收到所有的消息，然后回显</span></span><br><span class="line">  <span class="function">muduo::string <span class="title">msg</span><span class="params">(buf-&gt;retrieveAllAsString())</span></span>;</span><br><span class="line">  LOG_INFO &lt;&lt; conn-&gt;<span class="built_in">name</span>() &lt;&lt; <span class="string">&quot; echo &quot;</span> &lt;&lt; msg.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot; bytes, &quot;</span></span><br><span class="line">           &lt;&lt; <span class="string">&quot;data received at &quot;</span> &lt;&lt; time.<span class="built_in">toString</span>();</span><br><span class="line">  conn-&gt;<span class="built_in">send</span>(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  LOG_INFO &lt;&lt; <span class="string">&quot;pid = &quot;</span> &lt;&lt; <span class="built_in">getpid</span>();</span><br><span class="line">  muduo::net::EventLoop loop;</span><br><span class="line">  muduo::<span class="function">net::InetAddress <span class="title">listenAddr</span><span class="params">(<span class="number">8888</span>)</span></span>;</span><br><span class="line">  <span class="function">EchoServer <span class="title">server</span><span class="params">(&amp;loop, listenAddr)</span></span>;</span><br><span class="line">  server.<span class="built_in">start</span>();</span><br><span class="line">  loop.<span class="built_in">loop</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>使用g++进行编译，注意链接muduo和pthread的库文件，编译命令如下：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ main.cpp -lmuduo_net -lmuduo_base -lpthread -std=c++11</span><br></pre></td></tr></table></div></figure>
<p>编译链接完成，生成a.out可执行程序，上面的echo服务器监听8888端口，运行上面的a.out回显服务器如下：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@tony-virtual-machine:/home/tony/code# ./a.out </span><br><span class="line">20190404 08:00:15.254790Z 42660 INFO  pid = 42660 - main.cpp:61</span><br></pre></td></tr></table></div></figure>
<p>等待客户端连接，可以打开一个新的shell命令行用netcat命令模拟客户端连接echo服务器进行功能测试，命令如下：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tony@tony-virtual-machine:~$ <span class="built_in">echo</span> <span class="string">&quot;hello world&quot;</span> | nc localhost 8888</span><br><span class="line"></span><br><span class="line">hello world <span class="comment">#客户端数据回显</span></span><br></pre></td></tr></table></div></figure>
<p>客户端数据回显正确，看看服务器接日志信息打印如下：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@tony-virtual-machine:/home/tony/code# ./a.out </span><br><span class="line">20190404 08:00:15.254790Z 42660 INFO  pid = 42660 - main.cpp:61</span><br><span class="line">20190404 08:00:59.438626Z 42660 INFO  TcpServer::newConnection [EchoServer] - new connection [EchoServer-0.0.0.0:8888#1] from 127.0.0.1:33480 - TcpServer.cc:80</span><br><span class="line">20190404 08:00:59.438707Z 42660 INFO  EchoServer - 127.0.0.1:33480 -&gt; 127.0.0.1:8888 is UP - main.cpp:42</span><br><span class="line">20190404 08:00:59.438812Z 42660 INFO  EchoServer-0.0.0.0:8888#1 <span class="built_in">echo</span> 12 bytes, data received at 1554364859.438723 - main.cpp:53</span><br></pre></td></tr></table></div></figure>
<p>到此，muduo安装成功，能够正常进行C++网络程序开发！</p>

        <h2 id="配置链接库-头文件"   >
          <a href="#配置链接库-头文件" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#配置链接库-头文件"></a> 配置链接库、头文件</h2>
      
<p>muduo库的使用需要链接<code>lib</code>库文件，一般为<code>.so</code>文件。一般<code>.so</code>文件都在<code>/usr/lib或/usr/local/lib</code>路径下。</p>
<p>编译链接使用muduo库的程序需要加后缀<code>-l ...</code></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/lib or /usr/local/lib</span></span><br><span class="line"><span class="comment"># 3 lib: libmuduo_base.so; libmuduo_net.so; libpthread.so</span></span><br><span class="line">-lmuduo_net -lmuduo_base -lpthread</span><br><span class="line"><span class="comment"># 注意顺序，net需要写在前面，因为net依赖base；base写中间，因为依赖phtread</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="如何在vscode配置这三个库"   >
          <a href="#如何在vscode配置这三个库" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#如何在vscode配置这三个库"></a> 如何在vscode配置这三个库？</h3>
      
<p>vscode中按<code>F1</code>键，搜索<code>edit configurations</code>，将会打开：</p>
<p>项目目录下的<code>.vscode</code>文件夹下的<code>c_cpp_properties.json</code></p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;includePath&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$&#123;workspaceFolder&#125;/**&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;defines&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;compilerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/usr/bin/gcc&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cppStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c++20&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;intelliSenseMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux-gcc-x64&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></div></figure>
<p>build构建项目的快捷键是<code>ctrl+shift+B</code>键，但若你没有配置过build流程，将会弹出选项让你配置。实际上就是让你配置<code>.vscode</code>下的<code>tasks.json</code>。</p>
<blockquote>
<p>除了上面这两个json文件，vscode下的cpp项目中还有一个json配置文件是launch.json，是关于调试的配置信息。</p>
</blockquote>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// See https://go.microsoft.com/fwlink/?LinkId=733558</span></span><br><span class="line">    <span class="comment">// for the documentation about the tasks.json format</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tasks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shell&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/usr/bin/g++&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;-g&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;$&#123;file&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;-o&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;$&#123;fileDirname&#125;/$&#123;fileBasenameNoExtension&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/usr/bin&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$gcc&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></div></figure>
<p>其中，<code>args</code>键就是build时编译链接命令后面加的参数。</p>
<p>我们在此使用muduo库，若想用vscode来一键build，则可以在args里加上三个参数。</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">	<span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="comment">// ...</span></span><br><span class="line">              <span class="string">&quot;-lmuduo_net&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;-lmuduo_base&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;-lpthread&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></div></figure>
<p>如果配置文件写好了，则就可以在vscode下一键build。</p>

        <h1 id="muduo网络库的多线程模型"   >
          <a href="#muduo网络库的多线程模型" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#muduo网络库的多线程模型"></a> muduo网络库的多线程模型</h1>
      
<ul>
<li>
<p>网络服务器编程常用模型</p>
<ol>
<li>accept + read/write : 不是并发服务器</li>
<li>accpet + fork (process-pre-connection) : 适合并发连接数不大，计算任务工作量大于fork的开销</li>
<li>accept + thread (thread-pre-connection) : 比方案2的开销小了一点，但是并发造成线程堆积过多</li>
<li>reactors in threads (one loop per thread) : 是muduo的网络设计。有一个main reactor负载accept连接，然后把连接分发到某个sub reactor(采用round-robin的方式来选择sub reactor)，该连接的操作都在sub reactor所处的线程中完成。多个连接可能被分派到多个线程中，以充分利用CPU。</li>
<li>reactors in process  (one loop pre process) : 是nginx服务器的网络模块设计，基于进程设计，采用多个Reactors充当I/O进程和工作进程，通过一把accept锁完美解决多个Reactors的“惊群现象”。</li>
</ol>
</li>
<li>
<p>muduo底层的模型</p>
</li>
</ul>
<p>muduo的网络设计：reactors in threads - one loop per thread.</p>
<p>方案的特点是&quot;one loop per thread&quot;，有一个main reactor负责accept连接，然后把连接分发到某个sub reactor（轮询方式选择）。该连接的所有操作都在该reactor所处的线程中完成。多个连接可能被分派到多个线程中，以充分利用CPU。如果有过多的耗费CPU IO的计算任务，可以设置一个专门处理耗时计算任务的线程负责处理该类任务。</p>
<p>reactor poll的大小根据CPU核心的数目确定。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置EventLoop的线程个数，底层通过EventLoopThreadPool线程池管理线程类EventLoopThread</span></span><br><span class="line">_server.<span class="built_in">setThreadNum</span>(<span class="number">10</span>);</span><br></pre></td></tr></table></div></figure>

        <h1 id="基于muduo的服务器程序"   >
          <a href="#基于muduo的服务器程序" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#基于muduo的服务器程序"></a> 基于muduo的服务器程序</h1>
      

        <h2 id="muduo网络库提供的类"   >
          <a href="#muduo网络库提供的类" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#muduo网络库提供的类"></a> muduo网络库提供的类</h2>
      
<ol>
<li>TcpServer：用于编写服务器程序的。</li>
<li>TcpClient：用于编写客户端程序的。</li>
</ol>
<p>这两个类，实际上就是把<code>epoll+线程池</code>封装在一起了。好处就是把网络IO代码和业务代码区分开，使程序员可以专心开发业务代码。</p>
<p>业务代码关注的两件事情：</p>
<ol>
<li>用户的连接与断开</li>
<li>用户的可读写事件</li>
</ol>
<p>但这两件事情，如果我们使用了网络库，则如何监听、何时发生事件全都由网络库给程序员上报。</p>

        <h2 id="muduo库中tcpserver类中重要的回调属性"   >
          <a href="#muduo库中tcpserver类中重要的回调属性" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#muduo库中tcpserver类中重要的回调属性"></a> muduo库中TcpServer类中重要的回调属性</h2>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setConnectionCallback</span><span class="params">(<span class="type">const</span> ConnectionCallback&amp; cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    connectionCallback_ = cb;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setMessageCallback</span><span class="params">(<span class="type">const</span> MessageCallback &amp; cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    messageCallback_ = cb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> std::function&lt;<span class="type">void</span> (<span class="type">const</span> TcpConnectionPtr&amp;)&gt; ConnectionCallback;</span><br><span class="line"><span class="keyword">typedef</span> std::function&lt;<span class="type">void</span> (<span class="type">const</span> TcpConnectionPtr&amp;, Buffer*, Timestamp)&gt; MessageCallback;</span><br></pre></td></tr></table></div></figure>

        <h2 id="代码示例-chatserver"   >
          <a href="#代码示例-chatserver" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#代码示例-chatserver"></a> 代码示例 - ChatServer</h2>
      
<p>需要包含的头文件</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;muduo/net/TcpServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;muduo/net/EventLoop.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::placeholders;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br></pre></td></tr></table></div></figure>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ChatServer</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/* 在其中：</span></span><br><span class="line"><span class="comment">     * 1、类内构造TcpServer，初始化EventLoop指针</span></span><br><span class="line"><span class="comment">     * 2、给TcpServer注册用户连接的创建、连接的断开回调</span></span><br><span class="line"><span class="comment">     * 3、给TcpServer注册用户读写事件回调</span></span><br><span class="line"><span class="comment">     * 4、设置TcpServer的线程数量，muduo库会自己分配IO线程和工作线程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">ChatServer</span>(muduo::net::EventLoop* loop, <span class="comment">//事件循环</span></span><br><span class="line">               <span class="type">const</span> muduo::net::InetAddress&amp; listenAddr,   <span class="comment">//IP+port</span></span><br><span class="line">               <span class="type">const</span> std::string&amp; nameArg)  <span class="comment">//服务器的名字</span></span><br><span class="line">        : <span class="built_in">m_server</span>(loop, listenAddr, nameArg),</span><br><span class="line">          <span class="built_in">m_loop</span>(loop)</span><br><span class="line">    &#123;</span><br><span class="line">        m_server.<span class="built_in">setConnectionCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onConnection, <span class="keyword">this</span>, _1));</span><br><span class="line">        m_server.<span class="built_in">setMessageCallback</span>(std::<span class="built_in">bind</span>(&amp;ChatServer::onMessage, <span class="keyword">this</span>, _1, _2, _3));</span><br><span class="line">        m_server.<span class="built_in">setThreadNum</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//开启事件循环</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_server.<span class="built_in">start</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//当发生用户的连接创建、连接断开事件后，调用函数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onConnection</span><span class="params">(<span class="type">const</span> muduo::net::TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//读写事件发生后，调用函数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(<span class="type">const</span> muduo::net::TcpConnectionPtr &amp;conn,</span></span></span><br><span class="line"><span class="params"><span class="function">                   muduo::net::Buffer * buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">                   muduo::Timestamp time)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    muduo::net::TcpServer m_server;</span><br><span class="line">    muduo::net::EventLoop * m_loop;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

        <h3 id="编写回调函数"   >
          <a href="#编写回调函数" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#编写回调函数"></a> 编写回调函数</h3>
      
<p>OnConnection和OnMessage</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当发生用户的连接创建、连接断开事件后，调用函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">onConnection</span><span class="params">(<span class="type">const</span> muduo::net::TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; conn-&gt;<span class="built_in">peerAddress</span>().<span class="built_in">toIpPort</span>() &lt;&lt; <span class="string">&quot; -&gt; &quot;</span> &lt;&lt;</span><br><span class="line">        conn-&gt;<span class="built_in">localAddress</span>().<span class="built_in">toIpPort</span>() &lt;&lt; <span class="string">&quot; state:&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(conn-&gt;<span class="built_in">connected</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot; online.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot; offline.&quot;</span></span><br><span class="line">        conn-&gt;<span class="built_in">shutdown</span>();</span><br><span class="line">        <span class="comment">//_loop-&gt;quit();</span></span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//读写事件发生后，调用函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(<span class="type">const</span> muduo::net::TcpConnectionPtr &amp;conn,</span></span></span><br><span class="line"><span class="params"><span class="function">               muduo::net::Buffer * buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">               muduo::Timestamp time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string buf = buffer-&gt;<span class="built_in">retrieveAllAsString</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;recv data: &quot;</span> &lt;&lt; buf &lt;&lt; <span class="string">&quot; time: &quot;</span> &lt;&lt; time.<span class="built_in">toString</span>() &lt;&lt; std::endl;</span><br><span class="line">    conn-&gt;<span class="built_in">send</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="主函数"   >
          <a href="#主函数" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#主函数"></a> 主函数</h3>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    muduo::net::EventLoop loop; <span class="comment">//相当于创建了一个epoll</span></span><br><span class="line">    muduo::<span class="function">net::InetAddress <span class="title">addr</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6000</span>)</span></span>;</span><br><span class="line">    <span class="function">ChatServer <span class="title">chatserver</span><span class="params">(&amp;loop, addr, <span class="string">&quot;mychat&quot;</span>)</span></span>;</span><br><span class="line">    chatserver.<span class="built_in">start</span>();</span><br><span class="line">    loop.<span class="built_in">loop</span>();    <span class="comment">//相当于调用epoll_wait，以阻塞方式等待新用户连接事件、已连接用户的读写事件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="测试服务器程序"   >
          <a href="#测试服务器程序" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#测试服务器程序"></a> 测试服务器程序</h3>
      
<p>首先，编译链接需要加后缀<code>-lmuduo_net -lmuduo_base -lpthread</code>。</p>
<p>编译链接后，执行程序。</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./chatserver</span><br></pre></td></tr></table></div></figure>
<p>可以通过telnet连接服务器。</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet 127.0.0.1 6000</span><br></pre></td></tr></table></div></figure>

        <h4 id="运行结果"   >
          <a href="#运行结果" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#运行结果"></a> 运行结果</h4>
      
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xcg@ubuntu:~$ telnet 127.0.0.1 6000</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">hello!					#客户端输入显示到屏幕上的，发送给服务器的内容</span><br><span class="line">hello!					#收到的服务器复制后回发的一模一样的内容。</span><br><span class="line">^]</span><br><span class="line">telnet&gt; quit</span><br><span class="line">Connection closed.</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xcg@ubuntu:~/muduo-0528$ ./chatserver </span><br><span class="line">20220528 08:10:49.554317Z  8116 INFO  TcpServer::newConnection [mychat] - new connection [mychat-127.0.0.1:6000#1] from 127.0.0.1:60338 - TcpServer.cc:80</span><br><span class="line">127.0.0.1:60338 -&gt; 127.0.0.1:6000 state: online.</span><br><span class="line">recv data: hello!</span><br><span class="line"> time: 1653725453.563665</span><br><span class="line">127.0.0.1:60338 -&gt; 127.0.0.1:6000 state: offline.</span><br><span class="line">20220528 08:10:56.835295Z  8116 INFO  TcpServer::removeConnectionInLoop [mychat] - connection mychat-127.0.0.1:6000#1 - TcpServer.cc:109</span><br></pre></td></tr></table></div></figure>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/Cpp/Cpp_%E7%BA%BF%E7%A8%8B%E5%BA%93/">Cpp_线程库</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2022-03-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2024-08-29</span></span><span class="post-meta-item post-meta-item--visitors leancloud_visitors" id="/Cpp/Cpp_%E7%BA%BF%E7%A8%8B%E5%BA%93/" data-flag-title="Cpp_线程库"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value leancloud-visitors-count"></span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="内容"   >
          <a href="#内容" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#内容"></a> 内容</h1>
      
<ol>
<li>线程的构造</li>
<li>detach、join</li>
<li>mutex、recursive_mutex、shared_mutex</li>
<li>lock_guard、unique_lock、shared_lock</li>
<li>chrono</li>
<li><code>std::ref</code></li>
<li>jthread
<ol>
<li>线程取消</li>
</ol>
</li>
<li>条件变量
<ol>
<li>wait、wait_for、wait_until</li>
</ol>
</li>
<li>future、promise
<ol>
<li>packaged_task</li>
<li>async</li>
</ol>
</li>
<li>信号量</li>
<li>闩锁（latch）、屏障（Barrier）</li>
</ol>

        <h1 id="卖票"   >
          <a href="#卖票" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#卖票"></a> 卖票</h1>
      
<ol>
<li>用<code>std::thread</code>构造。
<ol>
<li>参数1填函数地址。</li>
<li>参数2填函数参数，没有则不填。</li>
<li>遵循的是RAII，构造完即开始运行。</li>
</ol>
</li>
<li>线程对象有<code>detach</code>方法用来脱离主线程的管理。防止主线程先于子线程结束导致线程因为整个进程提前终止而未执行完毕。</li>
<li>也可以使用<code>th.join()</code>方法来让主线程等待子线程执行结束。相当于WaitForSingleObject</li>
<li><code>std::this_thread::sleep_for</code>可以用于线程睡眠。
<ol>
<li>可以使用<code>&lt;chrono&gt;</code>库下的<code>std::chrono::milliseconds(n)</code>来指定时间单位。</li>
<li><code>C++17</code>之后可以使用<code>using namespace std::chrono_literals</code>用于把字面常量标识符映射为秒、毫秒等。</li>
</ol>
</li>
</ol>
<p><img src="../../images/Cpp_%E7%BA%BF%E7%A8%8B%E5%BA%93/image-20240722225224344.png" alt="" /></p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="keyword">constinit</span> <span class="type">int</span> tickets = <span class="number">100</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station2</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">th</span><span class="params">(&amp;station)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">th2</span><span class="params">(&amp;station2)</span></span>;</span><br><span class="line">    th.<span class="built_in">detach</span>();</span><br><span class="line">    th<span class="number">2.</span><span class="built_in">detach</span>();</span><br><span class="line">    <span class="comment">//std::this_thread::sleep_for(std::chrono::milliseconds(10000));</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">10000</span>ms);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::wcout &lt;&lt; <span class="string">L&quot;Station #1: &quot;</span> &lt;&lt; tickets-- &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station2</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::wcout &lt;&lt; <span class="string">L&quot;Station #2: &quot;</span> &lt;&lt; tickets-- &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="输出"   >
          <a href="#输出" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#输出"></a> 输出</h2>
      
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">Station #1: 100</span><br><span class="line">Station #1: 99</span><br><span class="line">Station #1: 98</span><br><span class="line">Station #1: 97</span><br><span class="line">Station #1: 96</span><br><span class="line">Station #1: 95</span><br><span class="line">Station #1: 94</span><br><span class="line">Station #1: 93</span><br><span class="line">Station #1: 92</span><br><span class="line">Station #1: 91</span><br><span class="line">Station #1: 90</span><br><span class="line">Station #1: 89</span><br><span class="line">Station #1: 88</span><br><span class="line">Station #1: 87</span><br><span class="line">Station #2: 86</span><br><span class="line">Station #2: 85</span><br><span class="line">Station #2: 84</span><br><span class="line">Station #2: 83</span><br><span class="line">Station #2: 82</span><br><span class="line">Station #2: 81</span><br><span class="line">Station #2: 80</span><br><span class="line">Station #2: 79</span><br><span class="line">Station #2: 78</span><br><span class="line">Station #2: 77</span><br><span class="line">Station #2: 76</span><br><span class="line">Station #2: 75</span><br><span class="line">Station #2: 74</span><br><span class="line">Station #2: 73</span><br><span class="line">Station #2: 72</span><br><span class="line">Station #2: 71</span><br><span class="line">Station #2: 70</span><br><span class="line">Station #2: 69</span><br><span class="line">Station #2: 68</span><br><span class="line">Station #2: 67</span><br><span class="line">Station #2: 66</span><br><span class="line">Station #2: 65</span><br><span class="line">Station #2: 64</span><br><span class="line">Station #2: 63</span><br><span class="line">Station #2: 62</span><br><span class="line">Station #1: 61</span><br><span class="line">Station #1: 60</span><br><span class="line">Station #1: 59</span><br><span class="line">Station #1: 58</span><br><span class="line">Station #1: 57</span><br><span class="line">Station #1: 56</span><br><span class="line">Station #1: 55</span><br><span class="line">Station #1: 54</span><br><span class="line">Station #1: 53</span><br><span class="line">Station #1: 52</span><br><span class="line">Station #1: 51</span><br><span class="line">Station #1: 50</span><br><span class="line">Station #1: 49</span><br><span class="line">Station #1: 48</span><br><span class="line">Station #1: 47</span><br><span class="line">Station #1: 46</span><br><span class="line">Station #1: 45</span><br><span class="line">Station #1: 44</span><br><span class="line">Station #1: 43</span><br><span class="line">Station #1: 42</span><br><span class="line">Station #1: 41</span><br><span class="line">Station #1: 40</span><br><span class="line">Station #1: 39</span><br><span class="line">Station #1: 38</span><br><span class="line">Station #1: 37</span><br><span class="line">Station #1: 36</span><br><span class="line">Station #1: 35</span><br><span class="line">Station #1: 34</span><br><span class="line">Station #1: 33</span><br><span class="line">Station #1: 32</span><br><span class="line">Station #1: 31</span><br><span class="line">Station #1: 30</span><br><span class="line">Station #1: 29</span><br><span class="line">Station #1: 28</span><br><span class="line">Station #1: 27</span><br><span class="line">Station #1: 26</span><br><span class="line">Station #2: 25</span><br><span class="line">Station #2: 24</span><br><span class="line">Station #2: 23</span><br><span class="line">Station #1: 22</span><br><span class="line">Station #1: 21</span><br><span class="line">Station #1: 20</span><br><span class="line">Station #1: 19</span><br><span class="line">Station #1: 18</span><br><span class="line">Station #1: 17</span><br><span class="line">Station #1: 16</span><br><span class="line">Station #1: 15</span><br><span class="line">Station #1: 14</span><br><span class="line">Station #1: 13</span><br><span class="line">Station #1: 12</span><br><span class="line">Station #1: 11</span><br><span class="line">Station #1: 10</span><br><span class="line">Station #1: 9</span><br><span class="line">Station #1: 8</span><br><span class="line">Station #1: 7</span><br><span class="line">Station #1: 6</span><br><span class="line">Station #1: 5</span><br><span class="line">Station #1: 4</span><br><span class="line">Station #1: 3</span><br><span class="line">Station #1: 2</span><br><span class="line">Station #1: 1</span><br><span class="line">Station #2: 0</span><br></pre></td></tr></table></div></figure>
<p>发现把0号票卖掉了，错误。</p>

        <h1 id="mutex互斥量"   >
          <a href="#mutex互斥量" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mutex互斥量"></a> mutex（互斥量）</h1>
      
<p>定义于<code>&lt;mutex&gt;</code>中。</p>

        <h2 id="特性"   >
          <a href="#特性" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#特性"></a> 特性</h2>
      

        <h3 id="构造函数以及不可复制性"   >
          <a href="#构造函数以及不可复制性" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#构造函数以及不可复制性"></a> 构造函数以及不可复制性</h3>
      
<p>在<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://legacy.cplusplus.com/reference/mutex/mutex/mutex/" >mutex构造函数</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>中指出，构造一个mutex对象，初始状态是解锁。<br />
mutex对象不能被复制、移动（复制构造函数和赋值运算符都被删除）<br />
因此，要特别注意你创建的mutex的生命周期，不建议建立在栈帧随时塌陷的位置。</p>

        <h2 id="recursive_mutex多次互斥量"   >
          <a href="#recursive_mutex多次互斥量" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#recursive_mutex多次互斥量"></a> recursive_mutex（多次互斥量）</h2>
      
<p>单纯的mutex只能锁一次。<br />
<code>recursive_mutex</code>可以锁多次，也可以解锁多次。</p>

        <h2 id="例子"   >
          <a href="#例子" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#例子"></a> 例子</h2>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">std::mutex mx;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        mx.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::wcout &lt;&lt; <span class="string">L&quot;Station #1: &quot;</span> &lt;&lt; tickets-- &lt;&lt; std::endl;</span><br><span class="line">            mx.<span class="built_in">unlock</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mx.<span class="built_in">unlock</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station2</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        mx.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::wcout &lt;&lt; <span class="string">L&quot;Station #2: &quot;</span> &lt;&lt; tickets-- &lt;&lt; std::endl;</span><br><span class="line">            mx.<span class="built_in">unlock</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mx.<span class="built_in">unlock</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="输出-2"   >
          <a href="#输出-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#输出-2"></a> 输出</h2>
      
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br></pre></td><td class="code"><pre><span class="line">Station #1: 500</span><br><span class="line">Station #1: 499</span><br><span class="line">Station #1: 498</span><br><span class="line">Station #1: 497</span><br><span class="line">Station #1: 496</span><br><span class="line">Station #1: 495</span><br><span class="line">Station #1: 494</span><br><span class="line">Station #1: 493</span><br><span class="line">Station #1: 492</span><br><span class="line">Station #1: 491</span><br><span class="line">Station #1: 490</span><br><span class="line">Station #1: 489</span><br><span class="line">Station #1: 488</span><br><span class="line">Station #1: 487</span><br><span class="line">Station #1: 486</span><br><span class="line">Station #1: 485</span><br><span class="line">Station #1: 484</span><br><span class="line">Station #1: 483</span><br><span class="line">Station #1: 482</span><br><span class="line">Station #1: 481</span><br><span class="line">Station #1: 480</span><br><span class="line">Station #1: 479</span><br><span class="line">Station #1: 478</span><br><span class="line">Station #1: 477</span><br><span class="line">Station #1: 476</span><br><span class="line">Station #1: 475</span><br><span class="line">Station #1: 474</span><br><span class="line">Station #1: 473</span><br><span class="line">Station #1: 472</span><br><span class="line">Station #1: 471</span><br><span class="line">Station #1: 470</span><br><span class="line">Station #1: 469</span><br><span class="line">Station #1: 468</span><br><span class="line">Station #1: 467</span><br><span class="line">Station #1: 466</span><br><span class="line">Station #1: 465</span><br><span class="line">Station #1: 464</span><br><span class="line">Station #1: 463</span><br><span class="line">Station #1: 462</span><br><span class="line">Station #1: 461</span><br><span class="line">Station #1: 460</span><br><span class="line">Station #1: 459</span><br><span class="line">Station #1: 458</span><br><span class="line">Station #1: 457</span><br><span class="line">Station #1: 456</span><br><span class="line">Station #1: 455</span><br><span class="line">Station #1: 454</span><br><span class="line">Station #1: 453</span><br><span class="line">Station #1: 452</span><br><span class="line">Station #1: 451</span><br><span class="line">Station #1: 450</span><br><span class="line">Station #1: 449</span><br><span class="line">Station #1: 448</span><br><span class="line">Station #1: 447</span><br><span class="line">Station #1: 446</span><br><span class="line">Station #1: 445</span><br><span class="line">Station #1: 444</span><br><span class="line">Station #1: 443</span><br><span class="line">Station #1: 442</span><br><span class="line">Station #1: 441</span><br><span class="line">Station #1: 440</span><br><span class="line">Station #1: 439</span><br><span class="line">Station #1: 438</span><br><span class="line">Station #1: 437</span><br><span class="line">Station #1: 436</span><br><span class="line">Station #1: 435</span><br><span class="line">Station #1: 434</span><br><span class="line">Station #1: 433</span><br><span class="line">Station #1: 432</span><br><span class="line">Station #1: 431</span><br><span class="line">Station #1: 430</span><br><span class="line">Station #1: 429</span><br><span class="line">Station #1: 428</span><br><span class="line">Station #1: 427</span><br><span class="line">Station #1: 426</span><br><span class="line">Station #1: 425</span><br><span class="line">Station #1: 424</span><br><span class="line">Station #1: 423</span><br><span class="line">Station #1: 422</span><br><span class="line">Station #1: 421</span><br><span class="line">Station #1: 420</span><br><span class="line">Station #1: 419</span><br><span class="line">Station #1: 418</span><br><span class="line">Station #1: 417</span><br><span class="line">Station #1: 416</span><br><span class="line">Station #1: 415</span><br><span class="line">Station #1: 414</span><br><span class="line">Station #1: 413</span><br><span class="line">Station #1: 412</span><br><span class="line">Station #1: 411</span><br><span class="line">Station #1: 410</span><br><span class="line">Station #1: 409</span><br><span class="line">Station #1: 408</span><br><span class="line">Station #1: 407</span><br><span class="line">Station #1: 406</span><br><span class="line">Station #1: 405</span><br><span class="line">Station #1: 404</span><br><span class="line">Station #1: 403</span><br><span class="line">Station #1: 402</span><br><span class="line">Station #1: 401</span><br><span class="line">Station #1: 400</span><br><span class="line">Station #1: 399</span><br><span class="line">Station #1: 398</span><br><span class="line">Station #1: 397</span><br><span class="line">Station #1: 396</span><br><span class="line">Station #1: 395</span><br><span class="line">Station #1: 394</span><br><span class="line">Station #1: 393</span><br><span class="line">Station #2: 392</span><br><span class="line">Station #2: 391</span><br><span class="line">Station #2: 390</span><br><span class="line">Station #2: 389</span><br><span class="line">Station #2: 388</span><br><span class="line">Station #2: 387</span><br><span class="line">Station #2: 386</span><br><span class="line">Station #2: 385</span><br><span class="line">Station #2: 384</span><br><span class="line">Station #2: 383</span><br><span class="line">Station #2: 382</span><br><span class="line">Station #2: 381</span><br><span class="line">Station #2: 380</span><br><span class="line">Station #2: 379</span><br><span class="line">Station #2: 378</span><br><span class="line">Station #2: 377</span><br><span class="line">Station #2: 376</span><br><span class="line">Station #2: 375</span><br><span class="line">Station #2: 374</span><br><span class="line">Station #2: 373</span><br><span class="line">Station #2: 372</span><br><span class="line">Station #2: 371</span><br><span class="line">Station #2: 370</span><br><span class="line">Station #2: 369</span><br><span class="line">Station #2: 368</span><br><span class="line">Station #2: 367</span><br><span class="line">Station #2: 366</span><br><span class="line">Station #2: 365</span><br><span class="line">Station #2: 364</span><br><span class="line">Station #2: 363</span><br><span class="line">Station #2: 362</span><br><span class="line">Station #2: 361</span><br><span class="line">Station #2: 360</span><br><span class="line">Station #2: 359</span><br><span class="line">Station #2: 358</span><br><span class="line">Station #2: 357</span><br><span class="line">Station #2: 356</span><br><span class="line">Station #2: 355</span><br><span class="line">Station #2: 354</span><br><span class="line">Station #2: 353</span><br><span class="line">Station #2: 352</span><br><span class="line">Station #2: 351</span><br><span class="line">Station #2: 350</span><br><span class="line">Station #2: 349</span><br><span class="line">Station #2: 348</span><br><span class="line">Station #2: 347</span><br><span class="line">Station #2: 346</span><br><span class="line">Station #2: 345</span><br><span class="line">Station #2: 344</span><br><span class="line">Station #2: 343</span><br><span class="line">Station #2: 342</span><br><span class="line">Station #2: 341</span><br><span class="line">Station #2: 340</span><br><span class="line">Station #2: 339</span><br><span class="line">Station #2: 338</span><br><span class="line">Station #2: 337</span><br><span class="line">Station #2: 336</span><br><span class="line">Station #2: 335</span><br><span class="line">Station #2: 334</span><br><span class="line">Station #2: 333</span><br><span class="line">Station #2: 332</span><br><span class="line">Station #2: 331</span><br><span class="line">Station #2: 330</span><br><span class="line">Station #2: 329</span><br><span class="line">Station #2: 328</span><br><span class="line">Station #2: 327</span><br><span class="line">Station #2: 326</span><br><span class="line">Station #2: 325</span><br><span class="line">Station #2: 324</span><br><span class="line">Station #2: 323</span><br><span class="line">Station #2: 322</span><br><span class="line">Station #2: 321</span><br><span class="line">Station #2: 320</span><br><span class="line">Station #2: 319</span><br><span class="line">Station #2: 318</span><br><span class="line">Station #2: 317</span><br><span class="line">Station #2: 316</span><br><span class="line">Station #2: 315</span><br><span class="line">Station #2: 314</span><br><span class="line">Station #2: 313</span><br><span class="line">Station #2: 312</span><br><span class="line">Station #2: 311</span><br><span class="line">Station #2: 310</span><br><span class="line">Station #2: 309</span><br><span class="line">Station #2: 308</span><br><span class="line">Station #2: 307</span><br><span class="line">Station #2: 306</span><br><span class="line">Station #2: 305</span><br><span class="line">Station #2: 304</span><br><span class="line">Station #2: 303</span><br><span class="line">Station #2: 302</span><br><span class="line">Station #2: 301</span><br><span class="line">Station #2: 300</span><br><span class="line">Station #2: 299</span><br><span class="line">Station #2: 298</span><br><span class="line">Station #2: 297</span><br><span class="line">Station #2: 296</span><br><span class="line">Station #2: 295</span><br><span class="line">Station #2: 294</span><br><span class="line">Station #2: 293</span><br><span class="line">Station #2: 292</span><br><span class="line">Station #2: 291</span><br><span class="line">Station #2: 290</span><br><span class="line">Station #2: 289</span><br><span class="line">Station #2: 288</span><br><span class="line">Station #2: 287</span><br><span class="line">Station #2: 286</span><br><span class="line">Station #2: 285</span><br><span class="line">Station #2: 284</span><br><span class="line">Station #2: 283</span><br><span class="line">Station #2: 282</span><br><span class="line">Station #2: 281</span><br><span class="line">Station #2: 280</span><br><span class="line">Station #2: 279</span><br><span class="line">Station #2: 278</span><br><span class="line">Station #2: 277</span><br><span class="line">Station #2: 276</span><br><span class="line">Station #2: 275</span><br><span class="line">Station #2: 274</span><br><span class="line">Station #2: 273</span><br><span class="line">Station #2: 272</span><br><span class="line">Station #2: 271</span><br><span class="line">Station #2: 270</span><br><span class="line">Station #2: 269</span><br><span class="line">Station #2: 268</span><br><span class="line">Station #2: 267</span><br><span class="line">Station #2: 266</span><br><span class="line">Station #2: 265</span><br><span class="line">Station #2: 264</span><br><span class="line">Station #2: 263</span><br><span class="line">Station #2: 262</span><br><span class="line">Station #2: 261</span><br><span class="line">Station #2: 260</span><br><span class="line">Station #2: 259</span><br><span class="line">Station #2: 258</span><br><span class="line">Station #2: 257</span><br><span class="line">Station #2: 256</span><br><span class="line">Station #2: 255</span><br><span class="line">Station #2: 254</span><br><span class="line">Station #2: 253</span><br><span class="line">Station #2: 252</span><br><span class="line">Station #2: 251</span><br><span class="line">Station #2: 250</span><br><span class="line">Station #2: 249</span><br><span class="line">Station #2: 248</span><br><span class="line">Station #2: 247</span><br><span class="line">Station #2: 246</span><br><span class="line">Station #2: 245</span><br><span class="line">Station #2: 244</span><br><span class="line">Station #2: 243</span><br><span class="line">Station #2: 242</span><br><span class="line">Station #2: 241</span><br><span class="line">Station #2: 240</span><br><span class="line">Station #2: 239</span><br><span class="line">Station #2: 238</span><br><span class="line">Station #2: 237</span><br><span class="line">Station #2: 236</span><br><span class="line">Station #2: 235</span><br><span class="line">Station #2: 234</span><br><span class="line">Station #2: 233</span><br><span class="line">Station #2: 232</span><br><span class="line">Station #2: 231</span><br><span class="line">Station #2: 230</span><br><span class="line">Station #2: 229</span><br><span class="line">Station #2: 228</span><br><span class="line">Station #2: 227</span><br><span class="line">Station #2: 226</span><br><span class="line">Station #2: 225</span><br><span class="line">Station #2: 224</span><br><span class="line">Station #2: 223</span><br><span class="line">Station #2: 222</span><br><span class="line">Station #2: 221</span><br><span class="line">Station #2: 220</span><br><span class="line">Station #2: 219</span><br><span class="line">Station #2: 218</span><br><span class="line">Station #2: 217</span><br><span class="line">Station #2: 216</span><br><span class="line">Station #2: 215</span><br><span class="line">Station #2: 214</span><br><span class="line">Station #2: 213</span><br><span class="line">Station #2: 212</span><br><span class="line">Station #2: 211</span><br><span class="line">Station #2: 210</span><br><span class="line">Station #2: 209</span><br><span class="line">Station #2: 208</span><br><span class="line">Station #2: 207</span><br><span class="line">Station #2: 206</span><br><span class="line">Station #2: 205</span><br><span class="line">Station #2: 204</span><br><span class="line">Station #2: 203</span><br><span class="line">Station #2: 202</span><br><span class="line">Station #2: 201</span><br><span class="line">Station #2: 200</span><br><span class="line">Station #2: 199</span><br><span class="line">Station #2: 198</span><br><span class="line">Station #2: 197</span><br><span class="line">Station #2: 196</span><br><span class="line">Station #2: 195</span><br><span class="line">Station #2: 194</span><br><span class="line">Station #2: 193</span><br><span class="line">Station #2: 192</span><br><span class="line">Station #2: 191</span><br><span class="line">Station #2: 190</span><br><span class="line">Station #2: 189</span><br><span class="line">Station #2: 188</span><br><span class="line">Station #2: 187</span><br><span class="line">Station #2: 186</span><br><span class="line">Station #2: 185</span><br><span class="line">Station #2: 184</span><br><span class="line">Station #2: 183</span><br><span class="line">Station #2: 182</span><br><span class="line">Station #2: 181</span><br><span class="line">Station #2: 180</span><br><span class="line">Station #2: 179</span><br><span class="line">Station #2: 178</span><br><span class="line">Station #2: 177</span><br><span class="line">Station #2: 176</span><br><span class="line">Station #2: 175</span><br><span class="line">Station #2: 174</span><br><span class="line">Station #2: 173</span><br><span class="line">Station #2: 172</span><br><span class="line">Station #2: 171</span><br><span class="line">Station #2: 170</span><br><span class="line">Station #2: 169</span><br><span class="line">Station #2: 168</span><br><span class="line">Station #2: 167</span><br><span class="line">Station #2: 166</span><br><span class="line">Station #2: 165</span><br><span class="line">Station #2: 164</span><br><span class="line">Station #2: 163</span><br><span class="line">Station #2: 162</span><br><span class="line">Station #2: 161</span><br><span class="line">Station #2: 160</span><br><span class="line">Station #2: 159</span><br><span class="line">Station #2: 158</span><br><span class="line">Station #2: 157</span><br><span class="line">Station #2: 156</span><br><span class="line">Station #2: 155</span><br><span class="line">Station #2: 154</span><br><span class="line">Station #2: 153</span><br><span class="line">Station #2: 152</span><br><span class="line">Station #2: 151</span><br><span class="line">Station #2: 150</span><br><span class="line">Station #2: 149</span><br><span class="line">Station #2: 148</span><br><span class="line">Station #2: 147</span><br><span class="line">Station #2: 146</span><br><span class="line">Station #2: 145</span><br><span class="line">Station #2: 144</span><br><span class="line">Station #2: 143</span><br><span class="line">Station #2: 142</span><br><span class="line">Station #2: 141</span><br><span class="line">Station #2: 140</span><br><span class="line">Station #2: 139</span><br><span class="line">Station #2: 138</span><br><span class="line">Station #2: 137</span><br><span class="line">Station #2: 136</span><br><span class="line">Station #2: 135</span><br><span class="line">Station #2: 134</span><br><span class="line">Station #2: 133</span><br><span class="line">Station #2: 132</span><br><span class="line">Station #2: 131</span><br><span class="line">Station #2: 130</span><br><span class="line">Station #2: 129</span><br><span class="line">Station #2: 128</span><br><span class="line">Station #2: 127</span><br><span class="line">Station #2: 126</span><br><span class="line">Station #2: 125</span><br><span class="line">Station #2: 124</span><br><span class="line">Station #2: 123</span><br><span class="line">Station #2: 122</span><br><span class="line">Station #2: 121</span><br><span class="line">Station #2: 120</span><br><span class="line">Station #2: 119</span><br><span class="line">Station #2: 118</span><br><span class="line">Station #2: 117</span><br><span class="line">Station #2: 116</span><br><span class="line">Station #2: 115</span><br><span class="line">Station #2: 114</span><br><span class="line">Station #2: 113</span><br><span class="line">Station #2: 112</span><br><span class="line">Station #2: 111</span><br><span class="line">Station #2: 110</span><br><span class="line">Station #2: 109</span><br><span class="line">Station #2: 108</span><br><span class="line">Station #2: 107</span><br><span class="line">Station #2: 106</span><br><span class="line">Station #2: 105</span><br><span class="line">Station #2: 104</span><br><span class="line">Station #2: 103</span><br><span class="line">Station #2: 102</span><br><span class="line">Station #2: 101</span><br><span class="line">Station #2: 100</span><br><span class="line">Station #2: 99</span><br><span class="line">Station #2: 98</span><br><span class="line">Station #2: 97</span><br><span class="line">Station #2: 96</span><br><span class="line">Station #2: 95</span><br><span class="line">Station #2: 94</span><br><span class="line">Station #2: 93</span><br><span class="line">Station #2: 92</span><br><span class="line">Station #2: 91</span><br><span class="line">Station #2: 90</span><br><span class="line">Station #2: 89</span><br><span class="line">Station #2: 88</span><br><span class="line">Station #2: 87</span><br><span class="line">Station #2: 86</span><br><span class="line">Station #2: 85</span><br><span class="line">Station #2: 84</span><br><span class="line">Station #2: 83</span><br><span class="line">Station #2: 82</span><br><span class="line">Station #2: 81</span><br><span class="line">Station #2: 80</span><br><span class="line">Station #2: 79</span><br><span class="line">Station #2: 78</span><br><span class="line">Station #2: 77</span><br><span class="line">Station #2: 76</span><br><span class="line">Station #2: 75</span><br><span class="line">Station #2: 74</span><br><span class="line">Station #2: 73</span><br><span class="line">Station #2: 72</span><br><span class="line">Station #2: 71</span><br><span class="line">Station #2: 70</span><br><span class="line">Station #2: 69</span><br><span class="line">Station #2: 68</span><br><span class="line">Station #2: 67</span><br><span class="line">Station #2: 66</span><br><span class="line">Station #2: 65</span><br><span class="line">Station #2: 64</span><br><span class="line">Station #2: 63</span><br><span class="line">Station #2: 62</span><br><span class="line">Station #2: 61</span><br><span class="line">Station #2: 60</span><br><span class="line">Station #2: 59</span><br><span class="line">Station #2: 58</span><br><span class="line">Station #2: 57</span><br><span class="line">Station #2: 56</span><br><span class="line">Station #2: 55</span><br><span class="line">Station #2: 54</span><br><span class="line">Station #2: 53</span><br><span class="line">Station #2: 52</span><br><span class="line">Station #2: 51</span><br><span class="line">Station #2: 50</span><br><span class="line">Station #2: 49</span><br><span class="line">Station #2: 48</span><br><span class="line">Station #2: 47</span><br><span class="line">Station #2: 46</span><br><span class="line">Station #2: 45</span><br><span class="line">Station #2: 44</span><br><span class="line">Station #2: 43</span><br><span class="line">Station #2: 42</span><br><span class="line">Station #2: 41</span><br><span class="line">Station #2: 40</span><br><span class="line">Station #2: 39</span><br><span class="line">Station #2: 38</span><br><span class="line">Station #2: 37</span><br><span class="line">Station #2: 36</span><br><span class="line">Station #2: 35</span><br><span class="line">Station #2: 34</span><br><span class="line">Station #2: 33</span><br><span class="line">Station #2: 32</span><br><span class="line">Station #2: 31</span><br><span class="line">Station #2: 30</span><br><span class="line">Station #2: 29</span><br><span class="line">Station #2: 28</span><br><span class="line">Station #2: 27</span><br><span class="line">Station #2: 26</span><br><span class="line">Station #2: 25</span><br><span class="line">Station #2: 24</span><br><span class="line">Station #2: 23</span><br><span class="line">Station #2: 22</span><br><span class="line">Station #2: 21</span><br><span class="line">Station #2: 20</span><br><span class="line">Station #2: 19</span><br><span class="line">Station #2: 18</span><br><span class="line">Station #2: 17</span><br><span class="line">Station #2: 16</span><br><span class="line">Station #2: 15</span><br><span class="line">Station #2: 14</span><br><span class="line">Station #2: 13</span><br><span class="line">Station #2: 12</span><br><span class="line">Station #2: 11</span><br><span class="line">Station #2: 10</span><br><span class="line">Station #2: 9</span><br><span class="line">Station #2: 8</span><br><span class="line">Station #2: 7</span><br><span class="line">Station #2: 6</span><br><span class="line">Station #2: 5</span><br><span class="line">Station #2: 4</span><br><span class="line">Station #2: 3</span><br><span class="line">Station #2: 2</span><br><span class="line">Station #2: 1</span><br></pre></td></tr></table></div></figure>

        <h2 id="分析"   >
          <a href="#分析" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#分析"></a> 分析</h2>
      
<p>可以看到线程1、2各自持有锁的跨度还是挺大的，这是因为在<code>跨平台C++线程库</code>在Windows下的执行是用<code>Windows临界区</code>实现的。</p>

        <h1 id="作为引用传入线程函数stdref"   >
          <a href="#作为引用传入线程函数stdref" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#作为引用传入线程函数stdref"></a> 作为引用传入线程函数（<code>std::ref</code>）</h1>
      
<ol>
<li><code>std::mutex</code>锁是不可复制的。只能通过引用传递。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(std::mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::mutex mx;</span><br><span class="line">    <span class="function">std::thread <span class="title">th</span><span class="params">(&amp;station, mx)</span></span>; <span class="comment">// error</span></span><br><span class="line">    th.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(std::mutex&amp; mx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>此时，虽然线程函数参数类型为引用，但实际写的代码中，“mx”这个形式和值类型的形式不能区分，编译器无法对其直接解析为引用，产生二义性。（即编译器默认都先按照值传递处理，之后才去处理、区分是否为引用）<br />
2. 因此不能直接裸传，为了显式指出此变量为引用类型，要包装一层“引用包裹器”。<code>std::reference_wrapper(mx)</code>，也可以简写为<code>std::ref(mx)</code>。在实际使用到该引用类型变量时，包裹器会自己释放出实际内容。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(std::mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station2</span><span class="params">(std::mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::mutex mx;</span><br><span class="line">    <span class="function">std::thread <span class="title">th</span><span class="params">(&amp;station, std::ref(mx))</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">th2</span><span class="params">(&amp;station2, std::ref(mx))</span></span>;</span><br><span class="line">    th.<span class="built_in">join</span>();</span><br><span class="line">    th<span class="number">2.</span><span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(std::mutex&amp; mx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station2</span><span class="params">(std::mutex&amp; mx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="解析stdref"   >
          <a href="#解析stdref" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#解析stdref"></a> 解析<code>std::ref</code></h2>
      
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> &amp; ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;thread fun&quot;</span> &lt;&lt; endl;</span><br><span class="line">		std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	ret = n;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;thread fun end&quot;</span> &lt;&lt; endl;</span><br><span class="line">	<span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">10</span>;</span><br><span class="line">	<span class="function">std::thread <span class="title">tha</span><span class="params">(fun, <span class="number">5</span>, std::ref(x))</span></span>;</span><br><span class="line">	tha.<span class="built_in">join</span>();</span><br><span class="line">	cout &lt;&lt; x &lt;&lt; endl;		<span class="comment">//输出5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">10</span>;</span><br><span class="line">	<span class="function">std::thread <span class="title">tha</span><span class="params">(fun, <span class="number">5</span>, x)</span></span>;		<span class="comment">//编译不通过</span></span><br><span class="line">	tha.<span class="built_in">join</span>();</span><br><span class="line">	cout &lt;&lt; x &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>为什么直接传x不能编译通过呢？因为thread的构造距离start线程中间有一层可变参模板组件：</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Function, <span class="keyword">class</span>... Args&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">thread</span><span class="params">(Function&amp;&amp; f, Args&amp;&amp;... args)</span></span>;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Fn</span>, <span class="keyword">class</span>... _Args&gt;</span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">thread</span><span class="params">(_Fn&amp;&amp; _Fx, _Args&amp;&amp;... _Ax)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _Start(_STD forward&lt;_Fn&gt;(_Fx), _STD forward&lt;_Args&gt;(_Ax)...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>thread的构造需要先通过这个组件，则由于<code>args</code>是按<code>[模板 &amp;&amp;]</code>接收，如果直接单纯传<code>x</code>，则会识别为普通的<code>int</code>值传递，在到达<code>_Start</code>接口后，<code>x</code>的<code>int</code>类型与参数类型<code>int &amp;</code>不匹配，无法编译通过。</p>
<p>所以需要一个特殊的机制，用<code>std::ref</code>显式指出把<code>x</code>按引用方式传递（传地址），如此，在经过模板时，按转发引用处理，经过<code>_Start</code>接口的完美转发后作为右值<strong>隐式转换</strong>为<code>int &amp;</code>类型，如此便可编译通过，达到按引用传参的目的。</p>
<p>为什么是隐式转换？</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//std::ref的底层是reference_wrapper类，其中有隐式转换</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">reference_wrapper</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> type = _Ty;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Uty</span>&gt;</span><br><span class="line">    <span class="built_in">reference_wrapper</span>(_Uty&amp;&amp; _Val)</span><br><span class="line">    &#123;</span><br><span class="line">        _Ty&amp; _Ref = <span class="built_in">static_cast</span>&lt;_Uty&amp;&amp;&gt;(_Val);</span><br><span class="line">        _Ptr      = &amp;_Ref;	<span class="comment">/*_STD addressof(_Ref);*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">operator</span> _Ty&amp;() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> *_Ptr;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    _Ty* _Ptr&#123;&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<p>测试</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">//std::ref的底层是reference_wrapper类，其中有隐式转换</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">my_reference_wrapper</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> type = _Ty;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Uty</span>&gt;</span><br><span class="line">    <span class="built_in">my_reference_wrapper</span>(_Uty&amp;&amp; _Val)</span><br><span class="line">    &#123;</span><br><span class="line">        _Ty&amp; _Ref = <span class="built_in">static_cast</span>&lt;_Uty&amp;&amp;&gt;(_Val);</span><br><span class="line">        _Ptr = &amp;_Ref;	<span class="comment">/*_STD addressof(_Ref);*/</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">operator</span> _Ty&amp;() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> *_Ptr;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    _Ty* _Ptr&#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">fun</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span>&amp; x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;thread fun&quot;</span> &lt;&lt; endl;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    x = n;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;thread fun end&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">std::thread <span class="title">tha</span><span class="params">(fun, <span class="number">5</span>, my_reference_wrapper&lt;<span class="type">int</span>&gt;(x))</span></span>;</span><br><span class="line">    tha.<span class="built_in">join</span>();</span><br><span class="line">    cout &lt;&lt; x &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Fn</span>, <span class="keyword">class</span>... _Args&gt;</span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">thread</span><span class="params">(_Fn&amp;&amp; _Fx, _Args&amp;&amp;... _Ax)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _Start(_STD forward&lt;_Fn&gt;(_Fx), _STD forward&lt;_Args&gt;(_Ax)...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>构造tha时的第三个参数是<code>my_reference_wrapper&lt;int&gt;(x)</code>，是个右值！传入thread可变参模板函数，完美转发，右值叠加右值，依然是右值，调用<code>_Start</code>时优先匹配<code>&amp;&amp;</code>类型的参数，但是发现没有，而且只有一个匹配的选项是：<code>(int n, int &amp; x)</code>，是<code>int&amp;</code>类型，于是乎，无奈之举，调用成员函数<code>operator _Ty()</code>，即为隐式转换为<code>&amp;Ty</code>的左值引用类型。</p>
<p>如此一来，即可把线程函数外部的<code>x</code>按引用传递。</p>

        <h1 id="lock_guard"   >
          <a href="#lock_guard" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#lock_guard"></a> lock_guard</h1>
      
<p>同样定义于<code>&lt;mutex&gt;</code>中。用于帮助管理mutex锁。<br />
RAII对象。自动管理生命周期。<br />
需要一个mutex锁来构造。构造后立刻对mutex上锁，直到<code>lock_guard</code>自身析构时对mutex解锁。<br />
与mutex一样，<code>lock_guard</code>对象无法复制/移动。</p>
<blockquote>
<p><code>lock_guard</code>是一个模板类，需要一个模板参数，如填写<code>&lt;std::mutex&gt;</code>。在<code>C++17</code>后，不用填写模板参数，可以自动判断程序代码大括号中的参数类型。</p>
</blockquote>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(std::mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station2</span><span class="params">(std::mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::mutex mx;</span><br><span class="line">    <span class="function">std::thread <span class="title">th</span><span class="params">(&amp;station, std::ref(mx))</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">th2</span><span class="params">(&amp;station2, std::ref(mx))</span></span>;</span><br><span class="line">    th.<span class="built_in">join</span>();</span><br><span class="line">    th<span class="number">2.</span><span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(std::mutex&amp; mx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lck&#123; mx &#125;;</span><br><span class="line">        <span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::wcout &lt;&lt; <span class="string">L&quot;Station #1: &quot;</span> &lt;&lt; tickets-- &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// 退出此括号时，lck析构</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station2</span><span class="params">(std::mutex&amp; mx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::lock_guard lck&#123; mx &#125;; <span class="comment">// 在`C++17`后，不用填写模板参数，可以自动判断程序代码大括号中的参数类型。</span></span><br><span class="line">        <span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::wcout &lt;&lt; <span class="string">L&quot;Station #2: &quot;</span> &lt;&lt; tickets-- &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// 退出此括号时，lck析构</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h1 id="unique_lock"   >
          <a href="#unique_lock" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#unique_lock"></a> unique_lock</h1>
      
<p>定义于<code>&lt;mutex&gt;</code>中</p>
<ol>
<li>和<code>lock_guard</code>用法一样，但是<code>unique_lock</code>支持转移给另一个<code>unique_lock</code>。（需要使用<code>std::move</code>）</li>
<li>有unlock、release、swap方法。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(std::mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station2</span><span class="params">(std::mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::mutex mx;</span><br><span class="line">    <span class="function">std::thread <span class="title">th</span><span class="params">(&amp;station, std::ref(mx))</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">th2</span><span class="params">(&amp;station2, std::ref(mx))</span></span>;</span><br><span class="line">    th.<span class="built_in">join</span>();</span><br><span class="line">    th<span class="number">2.</span><span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(std::mutex&amp; mx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::unique_lock lck&#123; mx &#125;;</span><br><span class="line">        <span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::wcout &lt;&lt; <span class="string">L&quot;Station #1: &quot;</span> &lt;&lt; tickets-- &lt;&lt; std::endl;</span><br><span class="line">            std::unique_lock lck2 = std::<span class="built_in">move</span>(lck);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// 退出此括号时，lck2、lck析构</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// station2 ...</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="输出-3"   >
          <a href="#输出-3" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#输出-3"></a> 输出</h2>
      
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">Station #1: 100</span><br><span class="line">Station #1: 99</span><br><span class="line">Station #1: 98</span><br><span class="line">Station #1: 97</span><br><span class="line">Station #1: 96</span><br><span class="line">Station #1: 95</span><br><span class="line">Station #1: 94</span><br><span class="line">Station #1: 93</span><br><span class="line">Station #1: 92</span><br><span class="line">Station #1: 91</span><br><span class="line">Station #1: 90</span><br><span class="line">Station #1: 89</span><br><span class="line">Station #1: 88</span><br><span class="line">Station #1: 87</span><br><span class="line">Station #1: 86</span><br><span class="line">Station #1: 85</span><br><span class="line">Station #1: 84</span><br><span class="line">Station #1: 83</span><br><span class="line">Station #1: 82</span><br><span class="line">Station #1: 81</span><br><span class="line">Station #1: 80</span><br><span class="line">Station #1: 79</span><br><span class="line">Station #1: 78</span><br><span class="line">Station #1: 77</span><br><span class="line">Station #1: 76</span><br><span class="line">Station #1: 75</span><br><span class="line">Station #1: 74</span><br><span class="line">Station #1: 73</span><br><span class="line">Station #1: 72</span><br><span class="line">Station #1: 71</span><br><span class="line">Station #1: 70</span><br><span class="line">Station #1: 69</span><br><span class="line">Station #1: 68</span><br><span class="line">Station #1: 67</span><br><span class="line">Station #1: 66</span><br><span class="line">Station #2: 65</span><br><span class="line">Station #2: 64</span><br><span class="line">Station #2: 63</span><br><span class="line">Station #2: 62</span><br><span class="line">Station #2: 61</span><br><span class="line">Station #2: 60</span><br><span class="line">Station #2: 59</span><br><span class="line">Station #2: 58</span><br><span class="line">Station #2: 57</span><br><span class="line">Station #2: 56</span><br><span class="line">Station #2: 55</span><br><span class="line">Station #2: 54</span><br><span class="line">Station #2: 53</span><br><span class="line">Station #2: 52</span><br><span class="line">Station #2: 51</span><br><span class="line">Station #2: 50</span><br><span class="line">Station #2: 49</span><br><span class="line">Station #2: 48</span><br><span class="line">Station #2: 47</span><br><span class="line">Station #2: 46</span><br><span class="line">Station #2: 45</span><br><span class="line">Station #2: 44</span><br><span class="line">Station #2: 43</span><br><span class="line">Station #2: 42</span><br><span class="line">Station #2: 41</span><br><span class="line">Station #2: 40</span><br><span class="line">Station #2: 39</span><br><span class="line">Station #2: 38</span><br><span class="line">Station #2: 37</span><br><span class="line">Station #2: 36</span><br><span class="line">Station #2: 35</span><br><span class="line">Station #2: 34</span><br><span class="line">Station #2: 33</span><br><span class="line">Station #2: 32</span><br><span class="line">Station #2: 31</span><br><span class="line">Station #2: 30</span><br><span class="line">Station #2: 29</span><br><span class="line">Station #2: 28</span><br><span class="line">Station #2: 27</span><br><span class="line">Station #2: 26</span><br><span class="line">Station #2: 25</span><br><span class="line">Station #2: 24</span><br><span class="line">Station #2: 23</span><br><span class="line">Station #2: 22</span><br><span class="line">Station #2: 21</span><br><span class="line">Station #2: 20</span><br><span class="line">Station #2: 19</span><br><span class="line">Station #2: 18</span><br><span class="line">Station #2: 17</span><br><span class="line">Station #2: 16</span><br><span class="line">Station #2: 15</span><br><span class="line">Station #2: 14</span><br><span class="line">Station #2: 13</span><br><span class="line">Station #2: 12</span><br><span class="line">Station #2: 11</span><br><span class="line">Station #2: 10</span><br><span class="line">Station #2: 9</span><br><span class="line">Station #2: 8</span><br><span class="line">Station #2: 7</span><br><span class="line">Station #2: 6</span><br><span class="line">Station #2: 5</span><br><span class="line">Station #2: 4</span><br><span class="line">Station #2: 3</span><br><span class="line">Station #2: 2</span><br><span class="line">Station #2: 1</span><br></pre></td></tr></table></div></figure>

        <h1 id="shared_mutex共享互斥量"   >
          <a href="#shared_mutex共享互斥量" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#shared_mutex共享互斥量"></a> shared_mutex（共享互斥量）</h1>
      
<p>定义于<code>&lt;shared_mutex&gt;</code>，<code>C++17</code>给出的共享互斥量。<br />
Shared mutexes are especially useful when shared data can be safely read by any number of threads simultaneously, but a thread may only write the same data when no other thread is reading or writing at the same time.<br />
消费者可以共同访问，但不能和生产者一起共享。</p>
<ol>
<li>提供的方法：<code>lock_shared</code>用于消费者共享锁。<code>lock</code>用于生产者独占锁。
<ol>
<li>lock和lock，lock和lock_shared都互斥。</li>
</ol>
</li>
<li>在生产者消费者模型中，<code>lock_shared</code>、<code>unlock_shared</code>用于n个消费者一起进入消费。<code>lock</code>、<code>unlock</code>用于阻断消费者进入。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;shared_mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="keyword">constinit</span> <span class="type">int</span> tickets&#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(std::shared_mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station2</span><span class="params">(std::shared_mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">produce</span><span class="params">(std::shared_mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::shared_mutex mx;</span><br><span class="line">    <span class="function">std::thread <span class="title">consumer</span><span class="params">(&amp;station, std::ref(mx))</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">consumer2</span><span class="params">(&amp;station2, std::ref(mx))</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">producer</span><span class="params">(&amp;produce, std::ref(mx))</span></span>;</span><br><span class="line"></span><br><span class="line">    consumer.<span class="built_in">join</span>();</span><br><span class="line">    consumer<span class="number">2.</span><span class="built_in">join</span>();</span><br><span class="line">    producer.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">produce</span><span class="params">(std::shared_mutex&amp; mx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        mx.<span class="built_in">lock</span>();</span><br><span class="line">        std::wcout &lt;&lt; <span class="string">L&quot;Producer: &quot;</span> &lt;&lt; ++tickets &lt;&lt; std::endl;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">500</span>ms);</span><br><span class="line">        mx.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(std::shared_mutex&amp; mx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        mx.<span class="built_in">lock_shared</span>();</span><br><span class="line">        <span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::wcout &lt;&lt; <span class="string">L&quot;Station #1: &quot;</span> &lt;&lt; tickets-- &lt;&lt; std::endl;</span><br><span class="line">            mx.<span class="built_in">unlock_shared</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mx.<span class="built_in">unlock_shared</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station2</span><span class="params">(std::shared_mutex&amp; mx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        mx.<span class="built_in">lock_shared</span>();</span><br><span class="line">        <span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::wcout &lt;&lt; <span class="string">L&quot;Station #2: &quot;</span> &lt;&lt; tickets-- &lt;&lt; std::endl;</span><br><span class="line">            mx.<span class="built_in">unlock_shared</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mx.<span class="built_in">unlock_shared</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="输出-4"   >
          <a href="#输出-4" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#输出-4"></a> 输出</h2>
      
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Producer: 1</span><br><span class="line">Station #2: 1</span><br><span class="line">Station #1: 0</span><br><span class="line">Producer: 0</span><br><span class="line">Producer: 1</span><br><span class="line">Producer: 2</span><br><span class="line">Producer: 3</span><br><span class="line">Station #2: 3</span><br><span class="line">Station #1: 2</span><br><span class="line">Station #1: 1</span><br><span class="line">Producer: 1</span><br><span class="line">Producer: 2</span><br><span class="line">Producer: 3</span><br><span class="line">Station #2: 3</span><br><span class="line">Station #2: 2</span><br><span class="line">Station #2: 1</span><br><span class="line">Producer: 1</span><br><span class="line">Station #2: 1</span><br><span class="line">Producer: 1</span><br><span class="line">Producer: 2</span><br><span class="line">Producer: 3</span><br><span class="line">Producer: 4</span><br><span class="line"> ...</span><br></pre></td></tr></table></div></figure>

        <h2 id="分析-2"   >
          <a href="#分析-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#分析-2"></a> 分析</h2>
      
<ol>
<li>输出中看到1个producer和2个consumer是互斥的，有一方在则另一方不动。</li>
<li>输出中看到0号票有时候也会被卖掉。证明了<code>mx.lock_shared()</code>只是让n个消费者同时拿到锁，并且没有做进一步的同步管理。</li>
</ol>

        <h1 id="shared_lock-以生产者消费者为例"   >
          <a href="#shared_lock-以生产者消费者为例" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#shared_lock-以生产者消费者为例"></a> shared_lock - 以生产者消费者为例</h1>
      
<ol>
<li>把开锁解锁的动作让锁管理器接管。</li>
<li>lock、unlock动作让<code>unique_lock</code>接管</li>
<li>lock_shared、unlock_shared动作让<code>shared_lock</code>接管。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;shared_mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="keyword">constinit</span> <span class="type">int</span> tickets&#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(std::shared_mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station2</span><span class="params">(std::shared_mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">produce</span><span class="params">(std::shared_mutex&amp; mx)</span></span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::shared_mutex mx;</span><br><span class="line">    <span class="function">std::thread <span class="title">consumer</span><span class="params">(&amp;station, std::ref(mx))</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">consumer2</span><span class="params">(&amp;station2, std::ref(mx))</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">producer</span><span class="params">(&amp;produce, std::ref(mx))</span></span>;</span><br><span class="line"></span><br><span class="line">    consumer.<span class="built_in">join</span>();</span><br><span class="line">    consumer<span class="number">2.</span><span class="built_in">join</span>();</span><br><span class="line">    producer.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">produce</span><span class="params">(std::shared_mutex&amp; mx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::unique_lock lck&#123; mx &#125;;</span><br><span class="line">        std::wcout &lt;&lt; <span class="string">L&quot;Producer: &quot;</span> &lt;&lt; ++tickets &lt;&lt; std::endl;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">500</span>ms);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(std::shared_mutex&amp; mx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::shared_lock lck&#123; mx &#125;;</span><br><span class="line">        <span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::wcout &lt;&lt; <span class="string">L&quot;Station #1: &quot;</span> &lt;&lt; tickets-- &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="built_in">station2</span>(std::shared_mutex&amp; mx)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::shared_lock lck&#123; mx &#125;;</span><br><span class="line">        <span class="keyword">if</span> (tickets &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::wcout &lt;&lt; <span class="string">L&quot;Station #2: &quot;</span> &lt;&lt; tickets-- &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h1 id="chrono"   >
          <a href="#chrono" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#chrono"></a> chrono</h1>
      
<p><code>std::this_thread::sleep_for</code>可以用于线程睡眠。</p>
<ol>
<li>可以使用<code>&lt;chrono&gt;</code>库下的<code>std::chrono::milliseconds(n)</code>来指定时间单位。</li>
<li><code>C++17</code>之后可以使用<code>using namespace std::chrono_literal;</code>用于把字面常量标识符映射为秒、毫秒等。</li>
</ol>
<p><img src="../../images/Cpp_%E7%BA%BF%E7%A8%8B%E5%BA%93/image-20240722225224344.png" alt="" /></p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="keyword">constinit</span> <span class="type">int</span> tickets = <span class="number">100</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">station2</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">th</span><span class="params">(&amp;station)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">th2</span><span class="params">(&amp;station2)</span></span>;</span><br><span class="line">    th.<span class="built_in">detach</span>();</span><br><span class="line">    th<span class="number">2.</span><span class="built_in">detach</span>();</span><br><span class="line">    <span class="comment">//std::this_thread::sleep_for(std::chrono::milliseconds(10000));</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">10000</span>ms);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h1 id="c线程与lambda表达式结合"   >
          <a href="#c线程与lambda表达式结合" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#c线程与lambda表达式结合"></a> <code>C++</code>线程与lambda表达式结合</h1>
      
<p>使用lambda表达式定义一个线程函数：每100ms打印从0到100。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line">#Include &lt;thread&gt;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">([]() -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">100</span>; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">            &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::this_thread::sleep_for(<span class="number">100</span>ms);</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;)</span></span>;</span><br><span class="line">    t<span class="number">1.</span><span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="lambda函数参数的处理"   >
          <a href="#lambda函数参数的处理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#lambda函数参数的处理"></a> lambda函数参数的处理</h2>
      
<p>lambda表达式作为线程函数，如果有其自己的内部参数，那么就需要传入lambda表达式后，再传入其使用的参数。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line">#Include &lt;thread&gt;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> nums&#123; <span class="number">100</span> &#125;;</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">([](<span class="keyword">auto</span> nu) -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= nu; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">            &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::this_thread::sleep_for(<span class="number">100</span>ms);</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">            nu = <span class="number">50</span>; <span class="comment">// 带不回去</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;, nums)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">([](<span class="type">int</span>&amp; nu) -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= nu; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">            &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::this_thread::sleep_for(<span class="number">100</span>ms);</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">            nu = <span class="number">50</span>;  <span class="comment">// 带回去修改了nums的值</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;, std::ref(nums))</span></span>;</span><br><span class="line">    t<span class="number">1.</span><span class="built_in">join</span>();</span><br><span class="line">    t<span class="number">2.</span><span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol>
<li>参数按值传递：lambda形参类型可以用auto。</li>
<li>参数按引用传递：传参时必须用<code>std::ref</code>。此时由于有引用包裹器，auto不能推导。所以lambda形参类型不可以用<code>auto &amp;</code>，也不可以用<code>auto &amp;&amp;</code>，必须明确<code>ClassName &amp;</code></li>
</ol>

        <h1 id="jthread"   >
          <a href="#jthread" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#jthread"></a> jthread</h1>
      
<p><code>C++20</code>下的加强版thread类</p>
<ol>
<li>如果main函数中没写t1的join，那么会先到<code>return 0;</code>，之后在main即将return 0时，t1析构时，自动地为t1调用join，则最后主线程等待t1结束后一起退出。如果明确写了join则按照普通thread的join时机。</li>
<li>如果只写detach，那么最后就不会自动加join，主线程退出时子线程也会退出。</li>
</ol>

        <h2 id="线程取消"   >
          <a href="#线程取消" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#线程取消"></a> 线程取消</h2>
      
<p><img src="../../images/Cpp_%E7%BA%BF%E7%A8%8B%E5%BA%93/image-20240723044901963.png" alt="" /><br />
这些 <code>stop_XXX</code> 类型都在<code>&lt;stop_token&gt;</code>中定义，旨在使<code>jthread</code>取消，尽管它们也可以独立使用 <code>std::jthread</code> - 例如，中断<code>std::condition_variable_any</code>等待函数，或用于自定义线程管理实现。事实上，它们甚至不需要用于“停止”任何东西，而是可以用于线程安全的一次性函数调用触发器。（这段话的意思大概是，<code>stop_token</code>只是叫做“停止”，但实际上没有真的停止动作）</p>

        <h3 id="stop_token-stop_requested"   >
          <a href="#stop_token-stop_requested" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#stop_token-stop_requested"></a> stop_token、stop_requested</h3>
      
<ol>
<li>
<p>token会共享一个标记性的对象</p>
</li>
<li>
<p>线程可以<code>get_stop_token</code>获得token</p>
</li>
<li>
<p>线程可以<code>request_stop</code>通知停止</p>
<ol>
<li>旧的让线程停止的手段：需要建立如Windows下的Event，通过Event让线程停止。现在这种<code>stop_token</code>方法使线程停止更简洁了。</li>
</ol>
</li>
<li>
<p>如果要传入<code>stop_token</code>，jthread的线程函数中内部的第1个参数必须写<code>std::stop_token</code></p>
</li>
<li>
<p>jthread提供了<code>request_stop</code>函数。提供了<code>get_stop_token</code>函数。</p>
</li>
</ol>
<p>以下程序表示：</p>
<ol>
<li>主线程创建t1，内部有一个tok每100ms查看是否有外部请求停止。</li>
<li>程序执行3s后，主线程调用<code>t1.request_stop()</code>请求t1停止。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::jthread <span class="title">t1</span><span class="params">([](std::stop_token tok) -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">100</span>; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">            &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">if</span> (tok.stop_requested())</span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::this_thread::sleep_for(<span class="number">100</span>ms);</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;)</span></span>;</span><br><span class="line">        </span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">3</span>s);</span><br><span class="line">    t<span class="number">1.</span><span class="built_in">request_stop</span>();</span><br><span class="line">    </span><br><span class="line">    t<span class="number">1.</span><span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="应用场景"   >
          <a href="#应用场景" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#应用场景"></a> 应用场景</h3>
      
<p>传输文件过程中，通过token这种类似于信号的东西，用于控制另一个线程。（传统方法是需要WaitForSingleObject，较为繁琐）<br />
这是一种面向对象的设计，token可以通过传参传递，按照事件通知的方式，按需快速使用。</p>

        <h3 id="stop_possible"   >
          <a href="#stop_possible" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#stop_possible"></a> stop_possible</h3>
      
<p>可看<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/thread/stop_token/stop_possible" >std::stop_token::stop_possible</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>中的代码示例。</p>

        <h3 id="stop_source"   >
          <a href="#stop_source" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#stop_source"></a> stop_source</h3>
      
<p>jthread对象可以通过调用<code>get_stop_source</code>，返回与 <code>jthread</code> 对象内部保存的相同共享停止状态关联的 <code>std::stop_source</code>。</p>
<p>获取到jthread的source后就不用操作jthread了，可以通过source进行：</p>
<ol>
<li><code>source.get_token()</code>，就相当于<code>t1.get_stop_token()</code></li>
<li><code>source.request_stop()</code></li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stop_token&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::jthread <span class="title">t1</span><span class="params">([](std::stop_token tok) -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">100</span>; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">            &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">if</span> (tok.stop_requested())</span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::this_thread::sleep_for(<span class="number">100</span>ms);</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> source = t<span class="number">1.</span><span class="built_in">get_stop_source</span>();</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">3</span>s);</span><br><span class="line">    source.<span class="built_in">request_stop</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="stop_callback"   >
          <a href="#stop_callback" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#stop_callback"></a> stop_callback</h3>
      
<p>定义于<code>&lt;stop_token&gt;</code>，用于搭配<code>stop_token</code>使用，指示线程取消后进行的回调操作。</p>
<ol>
<li>需要一个<code>stop_token</code>和一个函数作为构造</li>
<li>当该<code>stop_token</code>对应的线程得到<code>stop_requested</code>信号时，调用<code>stop_callback</code>构造时绑定的函数。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stop_token&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::jthread <span class="title">t1</span><span class="params">([](std::stop_token tok) -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">100</span>; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">            &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">if</span> (tok.stop_requested())</span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::this_thread::sleep_for(<span class="number">100</span>ms);</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">    std::stop_callback cb&#123; t<span class="number">1.</span><span class="built_in">get_stop_token</span>(), []() -&gt; <span class="type">void</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::wcout &lt;&lt; <span class="string">L&quot;Stopped!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125; &#125;;</span><br><span class="line"></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">3</span>s);</span><br><span class="line">    t<span class="number">1.</span><span class="built_in">request_stop</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>可能的输出：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">Stopped!</span><br><span class="line">28</span><br></pre></td></tr></table></div></figure>

        <h1 id="条件变量wait"   >
          <a href="#条件变量wait" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#条件变量wait"></a> 条件变量（wait）</h1>
      
<p>从<code>C++11</code>就开始引入了</p>
<p>类似于Windows下的信号。<br />
<code>Modern C++</code>中通用的用于通知、等待的工具。<br />
需要和锁配套使用，因为cv的wait方法需要传入一个<code>std::unique_lock&lt;std::mutex&gt;</code>参数</p>
<p>以下程序说的是：</p>
<ol>
<li>创建一个t1线程</li>
<li>t1线程尝试拿mx锁</li>
<li>拿到mx后，在mx锁上面wait，释放锁，之后休眠（进入等待队列）</li>
<li>如果没有通知则一直阻塞。</li>
<li>主线程休眠3s</li>
<li>主线程notify通知等待队列，唤醒了t1线程。</li>
<li>子线程t1被唤醒后，必须重新获取锁，才能返回从而继续下一步。</li>
</ol>
<p>综上所述，wait有三大步骤：</p>
<ol>
<li>释放锁</li>
<li>休眠，进入等待队列</li>
<li>被唤醒，尝试获取锁。
<ol>
<li>如果成功则进行下一步操作。</li>
<li>如果暂时没拿到锁则阻塞，直到拿到锁后才能进行下一步。
<ol>
<li>但这是因抢锁而导致阻塞，和wait的等待队列是两码事！</li>
<li>也就是说（再次强调）：wait是主动阻塞（wait之前拿到了锁，但是条件为假，主动放弃了锁）。而一旦条件为真，且被唤醒后，抢锁没抢到，则是被动阻塞。</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>除了这三大步骤，还有一大前提：系统假定在wait调用前，其中的mx互斥量已上锁。所以必须在拿到锁之后才能wait。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line">std::mutex mx;</span><br><span class="line">std::condition_variable cv;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::jthread <span class="title">t1</span><span class="params">([]() -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            std::unique_lock lck&#123; mx &#125;;</span></span></span><br><span class="line"><span class="params"><span class="function">            cv.wait(lck);</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">100</span>; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">            &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">                </span></span></span><br><span class="line"><span class="params"><span class="function">                std::this_thread::sleep_for(<span class="number">100</span>ms);</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;)</span></span>;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">3</span>s);</span><br><span class="line">    cv.<span class="built_in">notify_one</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="注意事项"   >
          <a href="#注意事项" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#注意事项"></a> 注意事项</h3>
      
<p>据《操作系统导论》P252 30.1节 中的提示：</p>
<blockquote>
<p>推荐在发notify信号时总是持有锁</p>
<p>尽管并不是所有情况下都严格需要，但有效且简单的做法还是在使用条件变量发送notify信号时持有锁（指要发送notify的线程）。有的例子是必须加锁的情况，但也有一些情况可以不加锁，而这可能是你应该避免（避免再去分情况考虑）的。因此，<strong>为了简单</strong>，请在调用 signal（也就是notify） 时持有锁（hold the lock when calling signal）。</p>
<p>这个提示的反面，即调用 wait 时持有锁，但这就不只是建议了，wait 的语义是强制要求前提持有锁的。因为 wait 调用总是假设你调用它时已经持有锁、调用者睡眠之前会释放锁以及返回前重新持有锁。</p>
<p>因此，可以提出一般化形式，保证程序正确：调用 signal 和 wait 时都要持有锁（hold the lock when calling signal or wait）。</p>
</blockquote>
<p>就拿上面的例子来说，如果不对<code>notify_one</code>加以同步控制的话，有可能t1线程在lck上锁的时候，主线程恰好<code>notify_one</code>，导致在其wait之前唤醒，则wait之后再也没有唤醒的机会，程序就一直阻塞了。</p>
<p>所以，在主线程中的<code>cv.notify_one()</code>语句之前加锁（记得和t1中mutex变量一致）。<br />
而且既然在<code>cv.notify_one()</code>之前加了锁，就要在<code>cv.notify_one()</code>之后解锁，是因为wait被唤醒之后还需要得到锁才能脱离阻塞继续下一步操作。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// t1 ...</span></span><br><span class="line"></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">3</span>s);</span><br><span class="line">    </span><br><span class="line">    std::unique_lock lck&#123; mx &#125;;    <span class="comment">// add</span></span><br><span class="line">    cv.<span class="built_in">notify_one</span>();</span><br><span class="line">    lck.<span class="built_in">unlock</span>();                  <span class="comment">// add</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="wait_for"   >
          <a href="#wait_for" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#wait_for"></a> wait_for</h2>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Rep</span>, <span class="keyword">class</span> <span class="title class_">Period</span>&gt;</span><br><span class="line"><span class="function">cv_status <span class="title">wait_for</span> <span class="params">(unique_lock&lt;mutex&gt;&amp; lck, <span class="type">const</span> chrono::duration&lt;Rep,Period&gt;&amp; rel_time)</span></span>;</span><br></pre></td></tr></table></div></figure>
<p>在wait的基础上，既可以通过获得通知得到唤醒，也可以计时超时得到唤醒。<br />
即：超时后与<strong>被notify</strong>的行为一样，尝试获取锁，如果成功则下一步，如果失败则阻塞。<br />
但返回值有特点，超时则返回<code>std::cv_status::timeout</code>，其他情况返回<code>std::cv_status::no_timeout</code></p>

        <h3 id="用处结合notify来停止线程"   >
          <a href="#用处结合notify来停止线程" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#用处结合notify来停止线程"></a> 用处：结合notify来停止线程</h3>
      
<p>wait是用于通知线程<strong>开始</strong>下一步动作。<br />
而wait_for则可以用于通知线程<strong>停止</strong>。</p>
<p>以下程序是说：2个条件变量，<code>cv</code>和<code>cv2</code>，<code>cv</code>用于<code>wait</code>，以决定何时开始。<code>cv2</code>用于<code>wait_for</code>，结合返回值status，在一段时间等待停止的信号。<br />
主线程：</p>
<ol>
<li>在释放了cv对应的lck后，子线程wait成功获取到锁开始下一步。</li>
<li>休眠3s，保证子线程可以至少执行3s。</li>
<li>之后与子线程竞争lck2锁，一旦主线程拿到了，当即notify给cv2，之后释放锁。</li>
</ol>
<p>子线程：</p>
<ol>
<li>在cv上等待，一旦获取lck则下一步。</li>
<li>每次for循环都先抢lck2锁
<ol>
<li>在主线程休眠的3s内，肯定能抢到。并且每次wait_for释放锁也不会被别人抢，即不会被notify，所以返回值应该都是timeout</li>
<li>3s主线程唤醒后，与主线程竞争lck2锁
<ol>
<li>如果子先抢到了，则这一次for循环在wait_for时lck2释放50ms，如果主线程在此期间抢到了，并且发了notify，则status为<code>no_timeout</code>，子线程break结束。此情况下只能打印一半。</li>
<li>也有可能：for每次循环结束时，释放锁，主线程在很小很小的空挡内抢到锁，导致提前notify，错过cv2等待的时机，但是这个可能很小。此情况下1000个数全部输出。</li>
</ol>
</li>
</ol>
</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line">std::mutex mx, mx2;</span><br><span class="line">std::condition_variable cv, cv2;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::jthread <span class="title">t1</span><span class="params">([]() -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            std::unique_lock lck&#123; mx &#125;;</span></span></span><br><span class="line"><span class="params"><span class="function">            cv.wait(lck);</span></span></span><br><span class="line"><span class="params"><span class="function">            std::cout &lt;&lt; <span class="string">&quot;Got the Notify to Start!&quot;</span> &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">1000</span>; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">            &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                std::unique_lock lck2&#123; mx2 &#125;;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">if</span> (<span class="keyword">auto</span> status = cv<span class="number">2.</span>wait_for(lck2, <span class="number">50</span>ms);</span></span></span><br><span class="line"><span class="params"><span class="function">                    status == std::cv_status::no_timeout)</span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    std::cout &lt;&lt; <span class="string">&quot;Got the Notify to Out!&quot;</span> &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">else</span></span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    std::cout &lt;&lt; <span class="string">&quot;Timeout: No Notify&quot;</span> &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;)</span></span>;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">1</span>s);</span><br><span class="line">    std::unique_lock lck&#123; mx &#125;;</span><br><span class="line">    cv.<span class="built_in">notify_one</span>();</span><br><span class="line">    lck.<span class="built_in">unlock</span>();</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">3</span>s);</span><br><span class="line">    std::unique_lock lck2&#123; mx2 &#125;;</span><br><span class="line">    cv<span class="number">2.</span><span class="built_in">notify_one</span>();</span><br><span class="line">    lck<span class="number">2.</span><span class="built_in">unlock</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>输出</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">Got the Notify to Start!</span><br><span class="line">0</span><br><span class="line">Timeout: No Notify</span><br><span class="line">1</span><br><span class="line">Timeout: No Notify</span><br><span class="line">2</span><br><span class="line">Timeout: No Notify</span><br><span class="line">3</span><br><span class="line">Timeout: No Notify</span><br><span class="line">4</span><br><span class="line">Timeout: No Notify</span><br><span class="line">5</span><br><span class="line">Timeout: No Notify</span><br><span class="line">6</span><br><span class="line">Timeout: No Notify</span><br><span class="line">7</span><br><span class="line">Timeout: No Notify</span><br><span class="line">8</span><br><span class="line">Timeout: No Notify</span><br><span class="line">9</span><br><span class="line">Timeout: No Notify</span><br><span class="line">10</span><br><span class="line">Timeout: No Notify</span><br><span class="line">11</span><br><span class="line">Timeout: No Notify</span><br><span class="line">12</span><br><span class="line">Timeout: No Notify</span><br><span class="line">13</span><br><span class="line">Timeout: No Notify</span><br><span class="line">14</span><br><span class="line">Timeout: No Notify</span><br><span class="line">15</span><br><span class="line">Timeout: No Notify</span><br><span class="line">16</span><br><span class="line">Timeout: No Notify</span><br><span class="line">17</span><br><span class="line">Timeout: No Notify</span><br><span class="line">18</span><br><span class="line">Timeout: No Notify</span><br><span class="line">19</span><br><span class="line">Timeout: No Notify</span><br><span class="line">20</span><br><span class="line">Timeout: No Notify</span><br><span class="line">21</span><br><span class="line">Timeout: No Notify</span><br><span class="line">22</span><br><span class="line">Timeout: No Notify</span><br><span class="line">23</span><br><span class="line">Timeout: No Notify</span><br><span class="line">24</span><br><span class="line">Timeout: No Notify</span><br><span class="line">25</span><br><span class="line">Timeout: No Notify</span><br><span class="line">26</span><br><span class="line">Timeout: No Notify</span><br><span class="line">27</span><br><span class="line">Timeout: No Notify</span><br><span class="line">28</span><br><span class="line">Timeout: No Notify</span><br><span class="line">29</span><br><span class="line">Timeout: No Notify</span><br><span class="line">30</span><br><span class="line">Timeout: No Notify</span><br><span class="line">31</span><br><span class="line">Timeout: No Notify</span><br><span class="line">32</span><br><span class="line">Timeout: No Notify</span><br><span class="line">33</span><br><span class="line">Timeout: No Notify</span><br><span class="line">34</span><br><span class="line">Timeout: No Notify</span><br><span class="line">35</span><br><span class="line">Timeout: No Notify</span><br><span class="line">36</span><br><span class="line">Timeout: No Notify</span><br><span class="line">37</span><br><span class="line">Timeout: No Notify</span><br><span class="line">38</span><br><span class="line">Timeout: No Notify</span><br><span class="line">39</span><br><span class="line">Timeout: No Notify</span><br><span class="line">40</span><br><span class="line">Timeout: No Notify</span><br><span class="line">41</span><br><span class="line">Timeout: No Notify</span><br><span class="line">42</span><br><span class="line">Timeout: No Notify</span><br><span class="line">43</span><br><span class="line">Timeout: No Notify</span><br><span class="line">44</span><br><span class="line">Timeout: No Notify</span><br><span class="line">45</span><br><span class="line">Timeout: No Notify</span><br><span class="line">46</span><br><span class="line">Timeout: No Notify</span><br><span class="line">47</span><br><span class="line">Timeout: No Notify</span><br><span class="line">48</span><br><span class="line">Got the Notify to Out!</span><br></pre></td></tr></table></div></figure>

        <h3 id="问题"   >
          <a href="#问题" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#问题"></a> 问题</h3>
      
<p>上面那个程序，经过VS编译运行在Windows11时，很有可能会出现这种情况：<br />
（为了让问题更加明显，主线程部分代码改为以下：加长了第二段睡眠时间，并且在睡眠前后加输出提示）</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">1</span>s);</span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;After Sleep 1s...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    std::unique_lock lck&#123; mx &#125;;</span><br><span class="line">    cv.<span class="built_in">notify_one</span>();</span><br><span class="line">    lck.<span class="built_in">unlock</span>();</span><br><span class="line">    </span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;Before Sleep 8s...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">8</span>s);</span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;After Sleep 8s...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::unique_lock lck2&#123; mx2 &#125;;</span><br><span class="line">    cv<span class="number">2.</span><span class="built_in">notify_one</span>();</span><br><span class="line">    lck<span class="number">2.</span><span class="built_in">unlock</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>主线程明明8秒后才会notify_one，但是某时的输出结果下，居然很快就让子线程停止了，这是怎么回事？<br />
观察输出信息，发现，主线程还没输出<code>After Sleep 8s...</code>，子线程就被通知了，证明notify肯定不是主线程发出的。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">After Sleep 1s...</span><br><span class="line">Before Sleep 8s...</span><br><span class="line">Got the Notify to Start!</span><br><span class="line">0</span><br><span class="line">Timeout: No Notify</span><br><span class="line">1</span><br><span class="line">Timeout: No Notify</span><br><span class="line">2</span><br><span class="line">Timeout: No Notify</span><br><span class="line">3</span><br><span class="line">Timeout: No Notify</span><br><span class="line">4</span><br><span class="line">Timeout: No Notify</span><br><span class="line">5</span><br><span class="line">Got the Notify to Out!</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

        <h3 id="假唤醒"   >
          <a href="#假唤醒" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#假唤醒"></a> 假唤醒</h3>
      
<p>在<code>cv2.wait_for</code>的等待过程中，线程可能会因为假唤醒而提前被唤醒，而不是因为条件变量被通知。</p>
<p>假唤醒可以看作是操作系统故意替程序员<code>notify_one</code>，会让子线程会认为<code>wait_for</code>已经被唤醒，从而退出循环。</p>
<blockquote>
<p>普通的<code>wait</code>在Windows下不会假唤醒。而在Unix、Linux、Solaris、AIX中行为可能会不同。</p>
</blockquote>
<p>在当前的代码中，当<code>wait_for</code>返回时，仅通过检查<code>timeout</code>与否来决定是否退出循环。如果是因为假唤醒而返回，<code>status == std::cv_status::no_timeout</code>可能依然为真，这会导致线程提前结束。</p>
<p>为了防止假唤醒带来的问题，通常的做法是在等待后检查共享条件变量状态是否满足。你可以通过在<code>wait_for</code>之后再检查一个bool标志（例如<code>stop_requested</code>）来决定是否退出循环。<br />
在全局区定义它，初值为false，并且在<code>cv2.notify_one</code>语句之前置为true。这样，不仅要通过判断是否timeout，还要判断bool标志，以确信是我们自己发出的唤醒。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line">std::mutex mx, mx2;</span><br><span class="line">std::condition_variable cv, cv2;</span><br><span class="line"><span class="type">bool</span> stop_requested = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::jthread <span class="title">t1</span><span class="params">([]() -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            std::unique_lock lck&#123; mx &#125;;</span></span></span><br><span class="line"><span class="params"><span class="function">            cv.wait(lck);</span></span></span><br><span class="line"><span class="params"><span class="function">            std::cout &lt;&lt; <span class="string">&quot;Got the Notify to Start!&quot;</span> &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">1000</span>; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">            &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                std::unique_lock lck2&#123; mx2 &#125;;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">if</span> (<span class="keyword">auto</span> status = cv<span class="number">2.</span>wait_for(lck2, <span class="number">50</span>ms);</span></span></span><br><span class="line"><span class="params"><span class="function">                    status == std::cv_status::no_timeout &amp;&amp; stop_requested == <span class="literal">true</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    std::cout &lt;&lt; <span class="string">&quot;Got the Notify to Out!&quot;</span> &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">else</span></span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    std::cout &lt;&lt; <span class="string">&quot;Timeout: No Notify&quot;</span> &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;)</span></span>;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">1</span>s);</span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;After Sleep 1s...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    std::unique_lock lck&#123; mx &#125;;</span><br><span class="line">    cv.<span class="built_in">notify_one</span>();</span><br><span class="line">    lck.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;Before Sleep 8s...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">8</span>s);</span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;After Sleep 8s...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    std::unique_lock lck2&#123; mx2 &#125;;</span><br><span class="line">    stop_requested = <span class="literal">true</span>;</span><br><span class="line">    cv<span class="number">2.</span><span class="built_in">notify_one</span>();</span><br><span class="line">    lck<span class="number">2.</span><span class="built_in">unlock</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>输出</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line">After Sleep 1s...</span><br><span class="line">Before Sleep 8s...</span><br><span class="line">Got the Notify to Start!</span><br><span class="line">0</span><br><span class="line">Timeout: No Notify</span><br><span class="line">1</span><br><span class="line">Timeout: No Notify</span><br><span class="line">2</span><br><span class="line">Timeout: No Notify</span><br><span class="line">3</span><br><span class="line">Timeout: No Notify</span><br><span class="line">4</span><br><span class="line">Timeout: No Notify</span><br><span class="line">5</span><br><span class="line">Timeout: No Notify</span><br><span class="line">6</span><br><span class="line">Timeout: No Notify</span><br><span class="line">7</span><br><span class="line">Timeout: No Notify</span><br><span class="line">8</span><br><span class="line">Timeout: No Notify</span><br><span class="line">9</span><br><span class="line">Timeout: No Notify</span><br><span class="line">10</span><br><span class="line">Timeout: No Notify</span><br><span class="line">11</span><br><span class="line">Timeout: No Notify</span><br><span class="line">12</span><br><span class="line">Timeout: No Notify</span><br><span class="line">13</span><br><span class="line">Timeout: No Notify</span><br><span class="line">14</span><br><span class="line">Timeout: No Notify</span><br><span class="line">15</span><br><span class="line">Timeout: No Notify</span><br><span class="line">16</span><br><span class="line">Timeout: No Notify</span><br><span class="line">17</span><br><span class="line">Timeout: No Notify</span><br><span class="line">18</span><br><span class="line">Timeout: No Notify</span><br><span class="line">19</span><br><span class="line">Timeout: No Notify</span><br><span class="line">20</span><br><span class="line">Timeout: No Notify</span><br><span class="line">21</span><br><span class="line">Timeout: No Notify</span><br><span class="line">22</span><br><span class="line">Timeout: No Notify</span><br><span class="line">23</span><br><span class="line">Timeout: No Notify</span><br><span class="line">24</span><br><span class="line">Timeout: No Notify</span><br><span class="line">25</span><br><span class="line">Timeout: No Notify</span><br><span class="line">26</span><br><span class="line">Timeout: No Notify</span><br><span class="line">27</span><br><span class="line">Timeout: No Notify</span><br><span class="line">28</span><br><span class="line">Timeout: No Notify</span><br><span class="line">29</span><br><span class="line">Timeout: No Notify</span><br><span class="line">30</span><br><span class="line">Timeout: No Notify</span><br><span class="line">31</span><br><span class="line">Timeout: No Notify</span><br><span class="line">32</span><br><span class="line">Timeout: No Notify</span><br><span class="line">33</span><br><span class="line">Timeout: No Notify</span><br><span class="line">34</span><br><span class="line">Timeout: No Notify</span><br><span class="line">35</span><br><span class="line">Timeout: No Notify</span><br><span class="line">36</span><br><span class="line">Timeout: No Notify</span><br><span class="line">37</span><br><span class="line">Timeout: No Notify</span><br><span class="line">38</span><br><span class="line">Timeout: No Notify</span><br><span class="line">39</span><br><span class="line">Timeout: No Notify</span><br><span class="line">40</span><br><span class="line">Timeout: No Notify</span><br><span class="line">41</span><br><span class="line">Timeout: No Notify</span><br><span class="line">42</span><br><span class="line">Timeout: No Notify</span><br><span class="line">43</span><br><span class="line">Timeout: No Notify</span><br><span class="line">44</span><br><span class="line">Timeout: No Notify</span><br><span class="line">45</span><br><span class="line">Timeout: No Notify</span><br><span class="line">46</span><br><span class="line">Timeout: No Notify</span><br><span class="line">47</span><br><span class="line">Timeout: No Notify</span><br><span class="line">48</span><br><span class="line">Timeout: No Notify</span><br><span class="line">49</span><br><span class="line">Timeout: No Notify</span><br><span class="line">50</span><br><span class="line">Timeout: No Notify</span><br><span class="line">51</span><br><span class="line">Timeout: No Notify</span><br><span class="line">52</span><br><span class="line">Timeout: No Notify</span><br><span class="line">53</span><br><span class="line">Timeout: No Notify</span><br><span class="line">54</span><br><span class="line">Timeout: No Notify</span><br><span class="line">55</span><br><span class="line">Timeout: No Notify</span><br><span class="line">56</span><br><span class="line">Timeout: No Notify</span><br><span class="line">57</span><br><span class="line">Timeout: No Notify</span><br><span class="line">58</span><br><span class="line">Timeout: No Notify</span><br><span class="line">59</span><br><span class="line">Timeout: No Notify</span><br><span class="line">60</span><br><span class="line">Timeout: No Notify</span><br><span class="line">61</span><br><span class="line">Timeout: No Notify</span><br><span class="line">62</span><br><span class="line">Timeout: No Notify</span><br><span class="line">63</span><br><span class="line">Timeout: No Notify</span><br><span class="line">64</span><br><span class="line">Timeout: No Notify</span><br><span class="line">65</span><br><span class="line">Timeout: No Notify</span><br><span class="line">66</span><br><span class="line">Timeout: No Notify</span><br><span class="line">67</span><br><span class="line">Timeout: No Notify</span><br><span class="line">68</span><br><span class="line">Timeout: No Notify</span><br><span class="line">69</span><br><span class="line">Timeout: No Notify</span><br><span class="line">70</span><br><span class="line">Timeout: No Notify</span><br><span class="line">71</span><br><span class="line">Timeout: No Notify</span><br><span class="line">72</span><br><span class="line">Timeout: No Notify</span><br><span class="line">73</span><br><span class="line">Timeout: No Notify</span><br><span class="line">74</span><br><span class="line">Timeout: No Notify</span><br><span class="line">75</span><br><span class="line">Timeout: No Notify</span><br><span class="line">76</span><br><span class="line">Timeout: No Notify</span><br><span class="line">77</span><br><span class="line">Timeout: No Notify</span><br><span class="line">78</span><br><span class="line">Timeout: No Notify</span><br><span class="line">79</span><br><span class="line">Timeout: No Notify</span><br><span class="line">80</span><br><span class="line">Timeout: No Notify</span><br><span class="line">81</span><br><span class="line">Timeout: No Notify</span><br><span class="line">82</span><br><span class="line">Timeout: No Notify</span><br><span class="line">83</span><br><span class="line">Timeout: No Notify</span><br><span class="line">84</span><br><span class="line">Timeout: No Notify</span><br><span class="line">85</span><br><span class="line">Timeout: No Notify</span><br><span class="line">86</span><br><span class="line">Timeout: No Notify</span><br><span class="line">87</span><br><span class="line">Timeout: No Notify</span><br><span class="line">88</span><br><span class="line">Timeout: No Notify</span><br><span class="line">89</span><br><span class="line">Timeout: No Notify</span><br><span class="line">90</span><br><span class="line">Timeout: No Notify</span><br><span class="line">91</span><br><span class="line">Timeout: No Notify</span><br><span class="line">92</span><br><span class="line">Timeout: No Notify</span><br><span class="line">93</span><br><span class="line">Timeout: No Notify</span><br><span class="line">94</span><br><span class="line">Timeout: No Notify</span><br><span class="line">95</span><br><span class="line">Timeout: No Notify</span><br><span class="line">96</span><br><span class="line">Timeout: No Notify</span><br><span class="line">97</span><br><span class="line">Timeout: No Notify</span><br><span class="line">98</span><br><span class="line">Timeout: No Notify</span><br><span class="line">99</span><br><span class="line">Timeout: No Notify</span><br><span class="line">100</span><br><span class="line">Timeout: No Notify</span><br><span class="line">101</span><br><span class="line">Timeout: No Notify</span><br><span class="line">102</span><br><span class="line">Timeout: No Notify</span><br><span class="line">103</span><br><span class="line">Timeout: No Notify</span><br><span class="line">104</span><br><span class="line">Timeout: No Notify</span><br><span class="line">105</span><br><span class="line">Timeout: No Notify</span><br><span class="line">106</span><br><span class="line">Timeout: No Notify</span><br><span class="line">107</span><br><span class="line">Timeout: No Notify</span><br><span class="line">108</span><br><span class="line">Timeout: No Notify</span><br><span class="line">109</span><br><span class="line">Timeout: No Notify</span><br><span class="line">110</span><br><span class="line">Timeout: No Notify</span><br><span class="line">111</span><br><span class="line">Timeout: No Notify</span><br><span class="line">112</span><br><span class="line">Timeout: No Notify</span><br><span class="line">113</span><br><span class="line">Timeout: No Notify</span><br><span class="line">114</span><br><span class="line">Timeout: No Notify</span><br><span class="line">115</span><br><span class="line">Timeout: No Notify</span><br><span class="line">116</span><br><span class="line">Timeout: No Notify</span><br><span class="line">117</span><br><span class="line">Timeout: No Notify</span><br><span class="line">118</span><br><span class="line">Timeout: No Notify</span><br><span class="line">119</span><br><span class="line">Timeout: No Notify</span><br><span class="line">120</span><br><span class="line">Timeout: No Notify</span><br><span class="line">121</span><br><span class="line">Timeout: No Notify</span><br><span class="line">122</span><br><span class="line">Timeout: No Notify</span><br><span class="line">123</span><br><span class="line">Timeout: No Notify</span><br><span class="line">124</span><br><span class="line">Timeout: No Notify</span><br><span class="line">125</span><br><span class="line">Timeout: No Notify</span><br><span class="line">126</span><br><span class="line">Timeout: No Notify</span><br><span class="line">127</span><br><span class="line">Timeout: No Notify</span><br><span class="line">128</span><br><span class="line">Timeout: No Notify</span><br><span class="line">129</span><br><span class="line">After Sleep 8s...</span><br><span class="line">Got the Notify to Out!</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

        <h2 id="wait_until"   >
          <a href="#wait_until" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#wait_until"></a> wait_until</h2>
      
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Clock</span>, <span class="keyword">class</span> <span class="title class_">Duration</span>&gt;</span><br><span class="line"><span class="function">cv_status <span class="title">wait_until</span> <span class="params">(unique_lock&lt;mutex&gt;&amp; lck, <span class="type">const</span> chrono::time_point&lt;Clock,Duration&gt;&amp; abs_time)</span></span>;</span><br></pre></td></tr></table></div></figure>
<p>和<code>wait_for</code>行为一样，不同点在于：</p>
<ol>
<li><code>wait_for</code>的时间是时间段、间隔。</li>
<li><code>wait_until</code>的时间是时间点。</li>
</ol>

        <h1 id="future"   >
          <a href="#future" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#future"></a> future</h1>
      
<p>在标头 <code>&lt;future&gt;</code> 中定义</p>
<p>顾名思义，future就是为了用于获取返回值的。内部包装了一个任务或函数。</p>
<p>future是给期待方使用来get获取值的。<br />
promise是给承诺方使用来set设置值的。</p>
<p>以下程序表示：子线程期待一个值，此值由主线程提供。通过给子线程传入future实现。<br />
主线程定义一个promise，生成一个该promise的future传给t子线程函数。<br />
子线程调用<code>fut.get()</code>阻塞式等待主线程对fut相应的promise发送信息。<br />
一旦主线程向promise发送信息，子线程就会被通知，随后返回得到val。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::promise&lt;<span class="type">int</span>&gt; prom;</span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; fut = prom.<span class="built_in">get_future</span>();</span><br><span class="line">    <span class="function">std::jthread <span class="title">t</span><span class="params">([](std::future&lt;<span class="type">int</span>&gt; fut) -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            std::wcout &lt;&lt; <span class="string">L&quot;Start &amp; Wait...&quot;</span> &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">int</span> val = fut.get();</span></span></span><br><span class="line"><span class="params"><span class="function">            std::wcout &lt;&lt; <span class="string">L&quot;Got a value: &quot;</span> &lt;&lt; val &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;, std::move(fut))</span></span>;</span><br><span class="line">        </span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">5</span>s);</span><br><span class="line">    prom.<span class="built_in">set_value</span>(<span class="number">50</span>);</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">1</span>s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>输出：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Start &amp; Wait...</span><br><span class="line">Got a value: 50</span><br></pre></td></tr></table></div></figure>

        <h2 id="shared_future"   >
          <a href="#shared_future" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#shared_future"></a> shared_future</h2>
      
<p>用<code>shared_future</code>可以让多个线程同时监听一个共享的future。<br />
调用<code>fut.share()</code>即可获得<code>shared_future</code>类型的future，可以传入到线程函数中使用。</p>
<p>不要多次调用<code>fut.share()</code>，否则之前的<code>shared_future</code>会失效。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::promise&lt;<span class="type">int</span>&gt; prom;</span><br><span class="line">    <span class="keyword">auto</span> fut = prom.<span class="built_in">get_future</span>();</span><br><span class="line">    <span class="keyword">auto</span> shared_fut = fut.<span class="built_in">share</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">std::jthread <span class="title">t1</span><span class="params">([](std::shared_future&lt;<span class="type">int</span>&gt; shared_fut) -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            std::wcout &lt;&lt; <span class="string">L&quot;t1 Start &amp; Wait...&quot;</span> &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">auto</span> val = shared_fut.get();</span></span></span><br><span class="line"><span class="params"><span class="function">            std::wcout &lt;&lt; <span class="string">L&quot;t1 Got a value: &quot;</span> &lt;&lt; val &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;, shared_fut)</span></span>;</span><br><span class="line">    <span class="function">std::jthread <span class="title">t2</span><span class="params">([](std::shared_future&lt;<span class="type">int</span>&gt; shared_fut) -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            std::wcout &lt;&lt; <span class="string">L&quot;t2 Start &amp; Wait...&quot;</span> &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">auto</span> val = shared_fut.get();</span></span></span><br><span class="line"><span class="params"><span class="function">            std::wcout &lt;&lt; <span class="string">L&quot;t2 Got a value: &quot;</span> &lt;&lt; val &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;, shared_fut)</span></span>;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">5</span>s);</span><br><span class="line">    prom.<span class="built_in">set_value</span>(<span class="number">50</span>);</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">1</span>s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>输出：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">t2 Start &amp; Wait...</span><br><span class="line">t1 Start &amp; Wait...</span><br><span class="line">t2 Got a value: 50</span><br><span class="line">t1 Got a value: 50</span><br></pre></td></tr></table></div></figure>

        <h2 id="packaged_task"   >
          <a href="#packaged_task" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#packaged_task"></a> packaged_task</h2>
      
<p>用于从子线程获得输出值。</p>
<p>与promise一样，packaged_task 是承诺方，是给出值的。可以调用get_future获得其对应的future。期待方可以通过此future获取其返回值。</p>
<p>创建子线程时，传入定义好的 packaged_task，需要<code>std::move</code>移动。</p>
<p>以下程序表示：主线程期待一个值，此值由子线程提供。通过给子线程传入 packaged_task 实现。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::packaged_task&lt;<span class="built_in">int</span>(<span class="type">int</span>)&gt; pkg&#123; [](<span class="type">int</span> v) -&gt; <span class="type">int</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> i = v; i &gt;= <span class="number">0</span>; --i)</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">                std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">200</span>ms);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> fut = pkg.<span class="built_in">get_future</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="function">std::jthread <span class="title">t</span><span class="params">(std::move(pkg), <span class="number">50</span>)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> v = fut.<span class="built_in">get</span>();          <span class="comment">// block</span></span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;main thread got a value: &quot;</span> &lt;&lt; v &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="async"   >
          <a href="#async" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#async"></a> async</h2>
      
<p>相当于包装好的<code>thread(packaged_task, ...)</code>。可以直接返回一个future。并且定义后相当于直接创建了子线程。</p>
<ol>
<li>参数1：Launch Policy
<ol>
<li>有两个选项：<code>std::launch::deferred</code>、<code>std::launch::async</code>。</li>
<li>默认是<code>std::launch::async</code>，意为立即执行。</li>
<li><code>std::launch::deferred</code>意为在他人<code>fut.get()</code>时才执行。</li>
</ol>
</li>
<li>参数2：fn</li>
<li>参数3：函数参数</li>
</ol>
<p>以下程序表示：主线程期待一个值，此值由子线程提供。通过async创建子线程实现。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> fut = std::<span class="built_in">async</span>([](<span class="type">int</span> v) -&gt; <span class="type">int</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> i = v; i &gt; <span class="number">0</span>; --i)</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">                std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">200</span>ms);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;, <span class="number">50</span>);</span><br><span class="line">    <span class="type">int</span> v = fut.<span class="built_in">get</span>();</span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;main thread got a value: &quot;</span> &lt;&lt; v &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>以上是async的简单应用。</p>

        <h3 id="异步特性async"   >
          <a href="#异步特性async" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#异步特性async"></a> 异步特性（async）</h3>
      
<p>还有一些特性：所谓异步，就是主线程、async动作互不干扰。比如：<br />
async启动后，主线程打印内容至屏幕、Sleep等等，不会出现和子线程输出的错乱（除了换行以外）。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> fut = std::<span class="built_in">async</span>([](<span class="type">int</span> v) -&gt; <span class="type">int</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> i = v; i &gt; <span class="number">0</span>; --i)</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">                std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">200</span>ms);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;, <span class="number">50</span>);</span><br><span class="line">    </span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;main thread begin to Sleep...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">5</span>s);</span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;main thread Wake up&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">int</span> v = fut.<span class="built_in">get</span>();</span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;main thread got a value: &quot;</span> &lt;&lt; v &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>输出：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">main thread begin to Sleep...50</span><br><span class="line"></span><br><span class="line">49</span><br><span class="line">48</span><br><span class="line">47</span><br><span class="line">46</span><br><span class="line">45</span><br><span class="line">44</span><br><span class="line">43</span><br><span class="line">42</span><br><span class="line">41</span><br><span class="line">40</span><br><span class="line">39</span><br><span class="line">38</span><br><span class="line">37</span><br><span class="line">36</span><br><span class="line">35</span><br><span class="line">34</span><br><span class="line">33</span><br><span class="line">32</span><br><span class="line">31</span><br><span class="line">30</span><br><span class="line">29</span><br><span class="line">28</span><br><span class="line">27</span><br><span class="line">26</span><br><span class="line">main thread Wake up</span><br><span class="line">25</span><br><span class="line">24</span><br><span class="line">23</span><br><span class="line">22</span><br><span class="line">21</span><br><span class="line">20</span><br><span class="line">19</span><br><span class="line">18</span><br><span class="line">17</span><br><span class="line">16</span><br><span class="line">15</span><br><span class="line">14</span><br><span class="line">13</span><br><span class="line">12</span><br><span class="line">11</span><br><span class="line">10</span><br><span class="line">9</span><br><span class="line">8</span><br><span class="line">7</span><br><span class="line">6</span><br><span class="line">5</span><br><span class="line">4</span><br><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br><span class="line">main thread got a value: 3</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

        <h3 id="deferred特性"   >
          <a href="#deferred特性" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#deferred特性"></a> deferred特性</h3>
      
<p>至于<code>std::launch::deferred</code>。经过测试：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> fut = std::<span class="built_in">async</span>(std::launch::deferred,</span><br><span class="line">        [](<span class="type">int</span> v) -&gt; <span class="type">int</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> i = v; i &gt; <span class="number">0</span>; --i)</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">                std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">200</span>ms);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;, <span class="number">50</span>);</span><br><span class="line">    </span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;main thread begin to Sleep...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">5</span>s);</span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;main thread Wake up&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">int</span> v = fut.<span class="built_in">get</span>();</span><br><span class="line">    std::wcout &lt;&lt; <span class="string">L&quot;main thread got a value: &quot;</span> &lt;&lt; v &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>发现，输出：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">main thread begin to Sleep...</span><br><span class="line">main thread Wake up</span><br><span class="line">50</span><br><span class="line">49</span><br><span class="line">48</span><br><span class="line">47</span><br><span class="line">46</span><br><span class="line">45</span><br><span class="line">44</span><br><span class="line">43</span><br><span class="line">42</span><br><span class="line">41</span><br><span class="line">40</span><br><span class="line">39</span><br><span class="line">38</span><br><span class="line">37</span><br><span class="line">36</span><br><span class="line">35</span><br><span class="line">34</span><br><span class="line">33</span><br><span class="line">32</span><br><span class="line">31</span><br><span class="line">30</span><br><span class="line">29</span><br><span class="line">28</span><br><span class="line">27</span><br><span class="line">26</span><br><span class="line">25</span><br><span class="line">24</span><br><span class="line">23</span><br><span class="line">22</span><br><span class="line">21</span><br><span class="line">20</span><br><span class="line">19</span><br><span class="line">18</span><br><span class="line">17</span><br><span class="line">16</span><br><span class="line">15</span><br><span class="line">14</span><br><span class="line">13</span><br><span class="line">12</span><br><span class="line">11</span><br><span class="line">10</span><br><span class="line">9</span><br><span class="line">8</span><br><span class="line">7</span><br><span class="line">6</span><br><span class="line">5</span><br><span class="line">4</span><br><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br><span class="line">main thread got a value: 3</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<p>意味着，该启动策略表示等待主线程先执行一部分内容，直到主线程开始<code>fut.get()</code>时，async再启动。</p>

        <h1 id="信号量"   >
          <a href="#信号量" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#信号量"></a> 信号量</h1>
      
<p><code>C++20</code>开始。定义于<code>&lt;semaphore&gt;</code><br />
根据cppreference，信号量是一种轻量级同步原语，用于限制对共享资源的并发访问。信号量相比条件变量更高效，因为条件变量用到了mutex。<br />
分两种：</p>
<ol>
<li><code>counting_semaphore</code>，非负值。</li>
<li><code>binary_semaphore</code>，二值。</li>
</ol>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;std::<span class="type">ptrdiff_t</span> = <span class="comment">/* implementation-defined */</span>&gt;</span><br><span class="line"><span class="keyword">class</span> counting_semaphore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> binary_semaphore = std::counting_semaphore&lt;<span class="number">1</span>&gt;;</span><br></pre></td></tr></table></div></figure>

        <h2 id="示例改写windows信号量api"   >
          <a href="#示例改写windows信号量api" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#示例改写windows信号量api"></a> 示例：改写Windows信号量API</h2>
      
<p>用<code>C++</code>线程库信号量改写——《Windows_多线程》中<a href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%A4%9A%E4%B8%AA%E8%BF%9B%E5%BA%A6%E6%9D%A1%E5%90%8C%E6%97%B6%E5%8A%A8%E7%94%BB">示例：多个进度条同时动画</a><br />
比如：<code>std::counting_semaphore&lt;5&gt; semaphore(3);</code>代表最大值为5，初始值为3。如果最大值不填，则默认给一个超大的数。<br />
以下例子：<code>std::counting_semaphore&lt;2&gt; semaphore(2);</code>代表最大值为2，初始值为2。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore&gt;</span></span></span><br><span class="line"><span class="function">std::counting_semaphore&lt;2&gt; <span class="title">semaphore</span><span class="params">(<span class="number">2</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">std::jthread <span class="title">t</span><span class="params">([]() -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">            &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                std::unique_lock lck&#123; start_mx &#125;;</span></span></span><br><span class="line"><span class="params"><span class="function">                start_cv.wait(lck);</span></span></span><br><span class="line"><span class="params"><span class="function">                lck.unlock();</span></span></span><br><span class="line"><span class="params"><span class="function">                semaphore.acquire();</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="comment">// ...</span></span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                semaphore.release();</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="二值信号量当作条件变量使用"   >
          <a href="#二值信号量当作条件变量使用" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#二值信号量当作条件变量使用"></a> 二值信号量当作条件变量使用</h2>
      
<p>其实就是：<code>using binary_semaphore = std::counting_semaphore&lt;1&gt;;</code></p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">std::binary_semaphore bin_sema&#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> <span class="comment">/* ... */</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">std::jthread <span class="title">t</span><span class="params">([]() -&gt; <span class="type">void</span></span></span></span><br><span class="line"><span class="params"><span class="function">            &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                bin_sema.acquire();</span></span></span><br><span class="line"><span class="params"><span class="function">                bin_sema.release(<span class="number">1</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                </span></span></span><br><span class="line"><span class="params"><span class="function">                semaphore.acquire();</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i)</span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="comment">// ...</span></span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                semaphore.release();</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> WM_KETDOWN:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (wParam == <span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            bin_sema.<span class="built_in">release</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h1 id="闩锁latch-屏障barrier"   >
          <a href="#闩锁latch-屏障barrier" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#闩锁latch-屏障barrier"></a> 闩锁（Latch）、屏障（Barrier）</h1>
      
<p>闩锁和屏障是线程协调机制，允许任意数量的线程阻塞，直到预期数量的线程到达。闩锁不能重复使用，而屏障可以重复使用。</p>
<p>主要用于等待n个线程到位，之后做一些事情。<br />
屏障（Barrier）使用之后可以reset重新使用。</p>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/page/105/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/105/">105</a><span class="page-number current">106</span><a class="page-number" href="/page/107/">107</a><span class="space">&hellip;</span><a class="page-number" href="/page/150/">150</a><a class="extend next" rel="next" href="/page/107/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/touxiang.png" alt="avatar"></div><p class="sidebar-ov-author__text">无论哪里，生活继续。</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/xing-cg" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://gitee.com/mrcan" target="_blank" rel="noopener" data-popover="social.gitee" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">Gitee</span></a><a class="sidebar-ov-social-item" href="https://www.zhihu.com/people/mrcan666" target="_blank" rel="noopener" data-popover="知乎" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-zhihu"></i></span></a><a class="sidebar-ov-social-item" href="tencent://message?uin=1933966629" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="mailto:xing-cg@qq.com" target="_blank" rel="noopener" data-popover="social.QQmail" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="far fa-envelope"></i></span></a><a class="sidebar-ov-social-item" href="https://blog.csdn.net/mrcan666" target="_blank" rel="noopener" data-popover="csdn" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">CSDN</span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">299</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">56</div><div class="sidebar-ov-state-item__name">分类</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2025</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Mr.Can All Rights Reserved</span><span class="footer__devider">|</span><span><a href="http://beian.miit.gov.cn/" target="_blank">京ICP备2025135168号</a></span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v7.3.0</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/npm/leancloud-storage@latest/dist/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><script>function loadValine () {
  var GUEST_INFO = ['nick', 'mail', 'link'];
  var guest_info = 'nick,mail,link';

  guest_info = guest_info.split(',').filter(function(item) {
    return GUEST_INFO.indexOf(item) > -1;
  });
  new Valine({
    el: '#valine-container',
    appId: 'QTXELGPwB2iKLovJroJUqbVP-gzGzoHsz',
    appKey: 'DDfRbL0aLE3KEHXtbNXHrlEQ',
    notify: true,
    verify: true,
    placeholder: '欢迎写下你的评论，同时欢迎留下你的昵称和邮箱！',
    avatar: 'mp',
    meta: guest_info,
    pageSize: '10' || 10,
    visitor: true,
    recordIP: true,
    lang: 'zh-cn' || 'zh-cn',
    path: window.location.pathname
  });
}

if (false) {
  loadValine();
} else {
  window.addEventListener('DOMContentLoaded', loadValine, false);
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>